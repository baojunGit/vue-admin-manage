"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_xeUtils=_interopRequireDefault(require("xe-utils")),_vXETable=require("../../v-x-e-table"),_utils=require("../../tools/utils"),_dom=require("../../tools/dom"),_log=require("../../tools/log"),_util=require("../../table/src/util");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}class Rule{constructor(e){Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.max,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}get content(){return(0,_utils.getFuncText)(this.$options.content||this.$options.message)}get message(){return this.content}}const tableValidatorMethodKeys=["fullValidate","validate","clearValidate"],validatorHook={setupTable(p){const{props:f,reactData:m,internalData:_}=p,g=p.getRefMaps()["refValidTooltip"],{computeValidOpts:x,computeTreeOpts:h,computeEditOpts:u}=p.getComputeMaps();let w={},E={},R;const l=(e,u,a)=>{const d={},{editRules:t,treeConfig:l}=f,{afterFullData:c,visibleColumn:g}=_;var r=h.value,r=r.children||r.childrenField;const v=x.value;let i;!0===e?i=c:e&&(_xeUtils.default.isFunction(e)?u=e:i=_xeUtils.default.isArray(e)?e:[e]),i=i||(p.getInsertRecords?p.getInsertRecords().concat(p.getUpdateRecords()):[]);const o=[],s=(_._lastCallTime=Date.now(),R=!1,w.clearValidate(),{});if(t){const n=p.getColumns();e=r=>{if(a||!R){const e=[];n.forEach(l=>{!a&&R||!_xeUtils.default.has(t,l.property)||e.push(E.validCellRules("all",r,l).catch(({rule:e,rules:t})=>{t={rule:e,rules:t,rowIndex:p.getRowIndex(r),row:r,columnIndex:p.getColumnIndex(l),column:l,field:l.property,$table:p};if(d[l.property]||(d[l.property]=[]),s[(0,_util.getRowid)(p,r)+":"+l.id]={column:l,row:r,rule:e,content:e.content},d[l.property].push(t),!a)return R=!0,Promise.reject(t)}))}),o.push(Promise.all(e))}};return l?_xeUtils.default.eachTree(i,e,{children:r}):i.forEach(e),Promise.all(o).then(()=>{const e=Object.keys(d);var t,l,r;return m.validErrorMaps=(t=s,"single"===x.value.msgMode?(l=t,(r=Object.keys(t)).length&&(l[r=r[0]]=t[r]),l):t),(0,_vue.nextTick)().then(()=>{if(e.length)return Promise.reject(d[e[0]][0]);u&&u()})}).catch(n=>new Promise((e,t)=>{const l=()=>{(0,_vue.nextTick)(()=>{u?(u(d),e()):("obsolete"===_conf.default.validToReject?t:e)(d)})};var r,a,i,o,s=()=>{var t;n.cell=p.getCell(n.row,n.column),(0,_dom.scrollToView)(n.cell),t=n,new Promise(e=>{!1===x.value.autoPos?(p.dispatchEvent("valid-error",t,null),e()):p.handleActived(t,{type:"valid-error",trigger:"call"}).then(()=>{e(E.showValidTooltip(t))})}).then(l)};!1===v.autoPos?l():(o=n.row,r=n.column,i=c.indexOf(o),a=g.indexOf(r),i=0<i?c[i-1]:o,o=0<a?g[a-1]:r,p.scrollToRow(i,o).then(s))}))}return m.validErrorMaps={},(0,_vue.nextTick)().then(()=>{u&&u()})},b=(w={fullValidate(e,t){return"development"===process.env.NODE_ENV&&_xeUtils.default.isFunction(t)&&(0,_log.warnLog)("vxe.error.notValidators",["fullValidate(rows, callback)","fullValidate(rows)"]),l(e,t,!0)},validate(e,t){return"development"===process.env.NODE_ENV&&_xeUtils.default.isFunction(t)&&(0,_log.warnLog)("vxe.error.notValidators",["validate(rows, callback)","validate(rows)"]),l(e,t)},clearValidate(e,t){var l=m["validErrorMaps"],r=g.value,a=x.value,e=_xeUtils.default.isArray(e)?e:e?[e]:[];const i=_xeUtils.default.isArray(t)?t:(t?[t]:[]).map(e=>(0,_util.handleFieldOrColumn)(p,e));let o={};if(r&&r.reactData.visible&&r.close(),"single"===a.msgMode)m.validErrorMaps={};else{if(e.length&&i.length)o=Object.assign({},l),e.forEach(t=>{i.forEach(e=>{e=(0,_util.getRowid)(p,t)+":"+e.id;o[e]&&delete o[e]})});else if(e.length){const s=e.map(e=>""+(0,_util.getRowid)(p,e));_xeUtils.default.each(l,(e,t)=>{-1<s.indexOf(t.split(":")[0])&&(o[t]=e)})}else if(i.length){const n=i.map(e=>""+e.id);_xeUtils.default.each(l,(e,t)=>{-1<n.indexOf(t.split(":")[1])&&(o[t]=e)})}m.validErrorMaps=o}return(0,_vue.nextTick)()}},(e,t)=>{var{type:e,min:l,max:r,pattern:a}=e,e="number"===e,i=e?_xeUtils.default.toNumber(t):_xeUtils.default.getSize(t);return!(!e||!isNaN(t))||!_xeUtils.default.eqNull(l)&&i<_xeUtils.default.toNumber(l)||!_xeUtils.default.eqNull(r)&&i>_xeUtils.default.toNumber(r)||!(!a||(_xeUtils.default.isRegExp(a)?a:new RegExp(a)).test(t))});return E={validCellRules(e,n,u,t){var l=f["editRules"],r=u["field"];const d=[],c=[];if(r&&l){const g=_xeUtils.default.get(l,r);if(g){const v=_xeUtils.default.isUndefined(t)?_xeUtils.default.get(n,r):t;g.forEach(t=>{const{type:l,trigger:r,required:a,validator:i}=t;if("all"===e||!r||e===r)if(i){var o={cellValue:v,rule:t,rules:g,row:n,rowIndex:p.getRowIndex(n),column:u,columnIndex:p.getColumnIndex(u),field:u.field,$table:p,$grid:p.xegrid};let e;_xeUtils.default.isString(i)?(s=_vXETable.VXETable.validators.get(i))?s.cellValidatorMethod?e=s.cellValidatorMethod(o):"development"===process.env.NODE_ENV&&(0,_log.warnLog)("vxe.error.notValidators",[i]):"development"===process.env.NODE_ENV&&(0,_log.errLog)("vxe.error.notValidators",[i]):e=i(o),e&&(_xeUtils.default.isError(e)?(R=!0,d.push(new Rule({type:"custom",trigger:r,content:e.message,rule:new Rule(t)}))):e.catch&&c.push(e.catch(e=>{R=!0,d.push(new Rule({type:"custom",trigger:r,content:e&&e.message?e.message:t.content||t.message,rule:new Rule(t)}))})))}else{var s="array"===l,o=_xeUtils.default.isArray(v);let e=!0;e=s||o?!o||!v.length:_xeUtils.default.isString(v)?(0,_utils.eqEmptyValue)(v.trim()):(0,_utils.eqEmptyValue)(v),(a?e||b(t,v):!e&&b(t,v))&&(R=!0,d.push(new Rule(t)))}})}}return Promise.all(c).then(()=>{var e;if(d.length)return e={rules:d,rule:d[0]},Promise.reject(e)})},hasCellRules(t,e,l){var r=f["editRules"],l=l["field"];return!(!l||!r)&&(r=_xeUtils.default.get(r,l))&&!!_xeUtils.default.find(r,e=>"all"===t||!e.trigger||t===e.trigger)},triggerValidate(t){var{editConfig:e,editRules:l}=f,r=m["editStore"],r=r["actived"];const a=u.value;var i=x.value;if(l&&"single"===i.msgMode&&(m.validErrorMaps={}),e&&l&&r.row){const{row:o,column:s,cell:n}=r.args;if(E.hasCellRules(t,o,s))return E.validCellRules(t,o,s).then(()=>{"row"===a.mode&&w.clearValidate(o,s)}).catch(({rule:e})=>{return e.trigger&&t!==e.trigger?Promise.resolve():(e={rule:e,row:o,column:s,cell:n},E.showValidTooltip(e),Promise.reject(e))})}return Promise.resolve()},showValidTooltip(e){var t=f["height"],{tableData:l,validStore:r,validErrorMaps:a}=m,{rule:i,row:o,column:s,cell:n}=e,u=x.value,d=g.value,c=i.content;return r.visible=!0,"single"===u.msgMode?m.validErrorMaps={[(0,_util.getRowid)(p,o)+":"+s.id]:{column:s,row:o,rule:i,content:c}}:m.validErrorMaps=Object.assign({},a,{[(0,_util.getRowid)(p,o)+":"+s.id]:{column:s,row:o,rule:i,content:c}}),p.dispatchEvent("valid-error",e,null),d&&("tooltip"===u.message||"default"===u.message&&!t&&l.length<2)?d.open(n,c):(0,_vue.nextTick)()}},Object.assign(Object.assign({},w),E)},setupGrid(e){return e.extendTableMethods(tableValidatorMethodKeys)}};var _default=exports.default=validatorHook;