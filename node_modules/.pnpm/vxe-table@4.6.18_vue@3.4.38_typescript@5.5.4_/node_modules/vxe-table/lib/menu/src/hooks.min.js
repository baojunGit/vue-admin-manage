"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_vXETable=require("../../v-x-e-table"),_dom=require("../../tools/dom"),_utils=require("../../tools/utils"),_event=require("../../tools/event");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const tableMenuMethodKeys=["closeMenu"],tableMenuHook={setupTable(b){const{xID:p,props:m,reactData:M,internalData:_}=b,{refElem:x,refTableFilter:E,refTableMenu:C}=b.getRefMaps(),{computeMouseOpts:T,computeIsMenu:u,computeMenuOpts:y}=b.getComputeMaps();let w,r={};const N=(t,e,l)=>{const c=M["ctxMenuStore"];var n=u.value,o=y.value,e=o[e];const i=o.visibleMethod;if(e){const{options:f,disabled:s}=e;s?t.preventDefault():n&&f&&f.length&&(l.options=f,b.preventEvent(t,"event.showMenu",l,()=>{if(!i||i(l)){t.preventDefault(),b.updateZindex();const{scrollTop:s,scrollLeft:u,visibleHeight:r,visibleWidth:a}=(0,_dom.getDomNode)();let o=t.clientY+s,i=t.clientX+u;const n=()=>{_._currMenuParams=l,Object.assign(c,{visible:!0,list:f,selected:null,selectChild:null,showChild:!1,style:{zIndex:_.tZindex,top:o+"px",left:i+"px"}}),(0,_vue.nextTick)(()=>{var e=C.value.getRefMaps().refElem.value,t=e.clientHeight,l=e.clientWidth,{boundingTop:e,boundingLeft:n}=(0,_dom.getAbsolutePos)(e),e=e+t-r,n=n+l-a;-10<e&&(c.style.top=Math.max(s+2,o-t-2)+"px"),-10<n&&(c.style.left=Math.max(u+2,i-l-2)+"px")})},{keyboard:e,row:d,column:v}=l;e&&d&&v?b.scrollToRow(d,v).then(()=>{var e,t,l=b.getCell(d,v);l&&({boundingTop:e,boundingLeft:t}=(0,_dom.getAbsolutePos)(l),o=e+s+Math.floor(l.offsetHeight/2),i=t+u+Math.floor(l.offsetWidth/2)),n()}):n()}else w.closeMenu()}))}b.closeFilter()};return w={closeMenu(){return Object.assign(M.ctxMenuStore,{visible:!1,selected:null,selectChild:null,showChild:!1}),(0,_vue.nextTick)()}},r={moveCtxMenu(e,t,l,n,o,i){let s;var u=_xeUtils.default.findIndexOf(i,e=>t[l]===e);if(n)o&&(0,_utils.hasChildrenList)(t.selected)?t.showChild=!0:(t.showChild=!1,t.selectChild=null);else if((0,_event.hasEventKey)(e,_event.EVENT_KEYS.ARROW_UP)){for(let e=u-1;0<=e;e--)if(!1!==i[e].visible){s=i[e];break}t[l]=s||i[i.length-1]}else if((0,_event.hasEventKey)(e,_event.EVENT_KEYS.ARROW_DOWN)){for(let e=u+1;e<i.length;e++)if(!1!==i[e].visible){s=i[e];break}t[l]=s||i[0]}else t[l]&&((0,_event.hasEventKey)(e,_event.EVENT_KEYS.ENTER)||(0,_event.hasEventKey)(e,_event.EVENT_KEYS.SPACEBAR))&&r.ctxMenuLinkEvent(e,t[l])},handleOpenMenuEvent:N,handleGlobalContextmenuEvent(t){var{mouseConfig:e,menuConfig:l}=m,{editStore:n,ctxMenuStore:o}=M,i=_["visibleColumn"],s=E.value,u=C.value,r=T.value,a=y.value,d=x.value,n=n["selected"],v=["header","body","footer"];if((0,_utils.isEnableConf)(l)){if(o.visible&&u&&(0,_dom.getEventTargetNode)(t,u.getRefMaps().refElem.value).flag)return void t.preventDefault();if(_._keyCtx){l="body",o={type:l,$table:b,keyboard:!0,columns:i.slice(0),$event:t};if(e&&r.area){u=b.getActiveCellArea();if(u&&u.row&&u.column)return o.row=u.row,o.column=u.column,void N(t,l,o)}else if(e&&r.selected&&n.row&&n.column)return o.row=n.row,o.column=n.column,void N(t,l,o)}for(let e=0;e<v.length;e++){var c=v[e],f=(0,_dom.getEventTargetNode)(t,d,`vxe-${c}--column`,e=>e.parentNode.parentNode.parentNode.getAttribute("xid")===p),h={type:c,$table:b,columns:i.slice(0),$event:t};if(f.flag){var f=f.targetElem,g=b.getColumnNode(f),g=g?g.item:null;let e=c+"-";g&&Object.assign(h,{column:g,columnIndex:b.getColumnIndex(g),cell:f}),"body"===c&&(f=(g=b.getRowNode(f.parentNode))?g.item:null,e="",f)&&(h.row=f,h.rowIndex=b.getRowIndex(f));g=e+"cell-menu";return N(t,c,h),void b.dispatchEvent(g,h,t)}if((0,_dom.getEventTargetNode)(t,d,`vxe-table--${c}-wrapper`,e=>e.getAttribute("xid")===p).flag)return void("cell"===a.trigger?t.preventDefault():N(t,c,h))}}s&&!(0,_dom.getEventTargetNode)(t,s.$el).flag&&b.closeFilter(),w.closeMenu()},ctxMenuMouseoverEvent(e,t,l){const a=e.currentTarget;var n=M["ctxMenuStore"];e.preventDefault(),e.stopPropagation(),n.selected=t,(n.selectChild=l)||(n.showChild=(0,_utils.hasChildrenList)(t),n.showChild&&(0,_vue.nextTick)(()=>{var o=a.nextElementSibling;if(o){var{boundingTop:i,boundingLeft:s,visibleHeight:u,visibleWidth:r}=(0,_dom.getAbsolutePos)(a),i=i+a.offsetHeight;let e="",t="",l=(s+a.offsetWidth+o.offsetWidth>r-10&&(e="auto",t=a.offsetWidth+"px"),""),n="";i+o.offsetHeight>u-10&&(l="auto",n="0"),o.style.left=e,o.style.right=t,o.style.top=l,o.style.bottom=n}}))},ctxMenuMouseoutEvent(e,t){var l=M["ctxMenuStore"];t.children||(l.selected=null),l.selectChild=null},ctxMenuLinkEvent(e,t){var l;t.disabled||!t.code&&t.children&&t.children.length||(l=_vXETable.VXETable.menus.get(t.code),t=Object.assign({},_._currMenuParams,{menu:t,$table:b,$grid:b.xegrid,$event:e}),(l=l?l.tableMenuMethod||l.menuMethod:null)&&l(t,e),b.dispatchEvent("menu-click",t,e),w.closeMenu())}},Object.assign(Object.assign({},w),r)},setupGrid(e){return e.extendTableMethods(tableMenuMethodKeys)}};var _default=exports.default=tableMenuHook;