"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=exports.allActiveDrawers=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_size=require("../../hooks/size"),_utils=require("../../tools/utils"),_event=require("../../tools/event"),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_button=_interopRequireDefault(require("../../button/src/button")),_index=_interopRequireDefault(require("../../loading/index")),_vn=require("../../tools/vn");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const allActiveDrawers=exports.allActiveDrawers=[];var _default=exports.default=(0,_vue.defineComponent)({name:"VxeDrawer",props:{modelValue:Boolean,id:String,title:String,loading:{type:Boolean,default:null},className:String,position:[String,Object],lockView:{type:Boolean,default:()=>_conf.default.drawer.lockView},lockScroll:Boolean,mask:{type:Boolean,default:()=>_conf.default.drawer.mask},maskClosable:{type:Boolean,default:()=>_conf.default.drawer.maskClosable},escClosable:{type:Boolean,default:()=>_conf.default.drawer.escClosable},showHeader:{type:Boolean,default:()=>_conf.default.drawer.showHeader},showFooter:{type:Boolean,default:()=>_conf.default.drawer.showFooter},showClose:{type:Boolean,default:()=>_conf.default.drawer.showClose},content:[Number,String],showCancelButton:{type:Boolean,default:null},cancelButtonText:{type:String,default:()=>_conf.default.drawer.cancelButtonText},showConfirmButton:{type:Boolean,default:()=>_conf.default.drawer.showConfirmButton},confirmButtonText:{type:String,default:()=>_conf.default.drawer.confirmButtonText},destroyOnClose:{type:Boolean,default:()=>_conf.default.drawer.destroyOnClose},showTitleOverflow:{type:Boolean,default:()=>_conf.default.drawer.showTitleOverflow},width:[Number,String],height:[Number,String],zIndex:Number,transfer:{type:Boolean,default:()=>_conf.default.drawer.transfer},size:{type:String,default:()=>_conf.default.drawer.size||_conf.default.size},beforeHideMethod:{type:Function,default:()=>_conf.default.drawer.beforeHideMethod},slots:Number},emits:["update:modelValue","show","hide","before-hide","close","confirm","cancel"],setup(d,e){const{slots:c,emit:a}=e;var t=_xeUtils.default.uniqueId();const v=(0,_size.useSize)(d),f=(0,_vue.ref)(),_=(0,_vue.ref)(),o=(0,_vue.ref)(),l=(0,_vue.ref)(),w=(0,_vue.reactive)({inited:!1,visible:!1,contentVisible:!1,drawerZIndex:0,firstOpen:!0}),r={refElem:f},n={},h={xID:t,props:d,context:e,reactData:w,getRefMaps:()=>r,getComputeMaps:()=>n},s=()=>{return _.value},i=()=>{var{width:e,height:t}=d,r=s();return r.style.width=""+(e?isNaN(e)?e:e+"px":""),r.style.height=""+(t?isNaN(t)?t:t+"px":""),(0,_vue.nextTick)()},u=()=>{var e=d["zIndex"],t=w["drawerZIndex"];e?w.drawerZIndex=e:t<(0,_utils.getLastZIndex)()&&(w.drawerZIndex=(0,_utils.nextZIndex)())},p=()=>(0,_vue.nextTick)().then(()=>{}),x=e=>{var t=d["beforeHideMethod"],r=w["visible"];const o={type:e};return r&&Promise.resolve(t?t(o):null).then(e=>{_xeUtils.default.isError(e)||(w.contentVisible=!1,_xeUtils.default.remove(allActiveDrawers,e=>e===h),k.dispatchEvent("before-hide",o),setTimeout(()=>{w.visible=!1,a("update:modelValue",!1),k.dispatchEvent("hide",o)},200))}).catch(e=>e),(0,_vue.nextTick)()},b=e=>{var t="close";k.dispatchEvent(t,{type:t},e),x(t)},m=e=>{var t="confirm";k.dispatchEvent(t,{type:t},e),x(t)},y=e=>{var t="cancel";k.dispatchEvent(t,{type:t},e),x(t)},g=()=>{const r=d["showFooter"];var{inited:e,visible:t}=w;return e||(w.inited=!0),t||(i(),w.visible=!0,w.contentVisible=!1,u(),allActiveDrawers.push(h),setTimeout(()=>{w.contentVisible=!0,(0,_vue.nextTick)(()=>{r&&(e=o.value,t=l.value,e=e||t)&&e.focus();var e,t={type:""};a("update:modelValue",!0),k.dispatchEvent("show",t)})},10),(0,_vue.nextTick)(()=>{var e=w["firstOpen"];e&&p().then(()=>{setTimeout(()=>p(),20)}),e&&(w.firstOpen=!1)})),(0,_vue.nextTick)()},k={dispatchEvent(e,t,r){a(e,Object.assign({$drawer:h,$event:r},t))},open:g,close(){return x("close")},getBox:s},C=e=>{var t=f.value;d.maskClosable&&e.target===t&&x("mask")},B=e=>{if((0,_event.hasEventKey)(e,_event.EVENT_KEYS.ESCAPE)){const t=_xeUtils.default.max(allActiveDrawers,e=>e.reactData.drawerZIndex);t&&setTimeout(()=>{t===h&&t.props.escClosable&&x("exit")},10)}},T=()=>{const t=w["drawerZIndex"];allActiveDrawers.some(e=>e.reactData.visible&&e.reactData.drawerZIndex>t)&&u()};Object.assign(h,k,{});const V=()=>{var{slots:e={},showClose:t,title:r}=d,o=c.title||e.title,e=c.corner||e.corner,o=[(0,_vue.h)("div",{class:"vxe-drawer--header-title"},o?(0,_vn.getSlotVNs)(o({$drawer:h})):r?(0,_utils.getFuncText)(r):_conf.default.i18n("vxe.alert.title"))],r=[];return e&&r.push((0,_vue.h)("span",{class:"vxe-drawer--corner-wrapper"},(0,_vn.getSlotVNs)(e({$drawer:h})))),t&&r.push((0,_vue.h)("i",{class:["vxe-drawer--close-btn","trigger--btn",_conf.default.icon.MODAL_CLOSE],title:_conf.default.i18n("vxe.drawer.close"),onClick:b})),o.push((0,_vue.h)("div",{class:"vxe-drawer--header-right"},r)),o},S=()=>{var{showCancelButton:e,showConfirmButton:t}=d,r=[];return e&&r.push((0,_vue.h)(_button.default,{key:1,ref:l,content:d.cancelButtonText||_conf.default.i18n("vxe.button.cancel"),onClick:y})),t&&r.push((0,_vue.h)(_button.default,{key:2,ref:o,status:"primary",content:d.confirmButtonText||_conf.default.i18n("vxe.button.confirm"),onClick:m})),r};return h.renderVN=()=>{var{className:e,position:t,loading:r,lockScroll:o,lockView:a,mask:l}=d,{inited:n,contentVisible:s,visible:i}=w,u=v.value;return(0,_vue.h)(_vue.Teleport,{to:"body",disabled:!d.transfer||!n},[(0,_vue.h)("div",{ref:f,class:["vxe-drawer--wrapper","pos--"+t,e||"",{["size--"+u]:u,"lock--scroll":o,"lock--view":a,"is--mask":l,"is--visible":s,"is--active":i,"is--loading":r}],style:{zIndex:w.drawerZIndex},onClick:C},[(0,_vue.h)("div",{ref:_,class:"vxe-drawer--box",onMousedown:T},(()=>{var{slots:e={},showTitleOverflow:t}=d,e=c.header||e.header,r=[];return d.showHeader&&r.push((0,_vue.h)("div",{class:["vxe-drawer--header",{"is--ellipsis":t}]},e?!w.inited||d.destroyOnClose&&!w.visible?[]:(0,_vn.getSlotVNs)(e({$drawer:h})):V())),r})().concat((()=>{var{slots:e={},content:t}=d,e=c.default||e.default;return[(0,_vue.h)("div",{class:"vxe-drawer--body"},[(0,_vue.h)("div",{class:"vxe-drawer--content"},e?!w.inited||d.destroyOnClose&&!w.visible?[]:(0,_vn.getSlotVNs)(e({$drawer:h})):(0,_utils.getFuncText)(t)),(0,_vue.h)(_index.default,{class:"vxe-drawer--loading",modelValue:d.loading})])]})(),(()=>{var{slots:e={}}=d,e=c.footer||e.footer,t=[];return d.showFooter&&t.push((0,_vue.h)("div",{class:"vxe-drawer--footer"},e?!w.inited||d.destroyOnClose&&!w.visible?[]:(0,_vn.getSlotVNs)(e({$drawer:h})):S())),t})()))])])},(0,_vue.watch)(()=>d.width,i),(0,_vue.watch)(()=>d.height,i),(0,_vue.watch)(()=>d.modelValue,e=>{e?g():x("model")}),(0,_vue.onMounted)(()=>{(0,_vue.nextTick)(()=>{d.modelValue&&g(),i()}),d.escClosable&&_event.GlobalEvent.on(h,"keydown",B)}),(0,_vue.onUnmounted)(()=>{_event.GlobalEvent.off(h,"keydown")}),h},render(){return this.renderVN()}});