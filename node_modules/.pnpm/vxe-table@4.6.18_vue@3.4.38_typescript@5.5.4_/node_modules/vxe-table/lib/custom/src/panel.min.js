"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_vXETable=require("../../v-x-e-table"),_utils=require("../../tools/utils"),_dom=require("../../tools/dom"),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_modal=_interopRequireDefault(require("../../modal/src/modal")),_button=_interopRequireDefault(require("../../button/src/button")),_group=_interopRequireDefault(require("../../radio/src/group")),_tooltip=_interopRequireDefault(require("../../tooltip/src/tooltip")),_xeUtils=_interopRequireDefault(require("xe-utils"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default=exports.default=(0,_vue.defineComponent)({name:"VxeTableCustomPanel",props:{customStore:{type:Object,default:()=>({})}},setup(c){const n=(0,_vue.inject)("$xetable",{}),g=n["reactData"],{computeCustomOpts:C,computeColumnOpts:T,computeIsMaxFixedColumn:E}=n.getComputeMaps(),k=(0,_vue.ref)(),B=(0,_vue.ref)(),O=(0,_vue.ref)(),y=(0,_vue.ref)();let r;const A=e=>{var t=c["customStore"];t.activeWrapper=!0,n.customOpenEvent(e)},D=e=>{const t=c["customStore"];t.activeWrapper=!1,setTimeout(()=>{t.activeBtn||t.activeWrapper||n.customColseEvent(e)},300)},L=e=>{d(),n.closeCustom(),n.emitCustomEvent("confirm",e)},H=e=>{n.closeCustom(),n.emitCustomEvent("cancel",e)},I=e=>{n.resetColumn(!0),n.closeCustom(),n.emitCustomEvent("reset",e)},R=t=>{_vXETable.VXETable.modal?_vXETable.VXETable.modal.confirm({content:_conf.default.i18n("vxe.custom.cstmConfirmRestore"),className:"vxe-table--ignore-clear",escClosable:!0}).then(e=>{"confirm"===e&&I(t)}):I(t)},o=t=>{var e=g["customColumnList"],e=_xeUtils.default.findTree(e,e=>e===t);e&&e.parent&&(e=e["parent"],e.children)&&e.children.length&&(e.visible=e.children.every(e=>e.visible),e.halfVisible=!e.visible&&e.children.some(e=>e.visible||e.halfVisible),o(e))},X=e=>{const t=!e.visible;var l=C.value;_xeUtils.default.eachTree([e],e=>{e.visible=t,e.halfVisible=!1}),o(e),l.immediate&&n.handleCustom(),n.checkCustomStatus()},q=(e,t)=>{var l=E.value;e.fixed===t?n.clearColumnFixed(e):l&&!e.fixed||n.setColumnFixed(e,t)},F=e=>{E.value||n.setColumnFixed(e,e.fixed)},M=()=>{var e=c["customStore"],t=g["customColumnList"];const l=C.value["checkMethod"],o=!e.isAll;_xeUtils.default.eachTree(t,e=>{l&&!l({column:e})||(e.visible=o,e.halfVisible=!1)}),e.isAll=o,n.checkCustomStatus()},N=e=>{var e=e.currentTarget.parentNode.parentNode,t=e.getAttribute("colid"),t=n.getColumnById(t);e.draggable=!0,y.value=t,(0,_dom.addClass)(e,"active--drag-origin")},V=e=>{var e=e.currentTarget.parentNode.parentNode,t=O.value;e.draggable=!1,(y.value=null,_dom.removeClass)(e,"active--drag-origin"),t&&(t.style.display="")},w=e=>{var t=new Image;e.dataTransfer&&e.dataTransfer.setDragImage(t,0,0)},d=()=>{var e=g["customColumnList"];e.forEach((e,t)=>{e.renderSortNumber=t+1})},K=e=>{var t=g["customColumnList"],e=e.currentTarget,l=O.value;if(r){if(r!==e){var o=r.getAttribute("drag-pos"),i=e.getAttribute("colid");const u=n.getColumnById(i);if(!u)return;var i=_xeUtils.default.findIndexOf(t,e=>e.id===u.id),a=r.getAttribute("colid");const s=n.getColumnById(a);if(!s)return;t.splice(i,1);a=_xeUtils.default.findIndexOf(t,e=>e.id===s.id);t.splice(a+("bottom"===o?1:0),0,u)}r.draggable=!1,r.removeAttribute("drag-pos"),(0,_dom.removeClass)(r,"active--drag-target")}y.value=null,e.draggable=!1,e.removeAttribute("drag-pos"),l&&(l.style.display=""),(0,_dom.removeClass)(e,"active--drag-target"),(0,_dom.removeClass)(e,"active--drag-origin"),d()},S=e=>{var t=e.currentTarget,l=(r!==t&&(0,_dom.removeClass)(r,"active--drag-target"),t.getAttribute("colid")),l=n.getColumnById(l);l&&1===l.level&&(e.preventDefault(),l=e.clientY-t.getBoundingClientRect().y<t.clientHeight/2?"top":"bottom",(0,_dom.addClass)(t,"active--drag-target"),t.setAttribute("drag-pos",l),r=t);{l=e;var o=O.value,i=B.value;i&&o&&(e=(t=i.parentNode).getBoundingClientRect(),o.style.display="block",o.style.top=Math.min(t.clientHeight-t.scrollTop-o.clientHeight,l.clientY-e.y)+"px",o.style.left=Math.min(t.clientWidth-t.scrollLeft-o.clientWidth-16,l.clientX-e.x)+"px")}};return()=>{if("popup"===C.value.mode){const a=c["customStore"];var e=g["customColumnList"];const r=C.value,{checkMethod:d,visibleMethod:v}=r,u=T.value,m=E.value,f=[];return _xeUtils.default.eachTree(e,(t,e,l,o,i)=>{if(!v||v({column:t})){var a=t.visible,u=t.halfVisible,s=(0,_utils.formatText)(t.getTitle(),1),c=t.children&&t.children.length;const n=!!d&&!d({column:t});f.push((0,_vue.h)("tr",{key:t.id,colid:t.id,class:["vxe-table-custom-popup--row level--"+t.level,{"is--group":c}],onDragstart:w,onDragend:K,onDragover:S},[(0,_vue.h)("td",{class:"vxe-table-custom-popup--column-item col--sort"},[1===t.level?(0,_vue.h)("span",{class:"vxe-table-custom-popup--column-sort-btn",onMousedown:N,onMouseup:V},[(0,_vue.h)("i",{class:"vxe-icon-sort"})]):null]),(0,_vue.h)("td",{class:"vxe-table-custom-popup--column-item col--name"},[(0,_vue.h)("div",{class:"vxe-table-custom-popup--name",title:s},s)]),(0,_vue.h)("td",{class:"vxe-table-custom-popup--column-item col--visible"},[(0,_vue.h)("div",{class:["vxe-table-custom--checkbox-option",{"is--checked":a,"is--indeterminate":u,"is--disabled":n}],onClick:()=>{n||X(t)}},[(0,_vue.h)("span",{class:["vxe-checkbox--icon",u?_conf.default.icon.TABLE_CHECKBOX_INDETERMINATE:a?_conf.default.icon.TABLE_CHECKBOX_CHECKED:_conf.default.icon.TABLE_CHECKBOX_UNCHECKED]})])]),(0,_vue.h)("td",{class:"vxe-table-custom-popup--column-item col--fixed"},[!i&&r.allowFixed?(0,_vue.h)(_group.default,{modelValue:t.fixed||"",type:"button",size:"mini",options:[{label:_conf.default.i18n("vxe.custom.setting.fixedLeft"),value:"left",disabled:m},{label:_conf.default.i18n("vxe.custom.setting.fixedUnset"),value:""},{label:_conf.default.i18n("vxe.custom.setting.fixedRight"),value:"right",disabled:m}],"onUpdate:modelValue"(e){t.fixed=e},onChange(){F(t)}}):null])]))}}),(0,_vue.h)(_modal.default,{key:"popup",className:"vxe-table-custom-popup-wrapper vxe-table--ignore-clear",modelValue:a.visible,title:_conf.default.i18n("vxe.custom.cstmTitle"),width:"40vw",minWidth:520,height:"50vh",minHeight:300,mask:!0,lockView:!0,showFooter:!0,resize:!0,escClosable:!0,destroyOnClose:!0,"onUpdate:modelValue"(e){a.visible=e}},{default:()=>(0,_vue.h)("div",{ref:B,class:"vxe-table-custom-popup--body"},[(0,_vue.h)("div",{class:"vxe-table-custom-popup--table-wrapper"},[(0,_vue.h)("table",{},[(0,_vue.h)("colgroup",{},[(0,_vue.h)("col",{style:{width:"80px"}}),(0,_vue.h)("col",{}),(0,_vue.h)("col",{style:{width:"80px"}}),(0,_vue.h)("col",{style:{width:"200px"}})]),(0,_vue.h)("thead",{},[(0,_vue.h)("tr",{},[(0,_vue.h)("th",{},[(0,_vue.h)("span",{class:"vxe-table-custom-popup--table-sort-help-title"},_conf.default.i18n("vxe.custom.setting.colSort")),(0,_vue.h)(_tooltip.default,{enterable:!0,content:_conf.default.i18n("vxe.custom.setting.sortHelpTip")},{default:()=>(0,_vue.h)("i",{class:"vxe-table-custom-popup--table-sort-help-icon vxe-icon-question-circle-fill"})})]),(0,_vue.h)("th",{},_conf.default.i18n("vxe.custom.setting.colTitle")),(0,_vue.h)("th",{},_conf.default.i18n("vxe.custom.setting.colVisible")),(0,_vue.h)("th",{},_conf.default.i18n("vxe.custom.setting.colFixed",[u.maxFixedSize||0]))])]),(0,_vue.h)(_vue.TransitionGroup,{class:"vxe-table-custom--body",tag:"tbody",name:"vxe-table-custom--list"},{default:()=>f})])]),(0,_vue.h)("div",{ref:O,class:"vxe-table-custom-popup--drag-hint"},_conf.default.i18n("vxe.custom.cstmDragTarget",[y.value?y.value.getTitle():""]))]),footer:()=>(0,_vue.h)("div",{class:"vxe-table-custom-popup--footer"},[(0,_vue.h)(_button.default,{content:r.resetButtonText||_conf.default.i18n("vxe.custom.cstmRestore"),onClick:R}),(0,_vue.h)(_button.default,{content:r.resetButtonText||_conf.default.i18n("vxe.custom.cstmCancel"),onClick:H}),(0,_vue.h)(_button.default,{status:"primary",content:r.confirmButtonText||_conf.default.i18n("vxe.custom.cstmConfirm"),onClick:L})])})}{var e=c["customStore"],t=g["customColumnList"];const _=C.value;var l=e["maxHeight"];const{checkMethod:p,visibleMethod:h,trigger:s}=_,x=E.value,b=[];var o={},t=("hover"===s&&(o.onMouseenter=A,o.onMouseleave=D),_xeUtils.default.eachTree(t,(e,t,l,o,i)=>{if(!h||h({column:e})){var a=e.visible,u=e.halfVisible,s=e.children&&e.children.length,c=(0,_utils.formatText)(e.getTitle(),1);const n=!!p&&!p({column:e});b.push((0,_vue.h)("li",{key:e.id,class:["vxe-table-custom--option","level--"+e.level,{"is--group":s}]},[(0,_vue.h)("div",{title:c,class:["vxe-table-custom--checkbox-option",{"is--checked":a,"is--indeterminate":u,"is--disabled":n}],onClick:()=>{n||X(e)}},[(0,_vue.h)("span",{class:["vxe-checkbox--icon",u?_conf.default.icon.TABLE_CHECKBOX_INDETERMINATE:a?_conf.default.icon.TABLE_CHECKBOX_CHECKED:_conf.default.icon.TABLE_CHECKBOX_UNCHECKED]}),(0,_vue.h)("span",{class:"vxe-checkbox--label"},c)]),!i&&_.allowFixed?(0,_vue.h)("div",{class:"vxe-table-custom--fixed-option"},[(0,_vue.h)("span",{class:["vxe-table-custom--fixed-left-option","left"===e.fixed?_conf.default.icon.TOOLBAR_TOOLS_FIXED_LEFT_ACTIVED:_conf.default.icon.TOOLBAR_TOOLS_FIXED_LEFT,{"is--checked":"left"===e.fixed,"is--disabled":x&&!e.fixed}],title:_conf.default.i18n("left"===e.fixed?"vxe.toolbar.cancelFixed":"vxe.toolbar.fixedLeft"),onClick:()=>{q(e,"left")}}),(0,_vue.h)("span",{class:["vxe-table-custom--fixed-right-option","right"===e.fixed?_conf.default.icon.TOOLBAR_TOOLS_FIXED_RIGHT_ACTIVED:_conf.default.icon.TOOLBAR_TOOLS_FIXED_RIGHT,{"is--checked":"right"===e.fixed,"is--disabled":x&&!e.fixed}],title:_conf.default.i18n("right"===e.fixed?"vxe.toolbar.cancelFixed":"vxe.toolbar.fixedRight"),onClick:()=>{q(e,"right")}})]):null]))}}),e.isAll),i=e.isIndeterminate;return(0,_vue.h)("div",{ref:k,key:"simple",class:["vxe-table-custom-wrapper",{"is--active":e.visible}]},[(0,_vue.h)("ul",{class:"vxe-table-custom--header"},[(0,_vue.h)("li",{class:"vxe-table-custom--option"},[(0,_vue.h)("div",{class:["vxe-table-custom--checkbox-option",{"is--checked":t,"is--indeterminate":i}],title:_conf.default.i18n("vxe.table.allTitle"),onClick:M},[(0,_vue.h)("span",{class:["vxe-checkbox--icon",i?_conf.default.icon.TABLE_CHECKBOX_INDETERMINATE:t?_conf.default.icon.TABLE_CHECKBOX_CHECKED:_conf.default.icon.TABLE_CHECKBOX_UNCHECKED]}),(0,_vue.h)("span",{class:"vxe-checkbox--label"},_conf.default.i18n("vxe.toolbar.customAll"))])])]),(0,_vue.h)("ul",Object.assign({class:"vxe-table-custom--body",style:l?{maxHeight:l+"px"}:{}},o),b),_.showFooter?(0,_vue.h)("div",{class:"vxe-table-custom--footer"},[(0,_vue.h)("button",{class:"btn--reset",onClick:I},_.resetButtonText||_conf.default.i18n("vxe.toolbar.customRestore")),(0,_vue.h)("button",{class:"btn--confirm",onClick:L},_.confirmButtonText||_conf.default.i18n("vxe.toolbar.customConfirm"))]):null]);return}}}});