"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_vXETable=require("../../v-x-e-table"),_util=require("./util"),_dom=require("../../tools/dom"),_utils=require("../../tools/utils"),_vn=require("../../tools/vn");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const renderType="body",lineOffsetSizes={mini:3,small:2,medium:1};var _default=exports.default=(0,_vue.defineComponent)({name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,fixedColumn:Array,fixedType:{type:String,default:null}},setup(m){const ae=(0,_vue.inject)("$xetable",{}),l=(0,_vue.inject)("xesize",null),{xID:w,props:se,context:y,reactData:ie,internalData:ne}=ae,{refTableHeader:_,refTableBody:b,refTableFooter:U,refTableLeftBody:T,refTableRightBody:S,refValidTooltip:j}=ae.getRefMaps(),{computeEditOpts:ce,computeMouseOpts:B,computeSYOpts:ue,computeEmptyOpts:X,computeKeyboardOpts:Y,computeTooltipOpts:he,computeRadioOpts:e,computeExpandOpts:F,computeTreeOpts:d,computeCheckboxOpts:de,computeValidOpts:xe,computeRowOpts:ve,computeColumnOpts:ge}=ae.getComputeMaps(),C=(0,_vue.ref)(),O=(0,_vue.ref)(),L=(0,_vue.ref)(),R=(0,_vue.ref)(),E=(0,_vue.ref)(),H=(0,_vue.ref)(),$=(0,_vue.ref)(),v=()=>{if(l){var e=l.value;if(e)return lineOffsetSizes[e]||0}return 0},pe=()=>{var e=se["delayHover"],{lastScrollTime:l,_isResize:t}=ie;return!!(t||l&&Date.now()<l+e)},p=(e,l)=>{let t=1;if(e){var o=d.value,r=e[o.children||o.childrenField];if(r&&ae.isTreeExpandByRow(e))for(let e=0;e<r.length;e++)t+=p(r[e],l)}return t},fe=e=>{var{row:l,column:t}=e,o=ne["afterFullData"],r=se["treeConfig"],a=d.value,{slots:t,treeNode:s}=t,i=ne["fullAllDataRowIdData"],i=i[(0,_util.getRowid)(ae,l)];let n=0,c=0,u=[];return i&&(n=i.level,c=i._index,u=i.items),t&&t.line?ae.callSlot(t.line,e):(i=ae.eqRow(o[0],l),r&&s&&(a.showLine||a.line)?[(0,_vue.h)("div",{class:"vxe-tree--line-wrapper"},[(0,_vue.h)("div",{class:"vxe-tree--line",style:{height:`${i?1:((e,l,t)=>{let o=1;return t&&(o=p(l[t-1],e)),ie.rowHeight*o-(t?1:12-v())})(e,u,c)}px`,left:n*a.indent+(n?2-v():0)+16+"px"}})])]:[])},V=(e,l,t,o,r,a,s,i,n,c,q,U)=>{var{columnKey:j,height:u,showOverflow:d,cellClassName:B,cellStyle:v,align:p,spanMethod:h,mouseConfig:X,editConfig:Y,editRules:x,tooltipConfig:N}=se,{tableData:W,overflowX:g,scrollYLoad:F,currentColumn:V,mergeList:f,editStore:m,isAllOverflow:A,validErrorMaps:w}=ie,P=ne["afterFullData"],y=xe.value,K=de.value,_=ce.value,b=he.value,T=ve.value,S=ue.value,z=ge.value,{type:G,cellRender:J,editRender:C,align:O,showOverflow:L,className:Q,treeNode:Z,slots:ee}=n,m=m["actived"],S=S["rHeight"],T=T["height"],R=C||J,R=R?_vXETable.VXETable.renderer.get(R.name):null,le=R?R.cellClassName:"",R=R?R.cellStyle:"";const E=b.showAll;var b=ae.getColumnIndex(n),te=ae.getVTColumnIndex(n),oe=(0,_utils.isEnableConf)(C);let H=t?n.fixed!==t:n.fixed&&g;g=_xeUtils.default.isUndefined(L)||_xeUtils.default.isNull(L)?d:L;let $="ellipsis"===g;const M="title"===g,D=!0===g||"tooltip"===g;let I=M||D||$,re;L={},g=O||p,O=w[l+":"+n.id],p=x&&y.showMessage&&("default"===y.message?u||1<W.length:"inline"===y.message),w={colid:n.id};const k={$table:ae,$grid:ae.xegrid,seq:e,rowid:l,row:r,rowIndex:a,$rowIndex:s,_rowIndex:i,column:n,columnIndex:b,$columnIndex:c,_columnIndex:te,fixed:t,type:renderType,isHidden:H,level:o,visibleData:P,data:W,items:U};if(F&&!I&&($=I=!0),(M||D||E||N)&&(L.onMouseenter=e=>{pe()||(M?(0,_dom.updateCellTitle)(e.currentTarget,n):(D||E)&&ae.triggerBodyTooltipEvent(e,k),ae.dispatchEvent("cell-mouseenter",Object.assign({cell:e.currentTarget},k),e))}),(D||E||N)&&(L.onMouseleave=e=>{pe()||((D||E)&&ae.handleTargetLeaveEvent(e),ae.dispatchEvent("cell-mouseleave",Object.assign({cell:e.currentTarget},k),e))}),(K.range||X)&&(L.onMousedown=e=>{ae.triggerCellMousedownEvent(e,k)}),L.onClick=e=>{ae.triggerCellClickEvent(e,k)},L.onDblclick=e=>{ae.triggerCellDblclickEvent(e,k)},f.length){x=(0,_util.mergeBodyMethod)(f,i,te);if(x){var{rowspan:u,colspan:e}=x;if(!u||!e)return null;1<u&&(w.rowspan=u),1<e&&(w.colspan=e)}}else if(h){var{rowspan:l=1,colspan:a=1}=h(k)||{};if(!l||!a)return null;1<l&&(w.rowspan=l),1<a&&(w.colspan=a)}!(H=H&&f&&(1<w.colspan||1<w.rowspan)?!1:H)&&Y&&(C||J)&&(_.showStatus||_.showUpdateStatus)&&(re=ae.isUpdateByRow(r,n.field));s=[];return H&&d&&A?s.push((0,_vue.h)("div",{class:["vxe-cell",{"c--title":M,"c--tooltip":D,"c--ellipsis":$}],style:{maxHeight:I&&(S||T)?`${S||T}px`:""}})):(s.push(...fe(k),(0,_vue.h)("div",{class:["vxe-cell",{"c--title":M,"c--tooltip":D,"c--ellipsis":$}],style:{maxHeight:I&&(S||T)?`${S||T}px`:""},title:M?ae.getCellLabel(r,n):null},n.renderCell(k))),p&&O&&(b=O.rule,t=ee?ee.valid:null,o=Object.assign(Object.assign({},k),O),s.push((0,_vue.h)("div",{class:["vxe-cell--valid-error-hint",(0,_dom.getPropClass)(y.className,o)],style:b&&b.maxWidth?{width:b.maxWidth+"px"}:null},t?ae.callSlot(t,o):[(0,_vue.h)("span",{class:"vxe-cell--valid-error-msg"},O.content)])))),(0,_vue.h)("td",Object.assign(Object.assign(Object.assign({class:["vxe-body--column",n.id,{["col--"+g]:g,["col--"+G]:G,"col--last":c===q.length-1,"col--tree-node":Z,"col--edit":oe,"col--ellipsis":I,"fixed--hidden":H,"col--dirty":re,"col--active":Y&&oe&&m.row===r&&(m.column===n||"row"===_.mode),"col--valid-error":!!O,"col--current":V===n},(0,_dom.getPropClass)(le,k),(0,_dom.getPropClass)(Q,k),(0,_dom.getPropClass)(B,k)],key:j||z.useKey?n.id:c},w),{style:Object.assign({height:I&&(S||T)?`${S||T}px`:""},_xeUtils.default.isFunction(R)?R(k):R,_xeUtils.default.isFunction(v)?v(k):v)}),L),s)},W=(x,g,f)=>{const{stripe:m,rowKey:w,highlightHoverRow:y,rowClassName:_,rowStyle:b,showOverflow:T,editConfig:S,treeConfig:C}=se,{hasFixedColumn:O,treeExpandedMaps:L,scrollYLoad:R,rowExpandedMaps:E,expandColumn:H,selectRadioRow:$,pendingRowMaps:M,pendingRowList:D}=ie,I=ne["fullAllDataRowIdData"],k=de.value,q=e.value,U=d.value,j=ce.value,B=ve.value,X=U["transform"],Y=U.children||U.childrenField,N=[];return g.forEach((t,o)=>{var e={};let r;r=ae.getRowIndex(t),(B.isHover||y)&&(e.onMouseenter=e=>{pe()||ae.triggerHoverEvent(e,{row:t,rowIndex:r})},e.onMouseleave=()=>{pe()||ae.clearHoverRow()});const a=(0,_util.getRowid)(ae,t);var l=I[a];let s=0,i=-1,n=0;l&&(s=l.level,i=l.seq,n=l._index);var c,u,l={$table:ae,seq:i,rowid:a,fixed:x,type:renderType,level:s,row:t,rowIndex:r,$rowIndex:o,_rowIndex:n},d=H&&!!E[a];let v=!1,p=[],h=!1;S&&(h=ae.isInsertByRow(t)),!C||R||X||(p=t[Y],v=p&&p.length&&!!L[a]),N.push((0,_vue.h)("tr",Object.assign({class:["vxe-body--row",C?"row--level-"+s:"",{"row--stripe":m&&(ae.getVTRowIndex(t)+1)%2==0,"is--new":h,"is--expand-row":d,"is--expand-tree":v,"row--new":h&&(j.showStatus||j.showInsertStatus),"row--radio":q.highlight&&ae.eqRow($,t),"row--checked":k.highlight&&ae.isCheckedByCheckboxRow(t),"row--pending":D.length&&!!M[a]},(0,_dom.getPropClass)(_,l)],rowid:a,style:b?_xeUtils.default.isFunction(b)?b(l):b:null,key:w||B.useKey||C?a:o},e),f.map((e,l)=>V(i,a,x,s,t,r,o,n,e,l,f,g)))),d&&(l=F.value["height"],d={},c=(l&&(d.height=l+"px"),C&&(d.paddingLeft=s*U.indent+30+"px"),H)["showOverflow"],c=_xeUtils.default.isUndefined(c)||_xeUtils.default.isNull(c)?T:c,u={$table:ae,seq:i,column:H,fixed:x,type:renderType,level:s,row:t,rowIndex:r,$rowIndex:o,_rowIndex:n},N.push((0,_vue.h)("tr",Object.assign({class:"vxe-body--expanded-row",key:"expand_"+a,style:b?_xeUtils.default.isFunction(b)?b(u):b:null},e),[(0,_vue.h)("td",{class:{"vxe-body--expanded-column":1,"fixed--hidden":x&&!O,"col--ellipsis":c},colspan:f.length},[(0,_vue.h)("div",{class:{"vxe-body--expanded-cell":1,"is--ellipsis":l},style:d},[H.renderData(u)])])]))),v&&N.push(...W(x,p,f))}),N};let r;const M=(e,l,t,o)=>{(t||o)&&(t&&((0,_util.removeScrollListener)(t),t.scrollTop=l),o&&((0,_util.removeScrollListener)(o),o.scrollTop=l),clearTimeout(r),r=setTimeout(()=>{(0,_util.restoreScrollListener)(t),(0,_util.restoreScrollListener)(o),ie.lastScrollTime=Date.now()},300))},o=e=>{var l=m["fixedType"],t=se["highlightHoverRow"],{scrollXLoad:o,scrollYLoad:r}=ie,{elemStore:a,lastScrollTop:s,lastScrollLeft:i}=ne,n=ve.value,c=_.value,u=b.value,d=U.value,v=T.value,p=S.value,h=j.value,x=C.value,c=c?c.$el:null,d=d?d.$el:null,u=u.$el,v=v?v.$el:null,p=p?p.$el:null,g=a["main-body-ySpace"],g=g?g.value:null,a=a["main-body-xSpace"],a=a?a.value:null,g=(r&&g?g:u).clientHeight,a=(o&&a?a:u).clientWidth;let f=x.scrollTop;x=u.scrollLeft,i=x!==i,s=f!==s;ne.lastScrollTop=f,ne.lastScrollLeft=x,ie.lastScrollTime=Date.now(),(n.isHover||t)&&ae.clearHoverRow(),v&&"left"===l?(f=v.scrollTop,M(0,f,u,p)):p&&"right"===l?(f=p.scrollTop,M(0,f,u,v)):(i&&(c&&(c.scrollLeft=u.scrollLeft),d)&&(d.scrollLeft=u.scrollLeft),(v||p)&&(ae.checkScrolling(),s)&&M(0,f,v,p)),o&&i&&ae.triggerScrollXEvent(e),r&&s&&ae.triggerScrollYEvent(e),i&&h&&h.reactData.visible&&h.updatePlacement(),ae.dispatchEvent("scroll",{type:renderType,fixed:l,scrollTop:f,scrollLeft:x,scrollHeight:u.scrollHeight,scrollWidth:u.scrollWidth,bodyHeight:g,bodyWidth:a,isX:i,isY:s},e)};let f,D=0,I=0,k=0,q=!1;const h=(r,a,e,s,i)=>{var l=ne["elemStore"],{scrollXLoad:t,scrollYLoad:o}=ie,n=b.value,c=T.value,u=S.value;const d=c?c.$el:null,v=u?u.$el:null,p=n.$el;c=l["main-body-ySpace"],u=c?c.value:null,n=l["main-body-xSpace"],c=n?n.value:null;const h=(o&&u?u:p).clientHeight,x=(t&&c?c:p).clientWidth;l=q===a?Math.max(0,D-k):0;q=a,D=Math.abs(a?e-l:e+l),I=0,k=0,clearTimeout(f);const g=()=>{var e,l,t,o;k<D&&(e=m["fixedType"],{scrollTop:o,clientHeight:l,scrollHeight:t}=(I=Math.max(5,Math.floor(1.5*I)),(k+=I)>D&&(I-=k-D),p),o=o+I*(a?-1:1),p.scrollTop=o,d&&(d.scrollTop=o),v&&(v.scrollTop=o),(a?o<t-l:0<=o)&&(f=setTimeout(g,10)),ae.dispatchEvent("scroll",{type:renderType,fixed:e,scrollTop:p.scrollTop,scrollLeft:p.scrollLeft,scrollHeight:p.scrollHeight,scrollWidth:p.scrollWidth,bodyHeight:h,bodyWidth:x,isX:s,isY:i},r))};g()},N=e=>{var{deltaY:l,deltaX:t}=e,o=se["highlightHoverRow"],r=ie["scrollYLoad"],{lastScrollTop:a,lastScrollLeft:s}=ne,i=ve.value,n=b.value,c=C.value,n=n.$el,u=l<0;(u?c.scrollTop<=0:c.scrollTop>=c.scrollHeight-c.clientHeight)||(c=c.scrollTop+l,t=(n=n.scrollLeft+t)!==s,(s=c!==a)&&(e.preventDefault(),ne.lastScrollTop=c,ne.lastScrollLeft=n,ie.lastScrollTime=Date.now(),(i.isHover||o)&&ae.clearHoverRow(),h(e,u,l,t,s),r)&&ae.triggerScrollYEvent(e))};(0,_vue.onMounted)(()=>{(0,_vue.nextTick)(()=>{var e=m["fixedType"],l=ne["elemStore"],e=`${e||"main"}-body-`,t=C.value;l[e+"wrapper"]=C,l[e+"table"]=O,l[e+"colgroup"]=L,l[e+"list"]=R,l[e+"xSpace"]=E,l[e+"ySpace"]=H,l[e+"emptyBlock"]=$,t&&(t.onscroll=o,t._onscroll=o)})}),(0,_vue.onBeforeUnmount)(()=>{var e=C.value;clearTimeout(f),e&&(e._onscroll=null,e.onscroll=null)}),(0,_vue.onUnmounted)(()=>{var e=m["fixedType"],l=ne["elemStore"],e=`${e||"main"}-body-`;l[e+"wrapper"]=null,l[e+"table"]=null,l[e+"colgroup"]=null,l[e+"list"]=null,l[e+"xSpace"]=null,l[e+"ySpace"]=null,l[e+"emptyBlock"]=null});return()=>{let{fixedColumn:e,fixedType:l,tableColumn:t}=m;var{keyboardConfig:o,showOverflow:r,spanMethod:a,mouseConfig:s}=se,{tableData:i,mergeList:n,scrollYLoad:c,isAllOverflow:u}=ie,d=ne["visibleColumn"],v=y["slots"],p=ue.value,h=X.value,x=Y.value,g=B.value;l&&(t=ie.expandColumn||!(c||r&&u)||n.length||a||o&&x.isMerge?d:e);let f;c=v?v.empty:null;return f=c?ae.callSlot(c,{$table:ae,$grid:ae.xegrid}):(u=(r=h.name?_vXETable.VXETable.renderer.get(h.name):null)?r.renderTableEmptyView||r.renderEmpty:null)?(0,_vn.getSlotVNs)(u(h,{$table:ae})):se.emptyText||_conf.default.i18n("vxe.table.emptyText"),(0,_vue.h)("div",Object.assign({ref:C,class:["vxe-table--body-wrapper",l?`fixed-${l}--wrapper`:"body--wrapper"],xid:w},"wheel"===p.mode?{onWheel:N}:{}),[l?(0,_vue.createCommentVNode)():(0,_vue.h)("div",{ref:E,class:"vxe-body--x-space"}),(0,_vue.h)("div",{ref:H,class:"vxe-body--y-space"}),(0,_vue.h)("table",{ref:O,class:"vxe-table--body",xid:w,cellspacing:0,cellpadding:0,border:0},[(0,_vue.h)("colgroup",{ref:L},t.map((e,l)=>(0,_vue.h)("col",{name:e.id,key:l}))),(0,_vue.h)("tbody",{ref:R},W(l,i,t))]),(0,_vue.h)("div",{class:"vxe-table--checkbox-range"}),s&&g.area?(0,_vue.h)("div",{class:"vxe-table--cell-area"},[(0,_vue.h)("span",{class:"vxe-table--cell-main-area"},g.extension?[(0,_vue.h)("span",{class:"vxe-table--cell-main-area-btn",onMousedown(e){ae.triggerCellExtendMousedownEvent(e,{$table:ae,fixed:l,type:renderType})}})]:[]),(0,_vue.h)("span",{class:"vxe-table--cell-copy-area"}),(0,_vue.h)("span",{class:"vxe-table--cell-extend-area"}),(0,_vue.h)("span",{class:"vxe-table--cell-multi-area"}),(0,_vue.h)("span",{class:"vxe-table--cell-active-area"})]):null,l?null:(0,_vue.h)("div",{class:"vxe-table--empty-block",ref:$},[(0,_vue.h)("div",{class:"vxe-table--empty-content"},f)])])}}});