"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_size=require("../../hooks/size"),_dom=require("../../tools/dom"),_utils=require("../../tools/utils"),_event=require("../../tools/event");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default=exports.default=(0,_vue.defineComponent)({name:"VxePulldown",props:{modelValue:Boolean,disabled:Boolean,placement:String,size:{type:String,default:()=>_conf.default.size},className:[String,Function],popupClassName:[String,Function],destroyOnClose:Boolean,transfer:Boolean},emits:["update:modelValue","hide-panel"],setup(m,e){const{slots:b,emit:n}=e;var t=_xeUtils.default.uniqueId();const x=(0,_size.useSize)(m),h=(0,_vue.reactive)({inited:!1,panelIndex:0,panelStyle:null,panelPlacement:null,visiblePanel:!1,animatVisible:!1,isActivated:!1}),g=(0,_vue.ref)(),w=(0,_vue.ref)(),P=(0,_vue.ref)(),l={refElem:g},V={xID:t,props:m,context:e,reactData:h,getRefMaps:()=>l};let a;const i=()=>{h.panelIndex<(0,_utils.getLastZIndex)()&&(h.panelIndex=(0,_utils.nextZIndex)())};const o=()=>(0,_vue.nextTick)().then(()=>{var{transfer:e,placement:n}=m,{panelIndex:i,visiblePanel:a}=h;if(a){var a=w.value,o=P.value;if(o&&a){var s=a.offsetHeight,u=a.offsetWidth,d=o.offsetHeight,o=o.offsetWidth,i={zIndex:i},{boundingTop:a,boundingLeft:v,visibleHeight:r,visibleWidth:p}=(0,_dom.getAbsolutePos)(a);let l="bottom";if(e){let e=v,t=a+s;"top"===n?(l="top",t=a-d):n||(t+d+5>r&&(l="top",t=a-d),t<5&&(l="bottom",t=a+s)),e+o+5>p&&(e-=e+o+5-p),e<5&&(e=5),Object.assign(i,{left:e+"px",top:t+"px",minWidth:u+"px"})}else"top"===n?(l="top",i.bottom=s+"px"):n||r<a+s+d&&5<a-s-d&&(l="top",i.bottom=s+"px");h.panelStyle=i,h.panelPlacement=l}}return(0,_vue.nextTick)()});let s;const u=()=>(h.inited||(h.inited=!0),new Promise(e=>{m.disabled?(0,_vue.nextTick)(()=>{e()}):(clearTimeout(s),h.isActivated=!0,h.animatVisible=!0,setTimeout(()=>{h.visiblePanel=!0,n("update:modelValue",!0),o(),setTimeout(()=>{e(o())},40)},10),i())})),d=()=>(h.visiblePanel=!1,n("update:modelValue",!1),new Promise(e=>{h.animatVisible?s=window.setTimeout(()=>{(h.animatVisible=!1,_vue.nextTick)(()=>{e()})},350):(0,_vue.nextTick)(()=>{e()})}));const v=e=>{var t=m["disabled"],l=h["visiblePanel"],n=P.value;t||l&&((0,_dom.getEventTargetNode)(e,n).flag?o():(d(),a.dispatchEvent("hide-panel",{},e)))},r=e=>{var t=m["disabled"],l=h["visiblePanel"],n=g.value,i=P.value;t||(h.isActivated=(0,_dom.getEventTargetNode)(e,n).flag||(0,_dom.getEventTargetNode)(e,i).flag,l&&!h.isActivated&&(d(),a.dispatchEvent("hide-panel",{},e)))},p=e=>{h.visiblePanel&&(h.isActivated=!1,d(),a.dispatchEvent("hide-panel",{},e))};a={dispatchEvent(e,t,l){n(e,Object.assign({$pulldown:V,$event:l},t))},isPanelVisible:()=>h.visiblePanel,togglePanel:()=>(h.visiblePanel?d:u)(),showPanel:u,hidePanel:d},Object.assign(V,a),(0,_vue.watch)(()=>m.modelValue,e=>{(e?u:d)()}),(0,_vue.nextTick)(()=>{_event.GlobalEvent.on(V,"mousewheel",v),_event.GlobalEvent.on(V,"mousedown",r),_event.GlobalEvent.on(V,"blur",p)}),(0,_vue.onUnmounted)(()=>{_event.GlobalEvent.off(V,"mousewheel"),_event.GlobalEvent.off(V,"mousedown"),_event.GlobalEvent.off(V,"blur")});return V.renderVN=()=>{var{className:e,popupClassName:t,destroyOnClose:l,transfer:n,disabled:i}=m,{inited:a,isActivated:o,animatVisible:s,visiblePanel:u,panelStyle:d,panelPlacement:v}=h,r=x.value,p=b.default,c=b.header,_=b.footer,f=b.dropdown;return(0,_vue.h)("div",{ref:g,class:["vxe-pulldown",e?_xeUtils.default.isFunction(e)?e({$pulldown:V}):e:"",{["size--"+r]:r,"is--visivle":u,"is--disabled":i,"is--active":o}]},[(0,_vue.h)("div",{ref:w,class:"vxe-pulldown--content"},p?p({$pulldown:V}):[]),(0,_vue.h)(_vue.Teleport,{to:"body",disabled:!n||!a},[(0,_vue.h)("div",{ref:P,class:["vxe-table--ignore-clear vxe-pulldown--panel",t?_xeUtils.default.isFunction(t)?t({$pulldown:V}):t:"",{["size--"+r]:r,"is--transfer":n,"animat--leave":s,"animat--enter":u}],placement:v,style:d},f?[(0,_vue.h)("div",{class:"vxe-pulldown--panel-wrapper"},!a||l&&!u&&!s?[]:[c?(0,_vue.h)("div",{class:"vxe-pulldown--panel-header"},c({$pulldown:V})):(0,_vue.createCommentVNode)(),(0,_vue.h)("div",{class:"vxe-pulldown--panel-body"},f({$pulldown:V})),_?(0,_vue.h)("div",{class:"vxe-pulldown--panel-footer"},_({$pulldown:V})):(0,_vue.createCommentVNode)()])]:[])])])},V},render(){return this.renderVN()}});