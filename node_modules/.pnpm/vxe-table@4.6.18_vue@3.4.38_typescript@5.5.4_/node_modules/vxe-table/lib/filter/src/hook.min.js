"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_vXETable=require("../../v-x-e-table"),_util=require("../../table/src/util"),_dom=require("../../tools/dom");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const tableFilterMethodKeys=["setFilter","clearFilter","getCheckedFilters"],tableFilterHook={setupTable(m){const{props:d,reactData:b,internalData:s}=m,{refTableBody:F,refTableFilter:g}=m.getRefMaps(),{computeFilterOpts:h,computeMouseOpts:v}=m.getComputeMaps(),a={checkFilterOptions(){var e=b["filterStore"];e.isAllSelected=e.options.every(e=>e._checked),e.isIndeterminate=!e.isAllSelected&&e.options.some(e=>e._checked)},triggerFilterEvent(e,c,t){const{initStore:l,filterStore:d}=b;if(d.column===c&&d.visible)d.visible=!1;else{const{target:h,pageX:v}=e,p=(0,_dom.getDomNode)()["visibleWidth"];var{filters:r,filterMultiple:i,filterRender:a}=c,a=a?_vXETable.VXETable.renderer.get(a.name):null;const o=c.filterRecoverMethod||(a?a.filterRecoverMethod:null);s._currFilterParams=t,Object.assign(d,{multiple:i,options:r,column:c,style:null}),d.options.forEach(e=>{var{_checked:t,checked:l}=e;(e._checked=l)||t===l||o&&o({option:e,column:c,$table:m})}),this.checkFilterOptions(),d.visible=!0,l.filter=!0,(0,_vue.nextTick)(()=>{var e=F.value.$el,t=g.value,t=t?t.$el:null;let l=0,r=0,i=null,a=null;t&&(l=t.offsetWidth,r=t.offsetHeight,i=t.querySelector(".vxe-table--filter-header"),a=t.querySelector(".vxe-table--filter-footer"));var t=l/2,o=e.clientWidth-l-10;let s,n;var f={top:h.offsetTop+h.offsetParent.offsetTop+h.offsetHeight+8+"px"};let u=null;r>=e.clientHeight&&(u=Math.max(60,e.clientHeight-(a?a.offsetHeight:0)-(i?i.offsetHeight:0))),"left"===c.fixed?s=h.offsetLeft+h.offsetParent.offsetLeft-t:"right"===c.fixed?n=h.offsetParent.offsetWidth-h.offsetLeft+(h.offsetParent.offsetParent.offsetWidth-h.offsetParent.offsetLeft)-c.renderWidth-t:s=h.offsetLeft+h.offsetParent.offsetLeft-t-e.scrollLeft,s?(0<(e=v+l-t+10-p)&&(s-=e),f.left=Math.min(o,Math.max(10,s))+"px"):n&&(0<(e=v+l-t+10-p)&&(n+=e),f.right=Math.max(10,n)+"px"),d.style=f,d.maxHeight=u})}m.dispatchEvent("filter-visible",{column:c,field:c.field,property:c.field,filterList:m.getCheckedFilters(),visible:d.visible},e)},handleClearFilter(e){if(e){var{filters:t,filterRender:l}=e;if(t){l=l?_vXETable.VXETable.renderer.get(l.name):null;const r=e.filterResetMethod||(l?l.filterResetMethod:null);t.forEach(e=>{e._checked=!1,e.checked=!1,r||(e.data=_xeUtils.default.clone(e.resetValue,!0))}),r&&r({options:t,column:e,$table:m})}}},confirmFilterEvent(e){var t=d["mouseConfig"];const{filterStore:l,scrollXLoad:r,scrollYLoad:i}=b;var a=h.value,o=v.value,s=l["column"],n=s["field"];const f=[],u=[];s.filters.forEach(e=>{e.checked&&(f.push(e.value),u.push(e.data))});var c=m.getCheckedFilters(),s={$table:m,$event:e,column:s,field:n,property:n,values:f,datas:u,filters:c,filterList:c};a.remote||(m.handleTableData(!0),m.checkSelectionStatus()),t&&o.area&&m.handleFilterEvent&&m.handleFilterEvent(e,s),m.dispatchEvent("filter-change",s,e),m.closeFilter(),m.updateFooter().then(()=>{var{scrollXLoad:e,scrollYLoad:t}=b;if(r||e||i||t)return(r||e)&&m.updateScrollXSpace(),(i||t)&&m.updateScrollYSpace(),m.refreshScroll()}).then(()=>(m.updateCellAreas(),m.recalculate(!0))).then(()=>{setTimeout(()=>m.recalculate(),50)})}};return Object.assign(Object.assign({},{openFilter(e){const t=(0,_util.handleFieldOrColumn)(m,e);if(t&&t.filters){const l=s["elemStore"],r=t["fixed"];return m.scrollToColumn(t).then(()=>{var e=l[`${r||"main"}-header-wrapper`]||l["main-header-wrapper"],e=e?e.value:null;e&&(e=e.querySelector(`.vxe-header--column.${t.id} .vxe-filter--btn`),(0,_dom.triggerEvent)(e,"click"))})}return(0,_vue.nextTick)()},setFilter(e,t){e=(0,_util.handleFieldOrColumn)(m,e);return e&&e.filters&&(e.filters=(0,_util.toFilters)(t||[])),(0,_vue.nextTick)()},clearFilter(e){var t=b["filterStore"],l=s["tableFullColumn"],r=h.value;let i;return e?(i=(0,_util.handleFieldOrColumn)(m,e))&&a.handleClearFilter(i):l.forEach(a.handleClearFilter),e&&i===t.column||Object.assign(t,{isAllSelected:!1,isIndeterminate:!1,style:null,options:[],column:null,multiple:!1,visible:!1}),r.remote?(0,_vue.nextTick)():m.updateData()},getCheckedFilters(){var e=s["tableFullColumn"];const a=[];return e.forEach(e=>{var{field:t,filters:l}=e;const r=[],i=[];l&&l.length&&(l.forEach(e=>{e.checked&&(r.push(e.value),i.push(e.data))}),r.length)&&a.push({column:e,field:t,property:t,values:r,datas:i})}),a}}),a)},setupGrid(e){return e.extendTableMethods(tableFilterMethodKeys)}};var _default=exports.default=tableFilterHook;