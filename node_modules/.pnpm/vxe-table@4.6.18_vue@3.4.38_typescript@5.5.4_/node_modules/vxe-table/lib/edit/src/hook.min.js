"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_vXETable=require("../../v-x-e-table"),_utils=require("../../tools/utils"),_util=require("../../table/src/util"),_dom=require("../../tools/dom"),_log=require("../../tools/log");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const tableEditMethodKeys=["insert","insertAt","insertNextAt","remove","removeCheckboxRow","removeRadioRow","removeCurrentRow","getRecordset","getInsertRecords","getRemoveRecords","getUpdateRecords","getEditRecord","getActiveRecord","getSelectedCell","clearEdit","clearActived","clearSelected","isEditByRow","isActiveByRow","setEditRow","setActiveRow","setEditCell","setActiveCell","setSelectCell"],editHook={setupTable(E){const{props:b,reactData:I,internalData:F}=E,o=E.getRefMaps()["refElem"],{computeMouseOpts:u,computeEditOpts:f,computeCheckboxOpts:x,computeTreeOpts:S}=E.getComputeMaps();let R={},p={};const m=(e,t)=>{var{model:l,editRender:r}=t;r&&(l.value=(0,_util.getCellValue)(e,t),l.update=!1)},a=(e,t)=>{var{model:l,editRender:r}=t;r&&l.update&&((0,_util.setCellValue)(e,t,l.value),l.update=!1,l.value=null)},l=()=>{var e=o.value;e&&(e=e.querySelector(".col--selected"))&&(0,_dom.removeClass)(e,"col--selected")};function n(){var{editStore:e,tableColumn:t}=I,l=f.value,e=e["actived"];const{row:r,column:o}=e;(r||o)&&("row"===l.mode?t.forEach(e=>a(r,e)):a(r,o))}function A(e,t){const{tableFullTreeData:n,afterFullData:d,fullDataRowIdData:i,fullAllDataRowIdData:c}=F;var l=S.value;const{rowField:s,parentField:u,mapChildrenField:v}=l,g=l.children||l.childrenField,w=t?"push":"unshift";e.forEach(l=>{const t=l[u];var r=(0,_util.getRowid)(E,l),o=t?_xeUtils.default.findTree(n,e=>t===e[s],{children:v}):null;if(o){var o=o["item"],a=c[(0,_util.getRowid)(E,o)],a=a?a.level:0;let e=o[g],t=o[v];_xeUtils.default.isArray(e)||(e=o[g]=[]),_xeUtils.default.isArray(t)||(t=o[g]=[]),e[w](l),t[w](l);o={row:l,rowid:r,seq:-1,index:-1,_index:-1,$index:-1,items:e,parent:o,level:a+1};i[r]=o,c[r]=o}else{"development"===process.env.NODE_ENV&&t&&(0,_log.warnLog)("vxe.error.unableInsert"),d[w](l),n[w](l);a={row:l,rowid:r,seq:-1,index:-1,_index:-1,$index:-1,items:n,parent:null,level:0};i[r]=a,c[r]=a}})}const r=(t,l,o)=>{const a=b["treeConfig"];var{mergeList:e,editStore:r}=I;const{tableFullTreeData:n,afterFullData:d,tableFullData:i,fullDataRowIdData:c,fullAllDataRowIdData:s}=F,u=S.value,{transform:v,rowField:g,mapChildrenField:w}=u,f=u.children||u.childrenField,p=(_xeUtils.default.isArray(t)||(t=[t]),(0,_vue.reactive)(E.defineField(t.map(e=>Object.assign(a&&v?{[w]:[],[f]:[]}:{},e)))));if(_xeUtils.default.eqNull(l))a&&v?A(p,!1):(d.unshift(...p),i.unshift(...p),e.forEach(e=>{var t=e["row"];0<t&&(e.row=t+p.length)}));else if(-1===l)a&&v?A(p,!0):(d.push(...p),i.push(...p),e.forEach(e=>{var{row:t,rowspan:l}=e;t+l>d.length&&(e.rowspan=l+p.length)}));else if(a&&v){const R=_xeUtils.default.findTree(n,e=>l[g]===e[g],{children:w});if(R){const h=R["parent"],_=h?h[w]:n;t=s[(0,_util.getRowid)(E,h)];const C=t?t.level:0;if(p.forEach((e,t)=>{var l=(0,_util.getRowid)(E,e);"development"===process.env.NODE_ENV&&e[u.parentField]&&h&&e[u.parentField]!==h[g]&&(0,_log.errLog)("vxe.error.errProp",[u.parentField+"="+e[u.parentField],u.parentField+"="+h[g]]),h&&(e[u.parentField]=h[g]);let r=R.index+t;o&&(r+=1),_.splice(r,0,e);t={row:e,rowid:l,seq:-1,index:-1,_index:-1,$index:-1,items:_,parent:h,level:C+1};c[l]=t,s[l]=t}),h){t=_xeUtils.default.findTree(n,e=>l[g]===e[g],{children:f});if(t){var m=t.items;let e=t.index;o&&(e+=1),m.splice(e,0,...p)}}}else"development"===process.env.NODE_ENV&&(0,_log.warnLog)("vxe.error.unableInsert"),A(p,!0)}else{if(a)throw new Error((0,_log.getLog)("vxe.error.noTree",["insert"]));let r=-1;if(_xeUtils.default.isNumber(l)?l<d.length&&(r=l):r=E.findRowIndexOf(d,l),-1===(r=o?Math.min(d.length,r+1):r))throw new Error((0,_log.errLog)("vxe.error.unableInsert"));d.splice(r,0,...p),i.splice(E.findRowIndexOf(i,l),0,...p),e.forEach(e=>{var{row:t,rowspan:l}=e;t>r?e.row=t+p.length:t+l>r&&(e.rowspan=l+p.length)})}const x=r["insertMaps"];return p.forEach(e=>{var t=(0,_util.getRowid)(E,e);x[t]=e}),E.cacheRowMap(),E.updateScrollYStatus(),E.handleTableData(a&&v),a&&v||E.updateAfterDataIndex(),E.updateFooter(),E.checkSelectionStatus(),I.scrollYLoad&&E.updateScrollYSpace(),(0,_vue.nextTick)().then(()=>(E.updateCellAreas(),E.recalculate())).then(()=>({row:p.length?p[p.length-1]:null,rows:p}))};return R={insert(e){return r(e,null)},insertAt(e,t){return r(e,t)},insertNextAt(e,t){return r(e,t,!0)},remove(e){var t=b["treeConfig"];const{mergeList:l,editStore:r,selectCheckboxMaps:o}=I,{tableFullTreeData:a,afterFullData:n,tableFullData:d}=F;var i=x.value,c=S.value;const{transform:s,mapChildrenField:u}=c,v=c.children||c.childrenField,{actived:g,removeMaps:w,insertMaps:f}=r;c=i.checkField;let p=[];if(e?_xeUtils.default.isArray(e)||(e=[e]):e=d,e.forEach(e=>{var t;E.isInsertByRow(e)||(t=(0,_util.getRowid)(E,e),w[t]=e)}),!c){const m=Object.assign({},o);e.forEach(e=>{e=(0,_util.getRowid)(E,e);m[e]&&delete m[e]}),I.selectCheckboxMaps=m}return d===e?(e=p=d.slice(0),F.tableFullData=[],F.afterFullData=[],E.clearMergeCells()):t&&s?e.forEach(e=>{const t=(0,_util.getRowid)(E,e);var l=_xeUtils.default.findTree(a,e=>t===(0,_util.getRowid)(E,e),{children:u}),l=(l&&(l=l.items.splice(l.index,1),p.push(l[0])),_xeUtils.default.findTree(a,e=>t===(0,_util.getRowid)(E,e),{children:v})),l=(l&&l.items.splice(l.index,1),E.findRowIndexOf(n,e));-1<l&&n.splice(l,1)}):e.forEach(e=>{var t=E.findRowIndexOf(d,e);-1<t&&(t=d.splice(t,1),p.push(t[0]));const r=E.findRowIndexOf(n,e);-1<r&&(l.forEach(e=>{var{row:t,rowspan:l}=e;t>r?e.row=t-1:t+l>r&&(e.rowspan=l-1)}),n.splice(r,1))}),g.row&&-1<E.findRowIndexOf(e,g.row)&&R.clearEdit(),e.forEach(e=>{e=(0,_util.getRowid)(E,e);f[e]&&delete f[e]}),E.updateFooter(),E.cacheRowMap(),E.handleTableData(t&&s),t&&s||E.updateAfterDataIndex(),E.checkSelectionStatus(),I.scrollYLoad&&E.updateScrollYSpace(),(0,_vue.nextTick)().then(()=>(E.updateCellAreas(),E.recalculate())).then(()=>({row:p.length?p[p.length-1]:null,rows:p}))},removeCheckboxRow(){return R.remove(E.getCheckboxRecords()).then(e=>(E.clearCheckboxRow(),e))},removeRadioRow(){var e=E.getRadioRecord();return R.remove(e||[]).then(e=>(E.clearRadioRow(),e))},removeCurrentRow(){var e=E.getCurrentRecord();return R.remove(e||[]).then(e=>(E.clearCurrentRow(),e))},getRecordset(){return{insertRecords:R.getInsertRecords(),removeRecords:R.getRemoveRecords(),updateRecords:R.getUpdateRecords(),pendingRecords:E.getPendingRecords()}},getInsertRecords(){var e=I["editStore"];const l=F["fullAllDataRowIdData"];e=e.insertMaps;const r=[];return _xeUtils.default.each(e,(e,t)=>{l[t]&&r.push(e)}),r},getRemoveRecords(){var e=I["editStore"],e=e["removeMaps"];const t=[];return _xeUtils.default.each(e,e=>{t.push(e)}),t},getUpdateRecords(){var{keepSource:e,treeConfig:t}=b,l=F["tableFullData"],r=S.value;return e?(n(),t?_xeUtils.default.filterTree(l,e=>E.isUpdateByRow(e),r):l.filter(e=>E.isUpdateByRow(e))):[]},getActiveRecord(){return"development"===process.env.NODE_ENV&&(0,_log.warnLog)("vxe.error.delFunc",["getActiveRecord","getEditRecord"]),this.getEditRecord()},getEditRecord(){var e=I["editStore"],t=F["afterFullData"],l=o.value,{args:e,row:r}=e.actived;return e&&-1<E.findRowIndexOf(t,r)&&l.querySelectorAll(".vxe-body--column.col--active").length?Object.assign({},e):null},getSelectedCell(){var e=I["editStore"],{args:e,column:t}=e.selected;return e&&t?Object.assign({},e):null},clearActived(e){return"development"===process.env.NODE_ENV&&(0,_log.warnLog)("vxe.error.delFunc",["clearActived","clearEdit"]),this.clearEdit(e)},clearEdit(e){var t=I["editStore"],{actived:t,focused:l}=t,{row:r,column:o}=t;return(r||o)&&(n(),t.args=null,t.row=null,t.column=null,E.updateFooter(),E.dispatchEvent("edit-closed",{row:r,rowIndex:E.getRowIndex(r),$rowIndex:E.getVMRowIndex(r),column:o,columnIndex:E.getColumnIndex(o),$columnIndex:E.getVMColumnIndex(o)},e||null)),"obsolete"===_conf.default.cellVaildMode&&E.clearValidate?E.clearValidate():(l.row=null,(l.column=null,_vue.nextTick)())},clearSelected(){var e=I["editStore"],e=e["selected"];return e.row=null,e.column=null,l(),(0,_vue.nextTick)()},isActiveByRow(e){return"development"===process.env.NODE_ENV&&(0,_log.warnLog)("vxe.error.delFunc",["isActiveByRow","isEditByRow"]),this.isEditByRow(e)},isEditByRow(e){var t=I["editStore"];return t.actived.row===e},setActiveRow(e){return"development"===process.env.NODE_ENV&&(0,_log.warnLog)("vxe.error.delFunc",["setActiveRow","setEditRow"]),R.setEditRow(e)},setEditRow(e,t){var l=F["visibleColumn"];let r=_xeUtils.default.find(l,e=>(0,_utils.isEnableConf)(e.editRender));return t&&(r=_xeUtils.default.isString(t)?E.getColumnByField(t):t),E.setEditCell(e,r)},setActiveCell(e,t){return"development"===process.env.NODE_ENV&&(0,_log.warnLog)("vxe.error.delFunc",["setActiveCell","setEditCell"]),R.setEditCell(e,t)},setEditCell(t,e){var l=b["editConfig"];const r=_xeUtils.default.isString(e)?E.getColumnByField(e):e;return t&&r&&(0,_utils.isEnableConf)(l)&&(0,_utils.isEnableConf)(r.editRender)?E.scrollToRow(t,r).then(()=>{var e=E.getCell(t,r);return e&&(p.handleActived({row:t,rowIndex:E.getRowIndex(t),column:r,columnIndex:E.getColumnIndex(r),cell:e,$table:E}),F._lastCallTime=Date.now()),(0,_vue.nextTick)()}):(0,_vue.nextTick)()},setSelectCell(e,t){var l=I["tableData"],r=f.value,t=_xeUtils.default.isString(t)?E.getColumnByField(t):t;return e&&t&&"manual"!==r.trigger&&-1<(r=E.findRowIndexOf(l,e))&&t&&(l=E.getCell(e,t),e={row:e,rowIndex:r,column:t,columnIndex:E.getColumnIndex(t),cell:l},E.handleSelected(e,{})),(0,_vue.nextTick)()}},p={handleActived(t,l){var{editConfig:e,mouseConfig:r}=b,{editStore:o,tableColumn:a}=I,n=f.value,d=n["mode"],{actived:o,focused:i}=o;const{row:c,column:s}=t;var u=s["editRender"],v=t.cell||E.getCell(c,s),g=n.beforeEditMethod||n.activeMethod;if((t.cell=v)&&(0,_utils.isEnableConf)(e)&&(0,_utils.isEnableConf)(u)&&!E.hasPendingByRow(c)){if(o.row!==c||"cell"===d&&o.column!==s){let e="edit-disabled";if(!g||g(Object.assign(Object.assign({},t),{$table:E,$grid:E.xegrid}))){r&&(R.clearSelected(),E.clearCellAreas)&&(E.clearCellAreas(),E.clearCopyCellArea()),E.closeTooltip(),o.column&&R.clearEdit(l),e="edit-activated",s.renderHeight=v.offsetHeight,o.args=t,o.row=c,o.column=s,"row"===d?a.forEach(e=>m(c,e)):m(c,s);const w=n.afterEditMethod;(0,_vue.nextTick)(()=>{p.handleFocus(t,l),w&&w(Object.assign(Object.assign({},t),{$table:E,$grid:E.xegrid}))})}E.dispatchEvent(e,{row:c,rowIndex:E.getRowIndex(c),$rowIndex:E.getVMRowIndex(c),column:s,columnIndex:E.getColumnIndex(s),$columnIndex:E.getVMColumnIndex(s)},l),"edit-activated"===e&&E.dispatchEvent("edit-actived",{row:c,rowIndex:E.getRowIndex(c),$rowIndex:E.getVMRowIndex(c),column:s,columnIndex:E.getColumnIndex(s),$columnIndex:E.getVMColumnIndex(s)},l)}else{e=o["column"];r&&(R.clearSelected(),E.clearCellAreas)&&(E.clearCellAreas(),E.clearCopyCellArea()),e!==s&&(u=e["model"],u.update&&(0,_util.setCellValue)(c,e,u.value),E.clearValidate)&&E.clearValidate(c,s),s.renderHeight=v.offsetHeight,o.args=t,o.column=s,setTimeout(()=>{p.handleFocus(t,l)})}i.column=null,i.row=null,E.focus()}return(0,_vue.nextTick)()},handleFocus(r){var{row:o,column:a,cell:n}=r,d=a["editRender"];if((0,_utils.isEnableConf)(d)){var i=_vXETable.renderer.get(d.name);let{autofocus:e,autoselect:t}=d,l;!e&&i&&(e=i.autofocus),!t&&i&&(t=i.autoselect),_xeUtils.default.isFunction(e)?l=e.call(this,r):e&&(l=n.querySelector(e))&&l.focus(),l?t?l.select():_dom.browse.msie&&((d=l.createTextRange()).collapse(!1),d.select()):E.scrollToRow(o,a)}},handleSelected(e,t){var l=b["mouseConfig"],r=I["editStore"],o=u.value;const a=f.value,{actived:n,selected:d}=r,{row:i,column:c}=e,s=l&&o.selected;return!s||d.row===i&&d.column===c||(n.row!==i||"cell"===a.mode&&n.column!==c)&&(R.clearEdit(t),R.clearSelected(),E.clearCellAreas&&(E.clearCellAreas(),E.clearCopyCellArea()),d.args=e,d.row=i,d.column=c,s&&p.addCellSelectedClass(),E.focus(),t)&&E.dispatchEvent("cell-selected",e,t),(0,_vue.nextTick)()},addCellSelectedClass(){var e=I["editStore"],e=e["selected"],{row:e,column:t}=e;l(),e&&t&&(e=E.getCell(e,t))&&(0,_dom.addClass)(e,"col--selected")}},Object.assign(Object.assign({},R),p)},setupGrid(e){return e.extendTableMethods(tableEditMethodKeys)}};var _default=exports.default=editHook;