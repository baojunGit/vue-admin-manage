"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_vXETable=require("../../v-x-e-table"),_util=require("../../table/src/util"),_utils=require("../../tools/utils"),_log=require("../../tools/log"),_util2=require("./util");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}let htmlCellElem;const csvBOM="\ufeff",enterSymbol="\r\n";function defaultFilterExportColumn(e){return e.property||-1<["seq","checkbox","radio"].indexOf(e.type)}const getConvertColumns=e=>{const t=[];return e.forEach(e=>{e.childNodes&&e.childNodes.length?(t.push(e),t.push(...getConvertColumns(e.childNodes))):t.push(e)}),t},convertToRows=e=>{let t=1;const o=(l,e)=>{if(e&&(l._level=e._level+1,t<l._level)&&(t=l._level),l.childNodes&&l.childNodes.length){let t=0;l.childNodes.forEach(e=>{o(e,l),t+=e._colSpan}),l._colSpan=t}else l._colSpan=1},l=(e.forEach(e=>{e._level=1,o(e)}),[]);for(let e=0;e<t;e++)l.push([]);return getConvertColumns(e).forEach(e=>{e.childNodes&&e.childNodes.length?e._rowSpan=1:e._rowSpan=t-e._level+1,l[e._level-1].push(e)}),l};function toTableBorder(e){return!0===e?"full":e||"default"}function getBooleanValue(e){return"TRUE"===e||"true"===e||!0===e}function getFooterData(e,t){const l=e["footerFilterMethod"];return l?t.filter((e,t)=>l({items:e,$rowIndex:t})):t}function getCsvCellTypeLabel(e,t){if(t){if("seq"===e.type)return`	`+t;switch(e.cellType){case"string":if(isNaN(t))break;return`	`+t;case"number":break;default:if(12<=t.length&&!isNaN(t))return`	`+t}}return t}function toTxtCellLabel(e){return/[",\s\n]/.test(e)?`"${e.replace(/"/g,'""')}"`:e}function getElementsByTagName(e,t){return e.getElementsByTagName(t)}function getTxtCellKey(e){return`#${e}@`+_xeUtils.default.uniqueId()}function replaceTxtCell(e,t){return e.replace(/#\d+@\d+/g,e=>_xeUtils.default.hasOwnProp(t,e)?t[e]:e)}function getTxtCellValue(e,t){return replaceTxtCell(e,t).replace(/^"+$/g,e=>'"'.repeat(Math.ceil(e.length/2)))}function parseCsvAndTxt(e,t,o){t=t.split(enterSymbol);const r=[];let a=[];if(t.length){const n={},s=Date.now();t.forEach(e=>{if(e){const l={};e=(e=e.replace(/("")|(\n)/g,(e,t)=>{var l=getTxtCellKey(s);return n[l]=t?'"':"\n",l}).replace(/"(.*?)"/g,(e,t)=>{var l=getTxtCellKey(s);return n[l]=replaceTxtCell(t,n),l})).split(o);a.length?(e.forEach((e,t)=>{t<a.length&&(l[a[t]]=getTxtCellValue(e.trim(),n))}),r.push(l)):a=e.map(e=>getTxtCellValue(e.trim(),n))}})}return{fields:a,rows:r}}function parseCsv(e,t){return parseCsvAndTxt(e,t,",")}function parseTxt(e,t){return parseCsvAndTxt(e,t,"\t")}function parseHTML(e,t){var l,t=getElementsByTagName((new DOMParser).parseFromString(t,"text/html"),"body");const o=[],r=[];return t.length&&(t=getElementsByTagName(t[0],"table")).length&&(l=getElementsByTagName(t[0],"thead")).length&&(_xeUtils.default.arrayEach(getElementsByTagName(l[0],"tr"),e=>{_xeUtils.default.arrayEach(getElementsByTagName(e,"th"),e=>{r.push(e.textContent)})}),(l=getElementsByTagName(t[0],"tbody")).length)&&_xeUtils.default.arrayEach(getElementsByTagName(l[0],"tr"),e=>{const l={};_xeUtils.default.arrayEach(getElementsByTagName(e,"td"),(e,t)=>{r[t]&&(l[r[t]]=e.textContent||"")}),o.push(l)}),{fields:r,rows:o}}function parseXML(e,t){var t=getElementsByTagName((new DOMParser).parseFromString(t,"application/xml"),"Worksheet");const o=[],r=[];return t.length&&(t=getElementsByTagName(t[0],"Table")).length&&(t=getElementsByTagName(t[0],"Row")).length&&(_xeUtils.default.arrayEach(getElementsByTagName(t[0],"Cell"),e=>{r.push(e.textContent)}),_xeUtils.default.arrayEach(t,(e,t)=>{if(t){const l={};t=getElementsByTagName(e,"Cell");_xeUtils.default.arrayEach(t,(e,t)=>{r[t]&&(l[r[t]]=e.textContent)}),o.push(l)}})),{fields:r,rows:o}}function clearColumnConvert(e){_xeUtils.default.eachTree(e,e=>{delete e._level,delete e._colSpan,delete e._rowSpan,delete e._children,delete e.childNodes},{children:"children"})}function checkImportData(e,t){const l=[];return e.forEach(e=>{e=e.property;e&&l.push(e)}),t.some(e=>-1<l.indexOf(e))}const tableExportMethodKeys=["exportData","importByFile","importData","saveFile","readFile","print","openImport","openExport","openPrint"],tableExportHook={setupTable(E){const{props:w,reactData:C,internalData:_}=E,{computeTreeOpts:k,computePrintOpts:o,computeExportOpts:y,computeImportOpts:s,computeCustomOpts:v,computeSeqOpts:a,computeRadioOpts:n,computeCheckboxOpts:i,computeColumnOpts:d}=E.getComputeMaps(),$=(0,_vue.inject)("$xegrid",null),x=(e,t,l,o)=>{var r=a.value.seqMethod||l.seqMethod;return r?r({row:e,rowIndex:E.getRowIndex(e),$rowIndex:t,column:l,columnIndex:E.getColumnIndex(l),$columnIndex:o}):E.getRowSeq(e)};function M(e,t){var l=d.value,l=t.headerExportMethod||l.headerExportMethod;return l?l({column:t,options:e,$table:E}):(e.original?t.property:t.getTitle())||""}const b=e=>_xeUtils.default.isBoolean(e)?e?"TRUE":"FALSE":e,c=(c,r,e)=>{const{isAllExpand:a,mode:p}=c;var t=w["treeConfig"];const u=n.value,h=i.value;var l=k.value;const m=d.value;if(htmlCellElem=htmlCellElem||document.createElement("div"),t){t=l.children||l.childrenField;const f=[],g=new Map;return _xeUtils.default.eachTree(e,(n,s,e,i,t,l)=>{const d=n._row||n;var o,n=t&&t._row?t._row:t;if(a||!n||g.has(n)&&E.isTreeExpandByRow(n)){t=d,o=(o=k.value).children||o.childrenField;t=t[o]&&t[o].length;const n={_row:d,_level:l.length-1,_hasChild:t,_expand:t&&E.isTreeExpandByRow(d)};r.forEach((e,t)=>{let l="";var o,r=e.editRender||e.cellRender;let a=e.exportMethod;if(a=(a=!a&&r&&r.name&&(r=_vXETable.VXETable.renderer.get(r.name))?r.exportMethod:a)||m.exportMethod)l=a({$table:E,row:d,column:e,options:c});else switch(e.type){case"seq":l="all"===p?i.map((e,t)=>t%2==0?Number(e)+1:".").join(""):x(d,s,e,t);break;case"checkbox":l=b(E.isCheckedByCheckboxRow(d)),n._checkboxLabel=h.labelField?_xeUtils.default.get(d,h.labelField):"",n._checkboxDisabled=h.checkMethod&&!h.checkMethod({row:d});break;case"radio":l=b(E.isCheckedByRadioRow(d)),n._radioLabel=u.labelField?_xeUtils.default.get(d,u.labelField):"",n._radioDisabled=u.checkMethod&&!u.checkMethod({row:d});break;default:c.original?l=(0,_util.getCellValue)(d,e):(l=E.getCellLabel(d,e),"html"===e.type?(htmlCellElem.innerHTML=l,l=htmlCellElem.innerText.trim()):(o=E.getCell(d,e))&&(l=o.innerText.trim()))}n[e.id]=_xeUtils.default.toValueString(l)}),g.set(d,1),f.push(Object.assign(n,d))}},{children:t}),f}return e.map((n,s)=>{const i={_row:n};return r.forEach((e,t)=>{let l="";var o,r=e.editRender||e.cellRender;let a=e.exportMethod;if(a=!a&&r&&r.name&&(r=_vXETable.VXETable.renderer.get(r.name))?r.exportMethod:a)l=a({$table:E,row:n,column:e,options:c});else switch(e.type){case"seq":l="all"===p?s+1:x(n,s,e,t);break;case"checkbox":l=b(E.isCheckedByCheckboxRow(n)),i._checkboxLabel=h.labelField?_xeUtils.default.get(n,h.labelField):"",i._checkboxDisabled=h.checkMethod&&!h.checkMethod({row:n});break;case"radio":l=b(E.isCheckedByRadioRow(n)),i._radioLabel=u.labelField?_xeUtils.default.get(n,u.labelField):"",i._radioDisabled=u.checkMethod&&!u.checkMethod({row:n});break;default:c.original?l=(0,_util.getCellValue)(n,e):(l=E.getCellLabel(n,e),"html"===e.type?(htmlCellElem.innerHTML=l,l=htmlCellElem.innerText.trim()):(o=E.getCell(n,e))&&(l=o.innerText.trim()))}i[e.id]=_xeUtils.default.toValueString(l)}),i})},N=(e,t,l)=>{var o=d.value,r=l.editRender||l.cellRender;let a=l.footerExportMethod;a=(a=!a&&r&&r.name&&(r=_vXETable.VXETable.renderer.get(r.name))?r.footerExportMethod:a)||o.footerExportMethod;r=E.getVTColumnIndex(l);return a?a({$table:E,items:t,itemIndex:r,row:t,_columnIndex:r,column:l,options:e}):_xeUtils.default.toValueString(t[r])},p=(l,e,t)=>{let o=csvBOM;return l.isHeader&&(o+=e.map(e=>toTxtCellLabel(M(l,e))).join(",")+enterSymbol),t.forEach(t=>{o+=e.map(e=>toTxtCellLabel(getCsvCellTypeLabel(e,t[e.id]))).join(",")+enterSymbol}),l.isFooter&&(t=C["footerTableData"],getFooterData(l,t).forEach(t=>{o+=e.map(e=>toTxtCellLabel(N(l,t,e))).join(",")+enterSymbol})),o},u=(l,e,t)=>{let o="";return l.isHeader&&(o+=e.map(e=>toTxtCellLabel(M(l,e))).join("\t")+enterSymbol),t.forEach(t=>{o+=e.map(e=>toTxtCellLabel(t[e.id])).join("\t")+enterSymbol}),l.isFooter&&(t=C["footerTableData"],getFooterData(l,t).forEach(t=>{o+=e.map(e=>toTxtCellLabel(N(l,t,e))).join(",")+enterSymbol})),o},j=(e,t,l)=>{e=e[t],t=_xeUtils.default.isUndefined(e)||_xeUtils.default.isNull(e)?l:e;let o="title"===t||(!0===t||"tooltip"===t)||"ellipsis"===t;var{scrollXLoad:l,scrollYLoad:e}=C;return o=l||e?o||!0:o},h=(s,e,t)=>{const{id:d,border:l,treeConfig:o,headerAlign:i,align:c,footerAlign:a,showOverflow:p,showHeaderOverflow:u}=w,{isAllSelected:h,isIndeterminate:r,mergeList:m}=C,n=k.value,{print:f,isHeader:g,isFooter:v,isColgroup:x,isMerge:b,colgroups:_,original:y}=s,$="check-all";const T=[`<table class="${["vxe-table","border--"+toTableBorder(l),f?"is--print":"",g?"is--header":""].filter(e=>e).join(" ")}" border="0" cellspacing="0" cellpadding="0">`,`<colgroup>${e.map(e=>`<col style="width:${e.renderWidth}px">`).join("")}</colgroup>`];g&&(T.push("<thead>"),x&&!y?_.forEach(e=>{T.push(`<tr>${e.map(t=>{var e=t.headerAlign||t.align||i||c,l=j(t,"showHeaderOverflow",u)?["col--ellipsis"]:[],o=M(s,t);let r=0,a=0;_xeUtils.default.eachTree([t],e=>{e.childNodes&&t.childNodes.length||a++,r+=e.renderWidth},{children:"childNodes"});var n=r-a;return e&&l.push("col--"+e),"checkbox"===t.type?`<th class="${l.join(" ")}" colspan="${t._colSpan}" rowspan="${t._rowSpan}"><div ${f?"":`style="width: ${n}px"`}><input type="checkbox" class="${$}" ${h?"checked":""}><span>${o}</span></div></th>`:`<th class="${l.join(" ")}" colspan="${t._colSpan}" rowspan="${t._rowSpan}" title="${o}"><div ${f?"":`style="width: ${n}px"`}><span>${(0,_utils.formatText)(o,!0)}</span></div></th>`}).join("")}</tr>`)}):T.push(`<tr>${e.map(e=>{var t=e.headerAlign||e.align||i||c,l=j(e,"showHeaderOverflow",u)?["col--ellipsis"]:[],o=M(s,e);return t&&l.push("col--"+t),"checkbox"===e.type?`<th class="${l.join(" ")}"><div ${f?"":`style="width: ${e.renderWidth}px"`}><input type="checkbox" class="${$}" ${h?"checked":""}><span>${o}</span></div></th>`:`<th class="${l.join(" ")}" title="${o}"><div ${f?"":`style="width: ${e.renderWidth}px"`}><span>${(0,_utils.formatText)(o,!0)}</span></div></th>`}).join("")}</tr>`),T.push("</thead>")),t.length&&(T.push("<tbody>"),o?t.forEach(r=>{T.push("<tr>"+e.map(t=>{var e=t.align||c,l=j(t,"showOverflow",p)?["col--ellipsis"]:[],o=r[t.id];if(e&&l.push("col--"+e),t.treeNode){let e="";return r._hasChild&&(e=`<i class="${r._expand?"vxe-table--tree-fold-icon":"vxe-table--tree-unfold-icon"}"></i>`),l.push("vxe-table--tree-node"),"radio"===t.type?`<td class="${l.join(" ")}" title="${o}"><div ${f?"":`style="width: ${t.renderWidth}px"`}><div class="vxe-table--tree-node-wrapper" style="padding-left: ${r._level*n.indent}px"><div class="vxe-table--tree-icon-wrapper">${e}</div><div class="vxe-table--tree-cell"><input type="radio" name="radio_${d}" ${r._radioDisabled?"disabled ":""}${getBooleanValue(o)?"checked":""}><span>${r._radioLabel}</span></div></div></div></td>`:"checkbox"===t.type?`<td class="${l.join(" ")}" title="${o}"><div ${f?"":`style="width: ${t.renderWidth}px"`}><div class="vxe-table--tree-node-wrapper" style="padding-left: ${r._level*n.indent}px"><div class="vxe-table--tree-icon-wrapper">${e}</div><div class="vxe-table--tree-cell"><input type="checkbox" ${r._checkboxDisabled?"disabled ":""}${getBooleanValue(o)?"checked":""}><span>${r._checkboxLabel}</span></div></div></div></td>`:`<td class="${l.join(" ")}" title="${o}"><div ${f?"":`style="width: ${t.renderWidth}px"`}><div class="vxe-table--tree-node-wrapper" style="padding-left: ${r._level*n.indent}px"><div class="vxe-table--tree-icon-wrapper">${e}</div><div class="vxe-table--tree-cell">${o}</div></div></div></td>`}return"radio"===t.type?`<td class="${l.join(" ")}"><div ${f?"":`style="width: ${t.renderWidth}px"`}><input type="radio" name="radio_${d}" ${r._radioDisabled?"disabled ":""}${getBooleanValue(o)?"checked":""}><span>${r._radioLabel}</span></div></td>`:"checkbox"===t.type?`<td class="${l.join(" ")}"><div ${f?"":`style="width: ${t.renderWidth}px"`}><input type="checkbox" ${r._checkboxDisabled?"disabled ":""}${getBooleanValue(o)?"checked":""}><span>${r._checkboxLabel}</span></div></td>`:`<td class="${l.join(" ")}" title="${o}"><div ${f?"":`style="width: ${t.renderWidth}px"`}>${(0,_utils.formatText)(o,!0)}</div></td>`}).join("")+"</tr>")}):t.forEach(i=>{T.push("<tr>"+e.map(e=>{var t=e.align||c,l=j(e,"showOverflow",p)?["col--ellipsis"]:[],o=i[e.id];let r=1,a=1;if(b&&m.length){var n=E.getVTRowIndex(i._row),s=E.getVTColumnIndex(e),n=(0,_util.mergeBodyMethod)(m,n,s);if(n){var{rowspan:s,colspan:n}=n;if(!s||!n)return"";1<s&&(r=s),1<n&&(a=n)}}return t&&l.push("col--"+t),"radio"===e.type?`<td class="${l.join(" ")}" rowspan="${r}" colspan="${a}"><div ${f?"":`style="width: ${e.renderWidth}px"`}><input type="radio" name="radio_${d}" ${i._radioDisabled?"disabled ":""}${getBooleanValue(o)?"checked":""}><span>${i._radioLabel}</span></div></td>`:"checkbox"===e.type?`<td class="${l.join(" ")}" rowspan="${r}" colspan="${a}"><div ${f?"":`style="width: ${e.renderWidth}px"`}><input type="checkbox" ${i._checkboxDisabled?"disabled ":""}${getBooleanValue(o)?"checked":""}><span>${i._checkboxLabel}</span></div></td>`:`<td class="${l.join(" ")}" rowspan="${r}" colspan="${a}" title="${o}"><div ${f?"":`style="width: ${e.renderWidth}px"`}>${(0,_utils.formatText)(o,!0)}</div></td>`}).join("")+"</tr>")}),T.push("</tbody>")),v&&(t=C["footerTableData"],(t=getFooterData(s,t)).length)&&(T.push("<tfoot>"),t.forEach(r=>{T.push(`<tr>${e.map(e=>{var t=e.footerAlign||e.align||a||c,l=j(e,"showOverflow",p)?["col--ellipsis"]:[],o=N(s,r,e);return t&&l.push("col--"+t),`<td class="${l.join(" ")}" title="${o}"><div ${f?"":`style="width: ${e.renderWidth}px"`}>${(0,_utils.formatText)(o,!0)}</div></td>`}).join("")}</tr>`)}),T.push("</tfoot>"));t=!h&&r?`<script>(function(){var a=document.querySelector(".${$}");if(a){a.indeterminate=true}})()</script>`:"";return T.push("</table>",t),f?T.join(""):(0,_util2.createHtmlPage)(s,T.join(""))},m=(l,e,t)=>{let o=['<?xml version="1.0"?>','<?mso-application progid="Excel.Sheet"?>','<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:html="http://www.w3.org/TR/REC-html40">','<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">',"<Version>16.00</Version>","</DocumentProperties>",'<ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel">',"<WindowHeight>7920</WindowHeight>","<WindowWidth>21570</WindowWidth>","<WindowTopX>32767</WindowTopX>","<WindowTopY>32767</WindowTopY>","<ProtectStructure>False</ProtectStructure>","<ProtectWindows>False</ProtectWindows>","</ExcelWorkbook>",`<Worksheet ss:Name="${l.sheetName}">`,"<Table>",e.map(e=>`<Column ss:Width="${e.renderWidth}"/>`).join("")].join("");return l.isHeader&&(o+=`<Row>${e.map(e=>`<Cell><Data ss:Type="String">${M(l,e)}</Data></Cell>`).join("")}</Row>`),t.forEach(t=>{o+="<Row>"+e.map(e=>`<Cell><Data ss:Type="String">${t[e.id]}</Data></Cell>`).join("")+"</Row>"}),l.isFooter&&(t=C["footerTableData"],getFooterData(l,t).forEach(t=>{o+=`<Row>${e.map(e=>`<Cell><Data ss:Type="String">${N(l,t,e)}</Data></Cell>`).join("")}</Row>`})),o+"</Table></Worksheet></Workbook>"},T=n=>{const{remote:l,columns:s,colgroups:o,exportMethod:r,afterExportMethod:t}=n;return new Promise(e=>{if(l){var t={options:n,$table:E,$grid:$};e(r?r(t):t)}else{const a=(e=>{const{columns:t,dataFilterMethod:l}=e;let o=e.data;return l&&(o=o.filter((e,t)=>l({row:e,$rowIndex:t}))),c(e,t,o)})(n);e(E.preventEvent(null,"event.export",{options:n,columns:s,colgroups:o,datas:a},()=>{var e=n,t=((e,t,l)=>{if(t.length)switch(e.type){case"csv":return p(e,t,l);case"txt":return u(e,t,l);case"html":return h(e,t,l);case"xml":return m(e,t,l)}return""})(n,s,a),{filename:l,type:o,download:r}=e;if(!r)return r=(0,_util2.getExportBlobByContent)(t,e),Promise.resolve({type:o,content:t,blob:r});(0,_util2.saveLocalFile)({filename:l,type:o,content:t}).then(()=>{!1!==e.message&&("development"!==process.env.NODE_ENV||_vXETable.VXETable.modal||(0,_log.errLog)("vxe.error.reqModule",["Modal"]),_vXETable.VXETable.modal.message({content:_conf.default.i18n("vxe.table.expSuccess"),status:"success"}))})}))}}).then(e=>(clearColumnConvert(s),n.print||t&&t({status:!0,options:n,$table:E,$grid:$}),Object.assign({status:!0},e))).catch(()=>{clearColumnConvert(s),n.print||t&&t({status:!1,options:n,$table:E,$grid:$});return Promise.reject({status:!1})})},f=(a,n)=>{const{importMethod:s,afterImportMethod:t}=n,{type:i,filename:c}=(0,_utils.parseFile)(a);return s||_xeUtils.default.includes(_vXETable.VXETable.globalConfs.importTypes,i)?new Promise((t,l)=>{const e=e=>{t(e),_._importResolve=null,_._importReject=null},o=e=>{l(e),_._importResolve=null,_._importReject=null};if(_._importResolve=e,_._importReject=o,window.FileReader){const d=Object.assign({mode:"insert"},n,{type:i,filename:c});var r;d.remote?s?Promise.resolve(s({file:a,options:d,$table:E})).then(()=>{e({status:!0})}).catch(()=>{e({status:!0})}):e({status:!0}):(r=_["tableFullColumn"],E.preventEvent(null,"event.import",{file:a,options:d,columns:r},()=>{var e=new FileReader;e.onerror=()=>{(0,_log.errLog)("vxe.error.notType",[i]),o({status:!1})},e.onload=t=>{{var l=t.target.result,o=d;const{tableFullColumn:r,_importResolve:a,_importReject:n}=_;let e={fields:[],rows:[]};switch(o.type){case"csv":e=parseCsv(r,l);break;case"txt":e=parseTxt(r,l);break;case"html":e=parseHTML(r,l);break;case"xml":e=parseXML(r,l)}const{fields:s,rows:i}=e;checkImportData(r,s)?E.createData(i).then(e=>{let t;return t="insert"===o.mode?E.insert(e):E.reloadData(e),!1!==o.message&&("development"!==process.env.NODE_ENV||_vXETable.VXETable.modal||(0,_log.errLog)("vxe.error.reqModule",["Modal"]),_vXETable.VXETable.modal.message({content:_conf.default.i18n("vxe.table.impSuccess",[i.length]),status:"success"})),t.then(()=>{a&&a({status:!0})})}):!1!==o.message&&("development"!==process.env.NODE_ENV||_vXETable.VXETable.modal||(0,_log.errLog)("vxe.error.reqModule",["Modal"]),_vXETable.VXETable.modal.message({content:_conf.default.i18n("vxe.error.impFields"),status:"error"}),n)&&n({status:!1})}},e.readAsText(a,d.encoding||"UTF-8")}))}else"development"===process.env.NODE_ENV&&(0,_log.errLog)("vxe.error.notExp"),e({status:!0})}).then(()=>{t&&t({status:!0,options:n,$table:E})}).catch(e=>(t&&t({status:!1,options:n,$table:E}),Promise.reject(e))):(!1!==n.message&&("development"!==process.env.NODE_ENV||_vXETable.VXETable.modal||(0,_log.errLog)("vxe.error.reqModule",["Modal"]),_vXETable.VXETable.modal.message({content:_conf.default.i18n("vxe.error.notType",[i]),status:"error"})),Promise.reject({status:!1}))},l=(e,t)=>{var{treeConfig:l,showHeader:o,showFooter:r}=w,{initStore:a,mergeList:n,isGroup:s,footerTableData:i,exportStore:d,exportParams:c}=C,p=_["collectColumn"],u=v.value,h=E.getCheckboxRecords(),i=!!i.length,n=!l&&n.length,o=Object.assign({message:!0,isHeader:o,isFooter:r},e),r=o.types||_vXETable.VXETable.globalConfs.exportTypes,e=o.modes;const m=u.checkMethod;u=p.slice(0);const f=o["columns"];var p=r.map(e=>({value:e,label:"vxe.export.types."+e})),g=e.map(e=>({value:e,label:"vxe.export.modes."+e}));return _xeUtils.default.eachTree(u,(o,e,t,l,r)=>{(o.children&&o.children.length||defaultFilterExportColumn(o))&&(o.checked=f?f.some(e=>{var t,l;return(0,_util.isColumnInfo)(e)?o===e:_xeUtils.default.isString(e)?o.field===e:(t=e.id||e.colId,l=e.type,e=e.property||e.field,t?o.id===t:e&&l?o.property===e&&o.type===l:e?o.property===e:!!l&&o.type===l)}):o.visible,o.halfChecked=!1,o.disabled=r&&r.disabled||!!m&&!m({column:o}))}),Object.assign(d,{columns:u,typeList:p,modeList:g,hasFooter:i,hasMerge:n,hasTree:l,isPrint:t,hasColgroup:s,visible:!0}),Object.assign(c,{mode:h.length?"selected":"current"},o),-1===e.indexOf(c.mode)&&(c.mode=e[0]),-1===r.indexOf(c.type)&&(c.type=r[0]),a.export=!0,(0,_vue.nextTick)()},r={exportData(e){var t=w["treeConfig"],{isGroup:l,tableGroupColumn:o}=C;const{tableFullColumn:a,afterFullData:r}=_;var n=y.value,s=k.value;const i=Object.assign({isHeader:!0,isFooter:!0,isColgroup:!0,download:!0,type:"csv",mode:"current"},n,{print:!1},e);var{type:n,mode:e,columns:d,original:c,beforeExportMethod:p}=i;let u=[];d=d&&d.length?d:null;let h=i.columnFilterMethod;d||(h=h||(c?({column:e})=>e.property:({column:e})=>defaultFilterExportColumn(e))),u=d?(i._isCustomColumn=!0,_xeUtils.default.searchTree(_xeUtils.default.mapTree(d,e=>{let t;if(e){if((0,_util.isColumnInfo)(e))t=e;else if(_xeUtils.default.isString(e))t=E.getColumnByField(e);else{var l=e.id||e.colId;const o=e.type,r=e.property||e.field;l?t=E.getColumnById(l):r&&o?t=a.find(e=>e.property===r&&e.type===o):r?t=E.getColumnByField(r):o&&(t=a.find(e=>e.type===o))}return t||{}}},{children:"childNodes",mapChildren:"_children"}),(e,t)=>(0,_util.isColumnInfo)(e)&&(!h||h({column:e,$columnIndex:t})),{children:"_children",mapChildren:"childNodes",original:!0})):_xeUtils.default.searchTree(l?o:a,(e,t)=>e.visible&&(!h||h({column:e,$columnIndex:t})),{children:"children",mapChildren:"childNodes",original:!0});const m=[];if(_xeUtils.default.eachTree(u,e=>{e.children&&e.children.length||m.push(e)},{children:"childNodes"}),i.columns=m,i.colgroups=convertToRows(u),i.filename||(i.filename=_conf.default.i18n(i.original?"vxe.table.expOriginFilename":"vxe.table.expFilename",[_xeUtils.default.toDateString(Date.now(),"yyyyMMddHHmmss")])),i.sheetName||(i.sheetName=document.title),!i.exportMethod&&!_xeUtils.default.includes(_vXETable.VXETable.globalConfs.exportTypes,n))return"development"===process.env.NODE_ENV&&(0,_log.errLog)("vxe.error.notType",[n]),Promise.reject({status:!1});if(i.print||p&&p({options:i,$table:E,$grid:$}),!i.data)if(i.data=r,"selected"===e){const f=E.getCheckboxRecords();-1<["html","pdf"].indexOf(n)&&t?i.data=_xeUtils.default.searchTree(E.getTableData().fullData,e=>-1<E.findRowIndexOf(f,e),Object.assign({},s,{data:"_row"})):i.data=f}else if("all"===e&&("development"!==process.env.NODE_ENV||$||(0,_log.warnLog)("vxe.error.errProp",["all","mode=current,selected"]),$)&&!i.remote){c=$["reactData"],d=$.getComputeMaps()["computeProxyOpts"];const{beforeQueryAll:g,afterQueryAll:v,ajax:x={},props:w={}}=d.value;l=x.queryAll;if("development"!==process.env.NODE_ENV||l||(0,_log.warnLog)("vxe.error.notFunc",["proxy-config.ajax.queryAll"]),l){const b={$table:E,$grid:$,sort:c.sortData,filters:c.filterData,form:c.formData,target:l,options:i};return Promise.resolve((g||l)(b)).catch(e=>e).then(e=>(i.data=(w.list?_xeUtils.default.get(e,w.list):e)||[],v&&v(b),T(i)))}}return T(i)},importByFile(e,t){var t=Object.assign({},t),l=t["beforeImportMethod"];return l&&l({options:t,$table:E}),f(e,t)},importData(e){var t=s.value;const l=Object.assign({types:_vXETable.VXETable.globalConfs.importTypes},t,e),{beforeImportMethod:o,afterImportMethod:r}=l;return o&&o({options:l,$table:E}),(0,_util2.readLocalFile)(l).catch(e=>(r&&r({status:!1,options:l,$table:E}),Promise.reject(e))).then(e=>{e=e.file;return f(e,l)})},saveFile(e){return(0,_util2.saveLocalFile)(e)},readFile(e){return(0,_util2.readLocalFile)(e)},print(e){var t=o.value;const l=Object.assign({original:!1},t,e,{type:"html",download:!1,remote:!1,print:!0});return l.sheetName||(l.sheetName=document.title),new Promise(e=>{l.content?e((0,_util2.handlePrint)(E,l,l.content)):e(r.exportData(l).then(({content:e})=>(0,_util2.handlePrint)(E,l,e)))})},openImport(e){var{treeConfig:t,importConfig:l}=w,{initStore:o,importStore:r,importParams:a}=C,n=s.value,e=Object.assign({mode:"insert",message:!0,types:_vXETable.VXETable.globalConfs.importTypes},e,n),n=e["types"];!t?(l||(0,_log.errLog)("vxe.error.reqProp",["import-config"]),t=n.map(e=>({value:e,label:"vxe.export.types."+e})),l=e.modes.map(e=>({value:e,label:"vxe.import.modes."+e})),Object.assign(r,{file:null,type:"",filename:"",modeList:l,typeList:t,visible:!0}),Object.assign(a,e),o.import=!0):e.message&&_vXETable.VXETable.modal.message({content:_conf.default.i18n("vxe.error.treeNotImp"),status:"error"})},openExport(e){var t=y.value;"development"!==process.env.NODE_ENV||w.exportConfig||(0,_log.errLog)("vxe.error.reqProp",["export-config"]),l(Object.assign({},t,e))},openPrint(e){var t=o.value;"development"!==process.env.NODE_ENV||w.printConfig||(0,_log.errLog)("vxe.error.reqProp",["print-config"]),l(Object.assign({},t,e),!0)}};return r},setupGrid(e){return e.extendTableMethods(tableExportMethodKeys)}};var _default=exports.default=tableExportHook;