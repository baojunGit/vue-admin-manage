"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_utils=require("../../tools/utils"),_modal=_interopRequireDefault(require("../../modal/src/modal")),_input=_interopRequireDefault(require("../../input/src/input")),_checkbox=_interopRequireDefault(require("../../checkbox/src/checkbox")),_select=_interopRequireDefault(require("../../select/src/select")),_button=_interopRequireDefault(require("../../button/src/button"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default=exports.default=(0,_vue.defineComponent)({name:"VxeTableExportPanel",props:{defaultOptions:Object,storeData:Object},setup(x){const l=(0,_vue.inject)("$xetable",{}),{computeExportOpts:a,computePrintOpts:o}=l.getComputeMaps(),_=(0,_vue.reactive)({isAll:!1,isIndeterminate:!1,loading:!1}),f=(0,_vue.ref)(),h=(0,_vue.ref)(),m=(0,_vue.ref)(),b=(0,_vue.computed)(()=>{var e=x["storeData"];return e.columns.every(e=>e.checked)}),C=(0,_vue.computed)(()=>{var e=x["defaultOptions"];return-1<["html","xml","xlsx","pdf"].indexOf(e.type)}),k=(0,_vue.computed)(()=>{var{storeData:e,defaultOptions:t}=x;return!t.original&&"current"===t.mode&&(e.isPrint||-1<["html","xlsx"].indexOf(t.type))}),g=(0,_vue.computed)(()=>{var e=x["defaultOptions"];return!e.original&&-1<["xlsx"].indexOf(e.type)}),O=t=>{var e=x["storeData"],e=_xeUtils.default.findTree(e.columns,e=>e===t);e&&e.parent&&(e=e["parent"],e.children)&&e.children.length&&(e.checked=e.children.every(e=>e.checked),e.halfChecked=!e.checked&&e.children.some(e=>e.checked||e.halfChecked),O(e))},E=()=>{var e=x["storeData"],e=e.columns;_.isAll=e.every(e=>e.disabled||e.checked),_.isIndeterminate=!_.isAll&&e.some(e=>!e.disabled&&(e.checked||e.halfChecked))},T=()=>{var e=x["storeData"];const t=!_.isAll;_xeUtils.default.eachTree(e.columns,e=>{e.disabled||(e.checked=t,e.halfChecked=!1)}),_.isAll=t,E()},V=()=>{(0,_vue.nextTick)(()=>{var e=h.value,t=m.value,l=f.value,e=e||t||l;e&&e.focus()}),E()},u=()=>{var{storeData:e,defaultOptions:t}=x,{hasMerge:e,columns:l}=e,a=b.value,o=k.value,l=_xeUtils.default.searchTree(l,e=>e.checked,{children:"children",mapChildren:"childNodes",original:!0});return Object.assign({},t,{columns:l,isMerge:!!(e&&o&&a)&&t.isMerge})},t=()=>{var e=x["storeData"],t=o.value;e.visible=!1,l.print(Object.assign({},t,u()))},n=()=>{const e=x["storeData"];var t=a.value;_.loading=!0,l.exportData(Object.assign({},t,u())).then(()=>{_.loading=!1,e.visible=!1}).catch(()=>{_.loading=!1})},D=()=>{var e=x["storeData"];e.visible=!1},U=()=>{var e=x["storeData"];(e.isPrint?t:n)()};return()=>{const{defaultOptions:t,storeData:l}=x,{isAll:e,isIndeterminate:a}=_,{hasTree:o,hasMerge:u,isPrint:n,hasColgroup:i}=l,r=t["isHeader"],d=[],c=b.value,s=C.value,p=k.value,v=g.value;return _xeUtils.default.eachTree(l.columns,l=>{var e=(0,_utils.formatText)(l.getTitle(),1),t=l.children&&l.children.length,a=l.checked,o=l.halfChecked;d.push((0,_vue.h)("li",{class:["vxe-export--panel-column-option","level--"+l.level,{"is--group":t,"is--checked":a,"is--indeterminate":o,"is--disabled":l.disabled}],title:e,onClick:()=>{if(!l.disabled){var e=l;const t=!e.checked;_xeUtils.default.eachTree([e],e=>{e.checked=t,e.halfChecked=!1}),O(e),E()}}},[(0,_vue.h)("span",{class:["vxe-checkbox--icon",o?_conf.default.icon.TABLE_CHECKBOX_INDETERMINATE:a?_conf.default.icon.TABLE_CHECKBOX_CHECKED:_conf.default.icon.TABLE_CHECKBOX_UNCHECKED]}),(0,_vue.h)("span",{class:"vxe-checkbox--label"},e)]))}),(0,_vue.h)(_modal.default,{modelValue:l.visible,title:_conf.default.i18n(n?"vxe.export.printTitle":"vxe.export.expTitle"),className:"vxe-table-export-popup-wrapper",width:660,mask:!0,lockView:!0,showFooter:!1,escClosable:!0,maskClosable:!0,loading:_.loading,"onUpdate:modelValue"(e){l.visible=e},onShow:V},{default:()=>(0,_vue.h)("div",{class:"vxe-export--panel"},[(0,_vue.h)("table",{cellspacing:0,cellpadding:0,border:0},[(0,_vue.h)("tbody",[[n?(0,_vue.createCommentVNode)():(0,_vue.h)("tr",[(0,_vue.h)("td",_conf.default.i18n("vxe.export.expName")),(0,_vue.h)("td",[(0,_vue.h)(_input.default,{ref:h,modelValue:t.filename,type:"text",clearable:!0,placeholder:_conf.default.i18n("vxe.export.expNamePlaceholder"),"onUpdate:modelValue"(e){t.filename=e}})])]),n?(0,_vue.createCommentVNode)():(0,_vue.h)("tr",[(0,_vue.h)("td",_conf.default.i18n("vxe.export.expType")),(0,_vue.h)("td",[(0,_vue.h)(_select.default,{modelValue:t.type,options:l.typeList.map(e=>({value:e.value,label:_conf.default.i18n(e.label)})),"onUpdate:modelValue"(e){t.type=e}})])]),n||s?(0,_vue.h)("tr",[(0,_vue.h)("td",_conf.default.i18n("vxe.export.expSheetName")),(0,_vue.h)("td",[(0,_vue.h)(_input.default,{ref:m,modelValue:t.sheetName,type:"text",clearable:!0,placeholder:_conf.default.i18n("vxe.export.expSheetNamePlaceholder"),"onUpdate:modelValue"(e){t.sheetName=e}})])]):(0,_vue.createCommentVNode)(),(0,_vue.h)("tr",[(0,_vue.h)("td",_conf.default.i18n("vxe.export.expMode")),(0,_vue.h)("td",[(0,_vue.h)(_select.default,{modelValue:t.mode,options:l.modeList.map(e=>({value:e.value,label:_conf.default.i18n(e.label)})),"onUpdate:modelValue"(e){t.mode=e}})])]),(0,_vue.h)("tr",[(0,_vue.h)("td",[_conf.default.i18n("vxe.export.expColumn")]),(0,_vue.h)("td",[(0,_vue.h)("div",{class:"vxe-export--panel-column"},[(0,_vue.h)("ul",{class:"vxe-export--panel-column-header"},[(0,_vue.h)("li",{class:["vxe-export--panel-column-option",{"is--checked":e,"is--indeterminate":a}],title:_conf.default.i18n("vxe.table.allTitle"),onClick:T},[(0,_vue.h)("span",{class:["vxe-checkbox--icon",a?_conf.default.icon.TABLE_CHECKBOX_INDETERMINATE:e?_conf.default.icon.TABLE_CHECKBOX_CHECKED:_conf.default.icon.TABLE_CHECKBOX_UNCHECKED]}),(0,_vue.h)("span",{class:"vxe-checkbox--label"},_conf.default.i18n("vxe.export.expCurrentColumn"))])]),(0,_vue.h)("ul",{class:"vxe-export--panel-column-body"},d)])])]),(0,_vue.h)("tr",[(0,_vue.h)("td",_conf.default.i18n("vxe.export.expOpts")),(0,_vue.h)("td",[(0,_vue.h)("div",{class:"vxe-export--panel-option-row"},[(0,_vue.h)(_checkbox.default,{modelValue:t.isHeader,title:_conf.default.i18n("vxe.export.expHeaderTitle"),content:_conf.default.i18n("vxe.export.expOptHeader"),"onUpdate:modelValue"(e){t.isHeader=e}}),(0,_vue.h)(_checkbox.default,{modelValue:t.isFooter,disabled:!l.hasFooter,title:_conf.default.i18n("vxe.export.expFooterTitle"),content:_conf.default.i18n("vxe.export.expOptFooter"),"onUpdate:modelValue"(e){t.isFooter=e}}),(0,_vue.h)(_checkbox.default,{modelValue:t.original,title:_conf.default.i18n("vxe.export.expOriginalTitle"),content:_conf.default.i18n("vxe.export.expOptOriginal"),"onUpdate:modelValue"(e){t.original=e}})]),(0,_vue.h)("div",{class:"vxe-export--panel-option-row"},[(0,_vue.h)(_checkbox.default,{modelValue:!!(r&&i&&p)&&t.isColgroup,title:_conf.default.i18n("vxe.export.expColgroupTitle"),disabled:!r||!i||!p,content:_conf.default.i18n("vxe.export.expOptColgroup"),"onUpdate:modelValue"(e){t.isColgroup=e}}),(0,_vue.h)(_checkbox.default,{modelValue:!!(u&&p&&c)&&t.isMerge,title:_conf.default.i18n("vxe.export.expMergeTitle"),disabled:!u||!p||!c,content:_conf.default.i18n("vxe.export.expOptMerge"),"onUpdate:modelValue"(e){t.isMerge=e}}),n?(0,_vue.createCommentVNode)():(0,_vue.h)(_checkbox.default,{modelValue:!!v&&t.useStyle,disabled:!v,title:_conf.default.i18n("vxe.export.expUseStyleTitle"),content:_conf.default.i18n("vxe.export.expOptUseStyle"),"onUpdate:modelValue"(e){t.useStyle=e}}),(0,_vue.h)(_checkbox.default,{modelValue:!!o&&t.isAllExpand,disabled:!o,title:_conf.default.i18n("vxe.export.expAllExpandTitle"),content:_conf.default.i18n("vxe.export.expOptAllExpand"),"onUpdate:modelValue"(e){t.isAllExpand=e}})])])])]])]),(0,_vue.h)("div",{class:"vxe-export--panel-btns"},[(0,_vue.h)(_button.default,{content:_conf.default.i18n("vxe.export.expCancel"),onClick:D}),(0,_vue.h)(_button.default,{ref:f,status:"primary",content:_conf.default.i18n(n?"vxe.export.expPrint":"vxe.export.expConfirm"),onClick:U})])])})}}});