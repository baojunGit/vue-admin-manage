"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_size=require("../../hooks/size"),_dom=require("../../tools/dom"),_utils=require("../../tools/utils"),_event=require("../../tools/event"),_input=_interopRequireDefault(require("../../input/src/input")),_vn=require("../../tools/vn");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function isOptionVisible(e){return!1!==e.visible}function getOptUniqueId(){return _xeUtils.default.uniqueId("opt_")}var _default=exports.default=(0,_vue.defineComponent)({name:"VxeSelect",props:{modelValue:null,clearable:Boolean,placeholder:{type:String,default:()=>_xeUtils.default.eqNull(_conf.default.select.placeholder)?_conf.default.i18n("vxe.base.pleaseSelect"):_conf.default.select.placeholder},loading:Boolean,disabled:Boolean,multiple:Boolean,multiCharOverflow:{type:[Number,String],default:()=>_conf.default.select.multiCharOverflow},prefixIcon:String,placement:String,options:Array,optionProps:Object,optionGroups:Array,optionGroupProps:Object,optionConfig:Object,className:[String,Function],popupClassName:[String,Function],max:{type:[String,Number],default:null},size:{type:String,default:()=>_conf.default.select.size||_conf.default.size},filterable:Boolean,filterMethod:Function,remote:Boolean,remoteMethod:Function,emptyText:String,optionId:{type:String,default:()=>_conf.default.select.optionId},optionKey:Boolean,transfer:{type:Boolean,default:()=>_conf.default.select.transfer}},emits:["update:modelValue","change","clear","blur","focus"],setup(g,e){const{slots:E,emit:i}=e,l=(0,_vue.inject)("$xeform",null),n=(0,_vue.inject)("$xeformiteminfo",null);var U=_xeUtils.default.uniqueId();const w=(0,_size.useSize)(g),O=(0,_vue.reactive)({inited:!1,staticOptions:[],fullGroupList:[],fullOptionList:[],visibleGroupList:[],visibleOptionList:[],remoteValueList:[],panelIndex:0,panelStyle:{},panelPlacement:null,currentOption:null,currentValue:null,visiblePanel:!1,animatVisible:!1,isActivated:!1,searchValue:"",searchLoading:!1}),_=(0,_vue.ref)(),h=(0,_vue.ref)(),b=(0,_vue.ref)(),m=(0,_vue.ref)(),x=(0,_vue.ref)(),q={refElem:_},V={xID:U,props:g,context:e,reactData:O,getRefMaps:()=>q};let o={};const t=(0,_vue.computed)(()=>g.optionProps||{}),a=(0,_vue.computed)(()=>g.optionGroupProps||{}),u=(0,_vue.computed)(()=>{return t.value.label||"label"}),T=(0,_vue.computed)(()=>{return t.value.value||"value"}),p=(0,_vue.computed)(()=>{return a.value.label||"label"}),L=(0,_vue.computed)(()=>{return a.value.options||"options"}),D=(0,_vue.computed)(()=>{var{modelValue:e,multiple:t,max:l}=g;return!(!t||!l)&&(e?e.length:0)>=_xeUtils.default.toNumber(l)}),y=(0,_vue.computed)(()=>Object.assign({},_conf.default.select.optionConfig,g.optionConfig)),S=(0,_vue.computed)(()=>O.fullGroupList.some(e=>e.options&&e.options.length)),F=(0,_vue.computed)(()=>_xeUtils.default.toNumber(g.multiCharOverflow)),P=(e,t)=>e&&(_xeUtils.default.isString(e)&&(e=E[e]||null),_xeUtils.default.isFunction(e))?(0,_vn.getSlotVNs)(e(t)):[],f=t=>{var{fullOptionList:e,fullGroupList:l}=O,i=S.value;const n=T.value;if(i)for(let e=0;e<l.length;e++){var o=l[e];if(o.options)for(let e=0;e<o.options.length;e++){var a=o.options[e];if(t===a[n])return a}}return e.find(e=>t===e[n])},s=t=>{var e=O["remoteValueList"],l=u.value,e=e.find(e=>t===e.key),e=e?e.result:null;return _xeUtils.default.toValueString(e?e[l]:t)},r=e=>{var t=u.value,l=f(e);return _xeUtils.default.toValueString(l?l[t]:e)},R=(0,_vue.computed)(()=>{var{modelValue:e,multiple:t,remote:l}=g;const i=F.value;return e&&t?(t=_xeUtils.default.isArray(e)?e:[e],(l?t.map(e=>s(e)):t.map(e=>{e=r(e);return 0<i&&e.length>i?e.substring(0,i)+"...":e})).join(", ")):(l?s:r)(e)}),v=()=>{return y.value.keyField||g.optionId||"_X_OPTION_KEY"},N=e=>{e=e[v()];return e?encodeURIComponent(e):""},c=()=>{const{filterable:e,filterMethod:t}=g,{fullOptionList:l,fullGroupList:i,searchValue:n}=O;var o=S.value;const a=p.value,s=u.value;return o?e&&t?O.visibleGroupList=i.filter(e=>isOptionVisible(e)&&t({group:e,option:null,searchValue:n})):O.visibleGroupList=e?i.filter(e=>isOptionVisible(e)&&(!n||-1<(""+e[a]).indexOf(n))):i.filter(isOptionVisible):e&&t?O.visibleOptionList=l.filter(e=>isOptionVisible(e)&&t({group:null,option:e,searchValue:n})):O.visibleOptionList=e?l.filter(e=>isOptionVisible(e)&&(!n||-1<(""+e[s]).indexOf(n))):l.filter(isOptionVisible),(0,_vue.nextTick)()},d=()=>{var{fullOptionList:e,fullGroupList:t}=O;const l=L.value,i=v(),n=e=>{N(e)||(e[i]=getOptUniqueId())};t.length?t.forEach(e=>{n(e),e[l]&&e[l].forEach(n)}):e.length&&e.forEach(n),c()},G=e=>{var t=T.value;e&&(O.currentOption=e,O.currentValue=e[t])},C=(i,n)=>(0,_vue.nextTick)().then(()=>{var e,t,l;i&&(e=m.value,t=x.value.querySelector(`[optid='${N(i)}']`),e)&&t&&(l=e.offsetHeight,n?t.offsetTop+t.offsetHeight-e.scrollTop>l&&(e.scrollTop=t.offsetTop+t.offsetHeight-l):(t.offsetTop+5<e.scrollTop||t.offsetTop+5>e.scrollTop+e.clientHeight)&&(e.scrollTop=t.offsetTop-5))}),k=()=>(0,_vue.nextTick)().then(()=>{var{transfer:e,placement:i}=g,n=O["panelIndex"],o=_.value,a=x.value;if(a&&o){var s=o.offsetHeight,u=o.offsetWidth,r=a.offsetHeight,a=a.offsetWidth,n={zIndex:n},{boundingTop:o,boundingLeft:v,visibleHeight:c,visibleWidth:p}=(0,_dom.getAbsolutePos)(o);let l="bottom";if(e){let e=v,t=o+s;"top"===i?(l="top",t=o-r):i||(t+r+5>c&&(l="top",t=o-r),t<5&&(l="bottom",t=o+s)),e+a+5>p&&(e-=e+a+5-p),e<5&&(e=5),Object.assign(n,{left:e+"px",top:t+"px",minWidth:u+"px"})}else"top"===i?(l="top",n.bottom=s+"px"):i||c<o+s+r&&5<o-s-r&&(l="top",n.bottom=s+"px");return O.panelStyle=n,O.panelPlacement=l,(0,_vue.nextTick)()}});let $;const A=()=>{var{loading:e,disabled:t,filterable:l}=g;e||t||(clearTimeout($),O.inited||(O.inited=!0),O.isActivated=!0,O.animatVisible=!0,l&&c(),setTimeout(()=>{var{modelValue:e,multiple:t}=g,t=f(t&&e?e[0]:e);O.visiblePanel=!0,t&&(G(t),C(t)),g.filterable&&(0,_vue.nextTick)(()=>{var e=b.value;e&&e.focus()})},10),O.panelIndex<(0,_utils.getLastZIndex)()&&(O.panelIndex=(0,_utils.nextZIndex)()),k())},I=()=>{O.searchValue="",O.searchLoading=!1,O.visiblePanel=!1,$=window.setTimeout(()=>{O.animatVisible=!1},350)},K=(e,t)=>{t!==g.modelValue&&(i("update:modelValue",t),o.dispatchEvent("change",{value:t},e),l)&&n&&l.triggerItemEvent(e,n.itemConfig.field,t)},j=(e,t)=>{O.remoteValueList=[],K(e,t),o.dispatchEvent("clear",{value:t},e)},B=(e,t)=>{j(t,null),I()},z=(t,l,i)=>{var{modelValue:n,multiple:o}=g,a=O["remoteValueList"];if(o){let e;e=n?-1===n.indexOf(l)?n.concat([l]):n.filter(e=>e!==l):[l];o=a.find(e=>e.key===l);o?o.result=i:a.push({key:l,result:i}),K(t,e)}else O.remoteValueList=[{key:l,result:i}],K(t,l),I()},M=e=>{var t=g["disabled"],l=O["visiblePanel"];t||l&&(t=x.value,((0,_dom.getEventTargetNode)(e,t).flag?k:I)())},Y=e=>{var t,l=g["disabled"],i=O["visiblePanel"];l||(l=_.value,t=x.value,O.isActivated=(0,_dom.getEventTargetNode)(e,l).flag||(0,_dom.getEventTargetNode)(e,t).flag,i&&!O.isActivated&&I())},H=l=>{var{clearable:e,disabled:t}=g,{visiblePanel:i,currentValue:n,currentOption:o}=O;if(!t){var t=(0,_event.hasEventKey)(l,_event.EVENT_KEYS.TAB),a=(0,_event.hasEventKey)(l,_event.EVENT_KEYS.ENTER),s=(0,_event.hasEventKey)(l,_event.EVENT_KEYS.ESCAPE),u=(0,_event.hasEventKey)(l,_event.EVENT_KEYS.ARROW_UP),r=(0,_event.hasEventKey)(l,_event.EVENT_KEYS.ARROW_DOWN),v=(0,_event.hasEventKey)(l,_event.EVENT_KEYS.DELETE),c=(0,_event.hasEventKey)(l,_event.EVENT_KEYS.SPACEBAR);if(t&&(O.isActivated=!1),i)if(s||t)I();else if(a)l.preventDefault(),l.stopPropagation(),z(l,n,o);else if(u||r){l.preventDefault();let{firstOption:e,offsetOption:t}=((t,l)=>{var{visibleOptionList:i,visibleGroupList:n}=O,e=S.value,o=T.value,a=L.value;let s,u,r,v;if(e)for(let e=0;e<n.length;e++){var c=n[e],p=c[a],f=c.disabled;if(p)for(let e=0;e<p.length;e++){var d=p[e],_=isOptionVisible(d),h=f||d.disabled;if(s||h||(s=d),v&&_&&!h&&(r=d,!l))return{offsetOption:r};if(t===d[o]){if(v=d,l)return{offsetOption:u}}else _&&!h&&(u=d)}}else for(let e=0;e<i.length;e++){var b=i[e],m=b.disabled;if(s||m||(s=b),v&&!m&&(r=b,!l))return{offsetOption:r};if(t===b[o]){if(v=b,l)return{offsetOption:u}}else m||(u=b)}return{firstOption:s}})(n,u);t||f(n)||(t=e),G(t),C(t,r)}else c&&l.preventDefault();else(u||r||a||c)&&O.isActivated&&(l.preventDefault(),A());O.isActivated&&v&&e&&j(l,null)}},W=()=>{I()},Z=e=>{g.disabled||(O.isActivated=!0),o.dispatchEvent("focus",{},e)},X=e=>{O.isActivated=!1,o.dispatchEvent("blur",{},e)},J=e=>{O.searchValue=e},Q=()=>{O.isActivated=!0},ee=e=>{e=e.$event;(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ENTER)&&(e.preventDefault(),e.stopPropagation())},te=_xeUtils.default.debounce(function(){var{remote:e,remoteMethod:t}=g,l=O["searchValue"];e&&t?(O.searchLoading=!0,Promise.resolve(t({searchValue:l})).then(()=>(0,_vue.nextTick)()).catch(()=>(0,_vue.nextTick)()).finally(()=>{O.searchLoading=!1,c()})):c()},350,{trailing:!0}),le=e=>{e=e.$event;e.preventDefault(),(O.visiblePanel?I:A)()},ie=(e,v)=>{const{optionKey:c,modelValue:p,multiple:f}=g,d=O["currentValue"];var t=y.value;const _=u.value,h=T.value,b=S.value,m=t["useKey"],x=E.option;return e.map((t,e)=>{var{slots:l,className:i}=t;const n=t[h];var o=f?p&&-1<p.indexOf(n):p===n,a=!b||isOptionVisible(t);r=o,u=v;const s=!!t.disabled||!(!u||!u.disabled)||!(!D.value||r);var u=N(t),r=l?l.default:null,l={option:t,group:null,$select:V};return a?(0,_vue.h)("div",{key:m||c?u:e,class:["vxe-select-option",i?_xeUtils.default.isFunction(i)?i(l):i:"",{"is--disabled":s,"is--selected":o,"is--hover":d===n}],optid:u,onMousedown:e=>{0===e.button&&e.stopPropagation()},onClick:e=>{s||z(e,n,t)},onMouseenter:()=>{s||G(t)}},x?P(x,l):r?P(r,l):(0,_utils.formatText)((0,_utils.getFuncText)(t[_]))):null})},ne=()=>{const s=g["optionKey"];var e=O["visibleGroupList"],t=y.value;const u=p.value,r=L.value,v=t["useKey"],c=E.option;return e.map((e,t)=>{var{slots:l,className:i}=e,n=N(e),o=e.disabled,l=l?l.default:null,a={option:e,group:e,$select:V};return(0,_vue.h)("div",{key:v||s?n:t,class:["vxe-optgroup",i?_xeUtils.default.isFunction(i)?i(a):i:"",{"is--disabled":o}],optid:n},[(0,_vue.h)("div",{class:"vxe-optgroup--title"},c?P(c,a):l?P(l,a):(0,_utils.getFuncText)(e[u])),(0,_vue.h)("div",{class:"vxe-optgroup--wrapper"},ie(e[r]||[],e))])})};o={dispatchEvent(e,t,l){i(e,Object.assign({$select:V,$event:l},t))},isPanelVisible(){return O.visiblePanel},togglePanel(){return(O.visiblePanel?I:A)(),(0,_vue.nextTick)()},hidePanel(){return O.visiblePanel&&I(),(0,_vue.nextTick)()},showPanel(){return O.visiblePanel||A(),(0,_vue.nextTick)()},refreshOption:c,focus(){var e=h.value;return O.isActivated=!0,e.blur(),(0,_vue.nextTick)()},blur(){return h.value.blur(),(O.isActivated=!1,_vue.nextTick)()}},Object.assign(V,o),(0,_vue.watch)(()=>O.staticOptions,e=>{e.some(e=>e.options&&e.options.length)?(O.fullOptionList=[],O.fullGroupList=e):(O.fullGroupList=[],O.fullOptionList=e||[]),d()}),(0,_vue.watch)(()=>g.options,e=>{O.fullGroupList=[],O.fullOptionList=e||[],d()}),(0,_vue.watch)(()=>g.optionGroups,e=>{O.fullOptionList=[],O.fullGroupList=e||[],d()}),(0,_vue.onMounted)(()=>{(0,_vue.nextTick)(()=>{var{options:e,optionGroups:t}=g;t?O.fullGroupList=t:e&&(O.fullOptionList=e),d()}),_event.GlobalEvent.on(V,"mousewheel",M),_event.GlobalEvent.on(V,"mousedown",Y),_event.GlobalEvent.on(V,"keydown",H),_event.GlobalEvent.on(V,"blur",W)}),(0,_vue.onUnmounted)(()=>{_event.GlobalEvent.off(V,"mousewheel"),_event.GlobalEvent.off(V,"mousedown"),_event.GlobalEvent.off(V,"keydown"),_event.GlobalEvent.off(V,"blur")});return V.renderVN=()=>{var{className:e,popupClassName:t,transfer:l,disabled:i,loading:n,filterable:o}=g,{inited:a,isActivated:s,visiblePanel:u}=O,r=w.value,v=R.value,c=E.default,p=E.header,f=E.footer;const d=E.prefix;return(0,_vue.h)("div",{ref:_,class:["vxe-select",e?_xeUtils.default.isFunction(e)?e({$select:V}):e:"",{["size--"+r]:r,"is--visivle":u,"is--disabled":i,"is--filter":o,"is--loading":n,"is--active":s}]},[(0,_vue.h)("div",{class:"vxe-select-slots",ref:"hideOption"},c?c({}):[]),(0,_vue.h)(_input.default,{ref:h,clearable:g.clearable,placeholder:g.placeholder,readonly:!0,disabled:i,type:"text",prefixIcon:g.prefixIcon,suffixIcon:n?_conf.default.icon.SELECT_LOADED:u?_conf.default.icon.SELECT_OPEN:_conf.default.icon.SELECT_CLOSE,modelValue:v,onClear:B,onClick:le,onFocus:Z,onBlur:X,onSuffixClick:le},d?{prefix:()=>d({})}:{}),(0,_vue.h)(_vue.Teleport,{to:"body",disabled:!l||!a},[(0,_vue.h)("div",{ref:x,class:["vxe-table--ignore-clear vxe-select--panel",t?_xeUtils.default.isFunction(t)?t({$select:V}):t:"",{["size--"+r]:r,"is--transfer":l,"animat--leave":!n&&O.animatVisible,"animat--enter":!n&&u}],placement:O.panelPlacement,style:O.panelStyle},a?[o?(0,_vue.h)("div",{class:"vxe-select--panel-search"},[(0,_vue.h)(_input.default,{ref:b,class:"vxe-select-search--input",modelValue:O.searchValue,clearable:!0,placeholder:_conf.default.i18n("vxe.select.search"),prefixIcon:_conf.default.icon.INPUT_SEARCH,"onUpdate:modelValue":J,onFocus:Q,onKeydown:ee,onChange:te,onSearch:te})]):(0,_vue.createCommentVNode)(),(0,_vue.h)("div",{class:"vxe-select--panel-wrapper"},[p?(0,_vue.h)("div",{class:"vxe-select--panel-header"},p({})):(0,_vue.createCommentVNode)(),(0,_vue.h)("div",{class:"vxe-select--panel-body"},[(0,_vue.h)("div",{ref:m,class:"vxe-select-option--wrapper"},(()=>{var{visibleGroupList:e,visibleOptionList:t,searchLoading:l}=O,i=S.value;if(l)return[(0,_vue.h)("div",{class:"vxe-select--search-loading"},[(0,_vue.h)("i",{class:["vxe-select--search-icon",_conf.default.icon.SELECT_LOADED]}),(0,_vue.h)("span",{class:"vxe-select--search-text"},_conf.default.i18n("vxe.select.loadingText"))])];if(i){if(e.length)return ne()}else if(t.length)return ie(t);return[(0,_vue.h)("div",{class:"vxe-select--empty-placeholder"},g.emptyText||_conf.default.i18n("vxe.select.emptyText"))]})())]),f?(0,_vue.h)("div",{class:"vxe-select--panel-footer"},f({})):(0,_vue.createCommentVNode)()])]:[])])])},(0,_vue.provide)("$xeselect",V),V},render(){return this.renderVN()}});