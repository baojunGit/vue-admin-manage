"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_size=require("../../hooks/size"),_resize=require("../../tools/resize"),_dom=require("../../tools/dom"),_event=require("../../tools/event"),_index=_interopRequireDefault(require("../../loading/index"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default=exports.default=(0,_vue.defineComponent)({name:"VxeList",props:{data:Array,height:[Number,String],maxHeight:[Number,String],loading:Boolean,className:[String,Function],size:{type:String,default:()=>_conf.default.list.size||_conf.default.size},autoResize:{type:Boolean,default:()=>_conf.default.list.autoResize},syncResize:[Boolean,String,Number],scrollY:Object},emits:["scroll"],setup(i,e){const{slots:n,emit:r}=e;var t=_xeUtils.default.uniqueId();const u=(0,_size.useSize)(i),c=(0,_vue.reactive)({scrollYLoad:!1,bodyHeight:0,rowHeight:0,topSpaceHeight:0,items:[]}),d=(0,_vue.ref)(),v=(0,_vue.ref)(),f=(0,_vue.ref)(),h={fullData:[],lastScrollLeft:0,lastScrollTop:0,scrollYStore:{startIndex:0,endIndex:0,visibleSize:0,offsetSize:0,rowHeight:0}},l={refElem:d},_={xID:t,props:i,context:e,reactData:c,internalData:h,getRefMaps:()=>l};let o={};const s=(0,_vue.computed)(()=>Object.assign({},_conf.default.list.scrollY,i.scrollY)),x=(0,_vue.computed)(()=>{var{height:e,maxHeight:t}=i,l={};return e?l.height=""+(isNaN(e)?e:e+"px"):t&&(l.height="auto",l.maxHeight=""+(isNaN(t)?t:t+"px")),l}),g=()=>{var e=c["scrollYLoad"],{scrollYStore:t,fullData:l}=h;c.bodyHeight=e?l.length*t.rowHeight:0,c.topSpaceHeight=e?Math.max(t.startIndex*t.rowHeight,0):0},a=()=>{var e=c["scrollYLoad"],{fullData:t,scrollYStore:l}=h;return c.items=e?t.slice(l.startIndex,l.endIndex):t.slice(0),(0,_vue.nextTick)()},p=()=>{a(),g()},m=()=>(0,_vue.nextTick)().then(()=>{var e=c["scrollYLoad"],t=h["scrollYStore"],l=f.value,r=s.value;let a=0,o;(o=l?(o=r.sItem?l.querySelector(r.sItem):o)||l.children[0]:o)&&(a=o.offsetHeight),a=Math.max(20,a),t.rowHeight=a,(e?(l=v.value,e=Math.max(8,Math.ceil(l.clientHeight/a)),l=r.oSize?_xeUtils.default.toNumber(r.oSize):_dom.browse.edge?10:0,t.offsetSize=l,t.visibleSize=e,t.endIndex=Math.max(t.startIndex,e+l,t.endIndex),p):g)(),c.rowHeight=a}),S=()=>{var e=v.value;return e&&(e.scrollTop=0),(0,_vue.nextTick)()},z=(e,t)=>{var l=v.value;return _xeUtils.default.isNumber(e)&&(l.scrollLeft=e),_xeUtils.default.isNumber(t)&&(l.scrollTop=t),c.scrollYLoad?new Promise(e=>{setTimeout(()=>{(0,_vue.nextTick)(()=>{e()})},50)}):(0,_vue.nextTick)()},b=()=>{const{lastScrollLeft:e,lastScrollTop:t}=h;return S().then(()=>{if(e||t)return h.lastScrollLeft=0,h.lastScrollTop=0,z(e,t)})},T=()=>{var e=d.value;return e.clientWidth&&e.clientHeight?m():Promise.resolve()},H=e=>{var t=h["scrollYStore"],{startIndex:l,endIndex:r,visibleSize:a,offsetSize:o,rowHeight:s}=t,e=e.target.scrollTop,e=Math.floor(e/s),s=Math.max(0,e-1-o),o=e+a+o;!(e<=l||r-a-1<=e)||l===s&&r===o||(t.startIndex=s,t.endIndex=o,p())},I=e=>{var t=e.target,l=t.scrollTop,t=t.scrollLeft,r=t!==h.lastScrollLeft,a=l!==h.lastScrollTop;h.lastScrollTop=l,h.lastScrollLeft=t,c.scrollYLoad&&H(e),o.dispatchEvent("scroll",{scrollLeft:t,scrollTop:l,isX:r,isY:a},e)},Y=(o={dispatchEvent(e,t,l){r(e,Object.assign({$list:_,$event:l},t))},loadData(e){var t=h["scrollYStore"],l=s.value,e=e||[];return Object.assign(t,{startIndex:0,endIndex:1,visibleSize:0}),h.fullData=e,c.scrollYLoad=!!l.enabled&&-1<l.gt&&(0===l.gt||l.gt<=e.length),a(),m().then(()=>{b()})},reloadData(e){return S(),o.loadData(e)},recalculate:T,scrollTo:z,refreshScroll:b,clearScroll:S},Object.assign(_,o),(0,_vue.ref)(0));(0,_vue.watch)(()=>i.data?i.data.length:-1,()=>{Y.value++}),(0,_vue.watch)(()=>i.data,()=>{Y.value++}),(0,_vue.watch)(Y,()=>{o.loadData(i.data||[])}),(0,_vue.watch)(()=>i.syncResize,e=>{e&&(T(),(0,_vue.nextTick)(()=>setTimeout(()=>T())))}),(0,_vue.onActivated)(()=>{T().then(()=>b())});let D;(0,_vue.nextTick)(()=>{var e;_event.GlobalEvent.on(_,"resize",()=>{T()}),i.autoResize&&(e=d.value,(D=(0,_resize.createResizeEvent)(()=>T())).observe(e)),o.loadData(i.data||[])}),(0,_vue.onUnmounted)(()=>{D&&D.disconnect(),_event.GlobalEvent.off(_,"resize")});return _.renderVN=()=>{var{className:e,loading:t}=i,{bodyHeight:l,topSpaceHeight:r,items:a}=c,o=u.value,s=x.value;return(0,_vue.h)("div",{ref:d,class:["vxe-list",e?_xeUtils.default.isFunction(e)?e({$list:_}):e:"",{["size--"+o]:o,"is--loading":t}]},[(0,_vue.h)("div",{ref:v,class:"vxe-list--virtual-wrapper",style:s,onScroll:I},[(0,_vue.h)("div",{class:"vxe-list--y-space",style:{height:l?l+"px":""}}),(0,_vue.h)("div",{ref:f,class:"vxe-list--body",style:{marginTop:r?r+"px":""}},n.default?n.default({items:a,$list:_}):[])]),(0,_vue.h)(_index.default,{class:"vxe-list--loading",modelValue:t})])},_},render(){return this.renderVN()}});