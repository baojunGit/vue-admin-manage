"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.msgQueue=exports.default=exports.allActiveModals=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_size=require("../../hooks/size"),_dom=require("../../tools/dom"),_utils=require("../../tools/utils"),_log=require("../../tools/log"),_event=require("../../tools/event"),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_button=_interopRequireDefault(require("../../button/src/button")),_index=_interopRequireDefault(require("../../loading/index")),_vn=require("../../tools/vn");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const allActiveModals=exports.allActiveModals=[],msgQueue=exports.msgQueue=[];var _default=exports.default=(0,_vue.defineComponent)({name:"VxeModal",props:{modelValue:Boolean,id:String,type:{type:String,default:"modal"},loading:{type:Boolean,default:null},status:String,iconStatus:String,className:String,top:{type:[Number,String],default:()=>_conf.default.modal.top},position:[String,Object],title:String,duration:{type:[Number,String],default:()=>_conf.default.modal.duration},message:[Number,String],content:[Number,String],showCancelButton:{type:Boolean,default:null},cancelButtonText:{type:String,default:()=>_conf.default.modal.cancelButtonText},showConfirmButton:{type:Boolean,default:()=>_conf.default.modal.showConfirmButton},confirmButtonText:{type:String,default:()=>_conf.default.modal.confirmButtonText},lockView:{type:Boolean,default:()=>_conf.default.modal.lockView},lockScroll:Boolean,mask:{type:Boolean,default:()=>_conf.default.modal.mask},maskClosable:{type:Boolean,default:()=>_conf.default.modal.maskClosable},escClosable:{type:Boolean,default:()=>_conf.default.modal.escClosable},resize:Boolean,showHeader:{type:Boolean,default:()=>_conf.default.modal.showHeader},showFooter:{type:Boolean,default:()=>_conf.default.modal.showFooter},showZoom:Boolean,showClose:{type:Boolean,default:()=>_conf.default.modal.showClose},dblclickZoom:{type:Boolean,default:()=>_conf.default.modal.dblclickZoom},width:[Number,String],height:[Number,String],minWidth:{type:[Number,String],default:()=>_conf.default.modal.minWidth},minHeight:{type:[Number,String],default:()=>_conf.default.modal.minHeight},zIndex:Number,marginSize:{type:[Number,String],default:()=>_conf.default.modal.marginSize},fullscreen:Boolean,draggable:{type:Boolean,default:()=>_conf.default.modal.draggable},remember:{type:Boolean,default:()=>_conf.default.modal.remember},destroyOnClose:{type:Boolean,default:()=>_conf.default.modal.destroyOnClose},showTitleOverflow:{type:Boolean,default:()=>_conf.default.modal.showTitleOverflow},transfer:{type:Boolean,default:()=>_conf.default.modal.transfer},storage:{type:Boolean,default:()=>_conf.default.modal.storage},storageKey:{type:String,default:()=>_conf.default.modal.storageKey},animat:{type:Boolean,default:()=>_conf.default.modal.animat},size:{type:String,default:()=>_conf.default.modal.size||_conf.default.size},beforeHideMethod:{type:Function,default:()=>_conf.default.modal.beforeHideMethod},slots:Object},emits:["update:modelValue","show","hide","before-hide","close","confirm","cancel","zoom","resize","move"],setup(N,e){const{slots:v,emit:f}=e;var t=_xeUtils.default.uniqueId();const h=(0,_size.useSize)(N),k=(0,_vue.reactive)({inited:!1,visible:!1,contentVisible:!1,modalTop:0,modalZindex:0,zoomLocat:null,firstOpen:!0}),_=(0,_vue.ref)(),x=(0,_vue.ref)(),s=(0,_vue.ref)(),i=(0,_vue.ref)(),o={refElem:_},g={xID:t,props:N,context:e,reactData:k,getRefMaps:()=>o};let z={};const b=(0,_vue.computed)(()=>"message"===N.type),S=()=>{return x.value},n=()=>{var{width:e,height:t}=N,o=S();return o.style.width=""+(e?isNaN(e)?e:e+"px":""),o.style.height=""+(t?isNaN(t)?t:t+"px":""),(0,_vue.nextTick)()},u=()=>{var e=N["zIndex"],t=k["modalZindex"];e?k.modalZindex=e:t<(0,_utils.getLastZIndex)()&&(k.modalZindex=(0,_utils.nextZIndex)())},c=()=>(0,_vue.nextTick)().then(()=>{var e=N["position"],t=_xeUtils.default.toNumber(N.marginSize),o=S(),l=document.documentElement.clientWidth||document.body.clientWidth,a=document.documentElement.clientHeight||document.body.clientHeight,s="center"===e,{top:e,left:i}=_xeUtils.default.isString(e)?{top:e,left:e}:Object.assign({},e),n=s||"center"===e;let u="",r="";r=i&&!(s||"center"===i)?isNaN(i)?i:i+"px":Math.max(t,l/2-o.offsetWidth/2)+"px",u=e&&!n?isNaN(e)?e:e+"px":Math.max(t,a/2-o.offsetHeight/2)+"px",o.style.top=u,o.style.left=r}),r=()=>{(0,_vue.nextTick)(()=>{let o=0;msgQueue.forEach(e=>{var t=e.getBox();o+=_xeUtils.default.toNumber(e.props.top),e.reactData.modalTop=o,o+=t.clientHeight})})},d=()=>{-1<msgQueue.indexOf(g)&&_xeUtils.default.remove(msgQueue,e=>e===g),r()},m=e=>{const{remember:t,beforeHideMethod:o}=N;var l=k["visible"];const a=b.value,s={type:e};return l&&Promise.resolve(o?o(s):null).then(e=>{_xeUtils.default.isError(e)||(a&&d(),k.contentVisible=!1,t||(k.zoomLocat=null),_xeUtils.default.remove(allActiveModals,e=>e===g),z.dispatchEvent("before-hide",s),setTimeout(()=>{k.visible=!1,f("update:modelValue",!1),z.dispatchEvent("hide",s)},200))}).catch(e=>e),(0,_vue.nextTick)()},p=e=>{var t="close";z.dispatchEvent(t,{type:t},e),m(t)},a=e=>{var t="confirm";z.dispatchEvent(t,{type:t},e),m(t)},y=e=>{var t="cancel";z.dispatchEvent(t,{type:t},e),m(t)},w=e=>{var t=_conf.default.version,e=_xeUtils.default.toStringJSON(localStorage.getItem(e)||"");return e&&e._v===t?e:{_v:t}},T=()=>{var{id:e,remember:t,storage:o,storageKey:l}=N,a=k["zoomLocat"];e&&t&&o&&(t=S(),(o=w(l))[e]=[t.style.left,t.style.top,t.style.width,t.style.height].concat(a?[a.left,a.top,a.width,a.height]:[]).map(e=>e?_xeUtils.default.toNumber(e):"").join(","),localStorage.setItem(l,_xeUtils.default.toJSONString(o)))},B=()=>(0,_vue.nextTick)().then(()=>{var e,t,o,l;k.zoomLocat||(e=Math.max(0,_xeUtils.default.toNumber(N.marginSize)),t=S(),{visibleHeight:o,visibleWidth:l}=(0,_dom.getDomNode)(),k.zoomLocat={top:t.offsetTop,left:t.offsetLeft,width:t.offsetWidth+(t.style.width?0:1),height:t.offsetHeight+(t.style.height?0:1)},Object.assign(t.style,{top:e+"px",left:e+"px",width:l-2*e+"px",height:o-2*e+"px"}),T())}),l=()=>{const{duration:e,remember:d,showFooter:o}=N;var{inited:t,visible:l}=k,a=b.value;return t||(k.inited=!0),l||(d||n(),k.visible=!0,k.contentVisible=!1,u(),allActiveModals.push(g),setTimeout(()=>{k.contentVisible=!0,(0,_vue.nextTick)(()=>{o&&(e=s.value,t=i.value,e=e||t)&&e.focus();var e,t={type:""};f("update:modelValue",!0),z.dispatchEvent("show",t)})},10),a?(-1===msgQueue.indexOf(g)&&msgQueue.push(g),r(),-1!==e&&setTimeout(()=>m("close"),_xeUtils.default.toNumber(e))):(0,_vue.nextTick)(()=>{var e,t,o,l,a,s,i,n,u=N["fullscreen"],r=k["firstOpen"];d&&!r||c().then(()=>{setTimeout(()=>c(),20)}),r&&(k.firstOpen=!1,(()=>{var{id:e,remember:t,storage:o,storageKey:l}=N;return!!(e&&t&&o&&w(l)[e])})())?({id:r,remember:s,storage:i,storageKey:n}=N,r&&s&&i&&(s=w(n)[r])&&(i=S(),[n,r,s,e,t,o,l,a]=s.split(","),n&&(i.style.left=n+"px"),r&&(i.style.top=r+"px"),s&&(i.style.width=s+"px"),e&&(i.style.height=e+"px"),t)&&o&&(k.zoomLocat={left:t,top:o,width:l,height:a})):u&&(0,_vue.nextTick)(()=>B())})),(0,_vue.nextTick)()},O=e=>{var t=_.value;N.maskClosable&&e.target===t&&m("mask")},C=e=>{if((0,_event.hasEventKey)(e,_event.EVENT_KEYS.ESCAPE)){const t=_xeUtils.default.max(allActiveModals,e=>e.reactData.modalZindex);t&&setTimeout(()=>{t===g&&t.props.escClosable&&m("exit")},10)}},M=()=>!!k.zoomLocat,L=()=>(0,_vue.nextTick)().then(()=>{var e,t=k["zoomLocat"];t&&(e=S(),k.zoomLocat=null,Object.assign(e.style,{top:t.top+"px",left:t.left+"px",width:t.width+"px",height:t.height+"px"}),T())}),U=()=>(k.zoomLocat?L:B)().then(()=>M()),E=e=>{var t=k["zoomLocat"];const o={type:t?"revert":"max"};return U().then(()=>{z.dispatchEvent("zoom",o,e)})};const V=()=>{const t=k["modalZindex"];allActiveModals.some(e=>e.reactData.visible&&e.reactData.modalZindex>t)&&u()},D=e=>{const{remember:t,storage:o}=N;var l=k["zoomLocat"];const n=_xeUtils.default.toNumber(N.marginSize),u=S();if(!l&&0===e.button&&!(0,_dom.getEventTargetNode)(e,u,"trigger--btn").flag){e.preventDefault();const a=document.onmousemove,s=document.onmouseup,r=e.clientX-u.offsetLeft,d=e.clientY-u.offsetTop,{visibleHeight:c,visibleWidth:m}=(0,_dom.getDomNode)();document.onmousemove=e=>{e.preventDefault();var t=u.offsetWidth,o=u.offsetHeight,l=n,t=m-t-n-1,a=n,o=c-o-n-1;let s=e.clientX-r,i=e.clientY-d;(s=s>t?t:s)<l&&(s=l),(i=i>o?o:i)<a&&(i=a),u.style.left=s+"px",u.style.top=i+"px",u.className=u.className.replace(/\s?is--drag/,"")+" is--drag",f("move",{type:"move",$event:e})},document.onmouseup=()=>{document.onmousemove=a,document.onmouseup=s,t&&o&&(0,_vue.nextTick)(()=>{T()}),setTimeout(()=>{u.className=u.className.replace(/\s?is--drag/,"")},50)}}},$=e=>{e.preventDefault();const{remember:s,storage:i}=N,{visibleHeight:n,visibleWidth:u}=(0,_dom.getDomNode)(),r=_xeUtils.default.toNumber(N.marginSize);const d=e.target.getAttribute("type"),c=_xeUtils.default.toNumber(N.minWidth),m=_xeUtils.default.toNumber(N.minHeight),f=u,p=n,v=S(),t=document.onmousemove,o=document.onmouseup,h=v.clientWidth,_=v.clientHeight,x=e.clientX,g=e.clientY,b=v.offsetTop,y=v.offsetLeft,w={type:"resize"};document.onmousemove=e=>{e.preventDefault();let t,o,l,a;switch(d){case"wl":t=x-e.clientX,l=t+h,y-t>r&&l>c&&(v.style.width=`${l<f?l:f}px`,v.style.left=y-t+"px");break;case"swst":t=x-e.clientX,o=g-e.clientY,l=t+h,a=o+_,y-t>r&&l>c&&(v.style.width=`${l<f?l:f}px`,v.style.left=y-t+"px"),b-o>r&&a>m&&(v.style.height=`${a<p?a:p}px`,v.style.top=b-o+"px");break;case"swlb":t=x-e.clientX,o=e.clientY-g,l=t+h,a=o+_,y-t>r&&l>c&&(v.style.width=`${l<f?l:f}px`,v.style.left=y-t+"px"),b+a+r<n&&a>m&&(v.style.height=`${a<p?a:p}px`);break;case"st":o=g-e.clientY,a=_+o,b-o>r&&a>m&&(v.style.height=`${a<p?a:p}px`,v.style.top=b-o+"px");break;case"wr":t=e.clientX-x,l=t+h,y+l+r<u&&l>c&&(v.style.width=`${l<f?l:f}px`);break;case"sest":t=e.clientX-x,o=g-e.clientY,l=t+h,a=o+_,y+l+r<u&&l>c&&(v.style.width=`${l<f?l:f}px`),b-o>r&&a>m&&(v.style.height=`${a<p?a:p}px`,v.style.top=b-o+"px");break;case"selb":t=e.clientX-x,o=e.clientY-g,l=t+h,a=o+_,y+l+r<u&&l>c&&(v.style.width=`${l<f?l:f}px`),b+a+r<n&&a>m&&(v.style.height=`${a<p?a:p}px`);break;case"sb":o=e.clientY-g,a=o+_,b+a+r<n&&a>m&&(v.style.height=`${a<p?a:p}px`)}v.className=v.className.replace(/\s?is--drag/,"")+" is--drag",s&&i&&T(),z.dispatchEvent("resize",w,e)},document.onmouseup=()=>{k.zoomLocat=null,document.onmousemove=t,document.onmouseup=o,setTimeout(()=>{v.className=v.className.replace(/\s?is--drag/,"")},50)}},H=(z={dispatchEvent(e,t,o){f(e,Object.assign({$modal:g,$event:o},t))},open:l,close(){return m("close")},getBox:S,getPosition:()=>{if(!b.value){var e=S();if(e)return{top:e.offsetTop,left:e.offsetLeft}}return null},setPosition:(e,t)=>{var o;return b.value||(o=S(),_xeUtils.default.isNumber(e)&&(o.style.top=e+"px"),_xeUtils.default.isNumber(t)&&(o.style.left=t+"px")),(0,_vue.nextTick)()},isMaximized:M,zoom:U,maximize:B,revert:L},Object.assign(g,z),()=>{var{slots:e={},showClose:t,showZoom:o,title:l}=N,a=k["zoomLocat"],s=v.title||e.title,e=v.corner||e.corner,s=[(0,_vue.h)("div",{class:"vxe-modal--header-title"},s?(0,_vn.getSlotVNs)(s({$modal:g})):l?(0,_utils.getFuncText)(l):_conf.default.i18n("vxe.alert.title"))],l=[];return e&&l.push((0,_vue.h)("span",{class:"vxe-modal--corner-wrapper"},(0,_vn.getSlotVNs)(e({$modal:g})))),o&&l.push((0,_vue.h)("i",{class:["vxe-modal--zoom-btn","trigger--btn",a?_conf.default.icon.MODAL_ZOOM_OUT:_conf.default.icon.MODAL_ZOOM_IN],title:_conf.default.i18n("vxe.modal.zoom"+(a?"Out":"In")),onClick:E})),t&&l.push((0,_vue.h)("i",{class:["vxe-modal--close-btn","trigger--btn",_conf.default.icon.MODAL_CLOSE],title:_conf.default.i18n("vxe.modal.close"),onClick:p})),s.push((0,_vue.h)("div",{class:"vxe-modal--header-right"},l)),s}),q=()=>{var{showCancelButton:e,showConfirmButton:t,type:o}=N,l=[];return(_xeUtils.default.isBoolean(e)?e:"confirm"===o)&&l.push((0,_vue.h)(_button.default,{key:1,ref:i,content:N.cancelButtonText||_conf.default.i18n("vxe.button.cancel"),onClick:y})),(_xeUtils.default.isBoolean(t)?t:"confirm"===o||"alert"===o)&&l.push((0,_vue.h)(_button.default,{key:2,ref:s,status:"primary",content:N.confirmButtonText||_conf.default.i18n("vxe.button.confirm"),onClick:a})),l};return g.renderVN=()=>{var{className:e,type:t,animat:o,loading:l,status:a,lockScroll:s,lockView:i,mask:n,resize:u}=N,{inited:r,zoomLocat:d,modalTop:c,contentVisible:m,visible:f}=k,p=h.value;return(0,_vue.h)(_vue.Teleport,{to:"body",disabled:!N.transfer||!r},[(0,_vue.h)("div",{ref:_,class:["vxe-modal--wrapper","type--"+t,e||"",{["size--"+p]:p,["status--"+a]:a,"is--animat":o,"lock--scroll":s,"lock--view":i,"is--resize":u,"is--mask":n,"is--maximize":d,"is--visible":m,"is--active":f,"is--loading":l}],style:{zIndex:k.modalZindex,top:c?c+"px":null},onClick:O},[(0,_vue.h)("div",{ref:x,class:"vxe-modal--box",onMousedown:V},(()=>{var e,{slots:t={},showZoom:o,draggable:l}=N,a=b.value,t=v.header||t.header,s=[];return N.showHeader&&(e={},l&&(e.onMousedown=D),o&&N.dblclickZoom&&"modal"===N.type&&(e.onDblclick=E),s.push((0,_vue.h)("div",Object.assign({class:["vxe-modal--header",{"is--draggable":l,"is--ellipsis":!a&&N.showTitleOverflow}]},e),t?!k.inited||N.destroyOnClose&&!k.visible?[]:(0,_vn.getSlotVNs)(t({$modal:g})):H()))),s})().concat((()=>{var{slots:e={},status:t,message:o}=N,o=N.content||o,l=b.value,e=v.default||e.default,a=[];return t&&a.push((0,_vue.h)("div",{class:"vxe-modal--status-wrapper"},[(0,_vue.h)("i",{class:["vxe-modal--status-icon",N.iconStatus||_conf.default.icon[("MODAL_"+t).toLocaleUpperCase()]]})])),a.push((0,_vue.h)("div",{class:"vxe-modal--content"},e?!k.inited||N.destroyOnClose&&!k.visible?[]:(0,_vn.getSlotVNs)(e({$modal:g})):(0,_utils.getFuncText)(o))),l||a.push((0,_vue.h)(_index.default,{class:"vxe-modal--loading",modelValue:N.loading})),[(0,_vue.h)("div",{class:"vxe-modal--body"},a)]})(),(()=>{var{slots:e={}}=N,t=b.value,e=v.footer||e.footer,o=[];return N.showFooter&&o.push((0,_vue.h)("div",{class:"vxe-modal--footer"},e?!k.inited||N.destroyOnClose&&!k.visible?[]:(0,_vn.getSlotVNs)(e({$modal:g})):q())),!t&&N.resize&&o.push((0,_vue.h)("span",{class:"vxe-modal--resize"},["wl","wr","swst","sest","st","swlb","selb","sb"].map(e=>(0,_vue.h)("span",{class:e+"-resize",type:e,onMousedown:$})))),o})()))])])},(0,_vue.watch)(()=>N.width,n),(0,_vue.watch)(()=>N.height,n),(0,_vue.watch)(()=>N.modelValue,e=>{e?l():m("model")}),(0,_vue.onMounted)(()=>{(0,_vue.nextTick)(()=>{N.storage&&!N.id&&(0,_log.errLog)("vxe.error.reqProp",["modal.id"]),N.modelValue&&l(),n()}),N.escClosable&&_event.GlobalEvent.on(g,"keydown",C)}),(0,_vue.onUnmounted)(()=>{_event.GlobalEvent.off(g,"keydown"),d()}),g},render(){return this.renderVN()}});