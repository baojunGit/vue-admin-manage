"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_vXETable=require("../../v-x-e-table"),_utils=require("../../tools/utils"),_log=require("../../tools/log"),_dom=require("../../tools/dom"),_util=require("./util"),_size=require("../../hooks/size"),_tooltip=_interopRequireDefault(require("../../tooltip")),_formConfigItem=_interopRequireDefault(require("./form-config-item")),_index=_interopRequireDefault(require("../../loading/index")),_vn=require("../../tools/vn");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}class Rule{constructor(e){Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.min,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}get content(){return(0,_utils.getFuncText)(this.$options.content||this.$options.message)}get message(){return this.content}}const validErrorRuleValue=(e,t)=>{var{type:e,min:l,max:r,pattern:i}=e,e="number"===e,a=e?_xeUtils.default.toNumber(t):_xeUtils.default.getSize(t);return!(!e||!isNaN(t))||!_xeUtils.default.eqNull(l)&&a<_xeUtils.default.toNumber(l)||!_xeUtils.default.eqNull(r)&&a>_xeUtils.default.toNumber(r)||!(!i||(_xeUtils.default.isRegExp(i)?i:new RegExp(i)).test(t))};function getResetValue(e,t){return t=_xeUtils.default.isArray(e)?[]:t}var _default=exports.default=(0,_vue.defineComponent)({name:"VxeForm",props:{collapseStatus:{type:Boolean,default:!0},loading:Boolean,data:Object,size:{type:String,default:()=>_conf.default.form.size||_conf.default.size},span:{type:[String,Number],default:()=>_conf.default.form.span},align:{type:String,default:()=>_conf.default.form.align},titleAlign:{type:String,default:()=>_conf.default.form.titleAlign},titleWidth:{type:[String,Number],default:()=>_conf.default.form.titleWidth},titleColon:{type:Boolean,default:()=>_conf.default.form.titleColon},titleAsterisk:{type:Boolean,default:()=>_conf.default.form.titleAsterisk},titleOverflow:{type:[Boolean,String],default:null},vertical:{type:Boolean,default:null},className:[String,Function],readonly:Boolean,items:Array,rules:Object,preventSubmit:{type:Boolean,default:()=>_conf.default.form.preventSubmit},validConfig:Object,tooltipConfig:Object,customLayout:{type:Boolean,default:()=>_conf.default.form.customLayout}},emits:["update:collapseStatus","collapse","toggle-collapse","submit","submit-invalid","reset"],setup(n,e){const s=_vXETable.VXETable.tooltip,{slots:d,emit:r}=e;var t=_xeUtils.default.uniqueId();const c=(0,_size.useSize)(n),f=(0,_vue.reactive)({collapseAll:n.collapseStatus,staticItems:[],formItems:[]}),o=(0,_vue.reactive)({tooltipTimeout:null,tooltipStore:{item:null,visible:!1}}),i=(0,_vue.inject)("$xegrid",null),m=(0,_vue.ref)(),v=(0,_vue.ref)();let l={};const p=(0,_vue.computed)(()=>Object.assign({},_conf.default.form.validConfig,n.validConfig)),_=(0,_vue.computed)(()=>Object.assign({},_conf.default.tooltip,_conf.default.form.tooltipConfig,n.tooltipConfig)),a={refElem:m},u={computeSize:c,computeValidOpts:p,computeTooltipOpts:_},g={xID:t,props:n,context:e,reactData:f,xegrid:i,getRefMaps:()=>a,getComputeMaps:()=>u};const h=e=>(e.length&&"development"===process.env.NODE_ENV&&e.forEach(e=>{e.slots&&_xeUtils.default.each(e.slots,e=>{_xeUtils.default.isFunction(e)||d[e]||(0,_log.errLog)("vxe.error.notSlot",[e])})}),f.staticItems=_xeUtils.default.mapTree(e,e=>(0,_util.createItem)(g,e),{children:"children"}),(0,_vue.nextTick)()),x=()=>{const t=[];return _xeUtils.default.eachTree(f.formItems,e=>{t.push(e)},{children:"children"}),t},E=t=>{var e=_xeUtils.default.findTree(f.formItems,e=>e.field===t,{children:"children"});return e?e.item:null},b=()=>f.collapseAll,y=()=>{var e=!b();return f.collapseAll=e,r("update:collapseStatus",e),(0,_vue.nextTick)()};const T=t=>{if(t){let e=t;(e=_xeUtils.default.isArray(t)?e:[t]).forEach(e=>{e&&(e=(0,_util.handleFieldOrItem)(g,e))&&(e.showError=!1)})}else x().forEach(e=>{e.showError=!1});return(0,_vue.nextTick)()},U=()=>{const i=n["data"];var e=x();return i&&e.forEach(e=>{var{field:t,resetValue:l,itemRender:r}=e;(0,_utils.isEnableConf)(r)&&((r=_vXETable.VXETable.renderer.get(r.name))&&r.itemResetMethod?r.itemResetMethod({data:i,field:t,property:t,item:e,$form:g,$grid:g.xegrid}):t&&_xeUtils.default.set(i,t,null===l?getResetValue(_xeUtils.default.get(i,t),void 0):_xeUtils.default.clone(l,!0)))}),T()},S=e=>{e.preventDefault(),U(),l.dispatchEvent("reset",{data:n.data},e)},q=e=>{var l=m.value;for(let t=0;t<e.length;t++){var r=e[t],r=E(r);if(r&&(0,_utils.isEnableConf)(r.itemRender)){var i=r["itemRender"],a=_vXETable.VXETable.renderer.get(i.name);let e=null;if(t||(0,_dom.scrollToView)(l.querySelector("."+r.id)),e=!(e=i.autofocus?l.querySelector(`.${r.id} `+i.autofocus):e)&&a&&a.autofocus?l.querySelector(`.${r.id} `+a.autofocus):e){e.focus();break}}}},R=(e,t,l)=>{const{data:m,rules:r}=n,i={};return _xeUtils.default.isArray(t)||(t=[t]),Promise.all(t.map(s=>{const n=[],d=[];if(s&&r){const c=_xeUtils.default.get(r,s);if(c){const f=_xeUtils.default.isUndefined(l)?_xeUtils.default.get(m,s):l;c.forEach(t=>{const{type:l,trigger:r,required:i,validator:a}=t;if("all"===e||!r||e===r)if(a){var o={itemValue:f,rule:t,rules:c,data:m,field:s,property:s,$form:g};let e;_xeUtils.default.isString(a)?(u=_vXETable.VXETable.validators.get(a))?u.itemValidatorMethod?e=u.itemValidatorMethod(o):"development"===process.env.NODE_ENV&&(0,_log.warnLog)("vxe.error.notValidators",[a]):"development"===process.env.NODE_ENV&&(0,_log.errLog)("vxe.error.notValidators",[a]):e=a(o),e&&(_xeUtils.default.isError(e)?n.push(new Rule({type:"custom",trigger:r,content:e.message,rule:new Rule(t)})):e.catch&&d.push(e.catch(e=>{n.push(new Rule({type:"custom",trigger:r,content:e?e.message:t.content||t.message,rule:new Rule(t)}))})))}else{var u="array"===l,o=_xeUtils.default.isArray(f);let e=!0;e=u||o?!o||!f.length:_xeUtils.default.isString(f)?(0,_utils.eqEmptyValue)(f.trim()):(0,_utils.eqEmptyValue)(f),(i?e||validErrorRuleValue(t,f):!e&&validErrorRuleValue(t,f))&&n.push(new Rule(t))}})}}return Promise.all(d).then(()=>{n.length&&(i[s]=n.map(e=>({$form:g,rule:e,data:m,field:s,property:s})))})})).then(()=>{if(!_xeUtils.default.isEmpty(i))return Promise.reject(i)})};let V;const w=(t,e,l)=>{var{data:r,rules:i}=n;const a=p.value,o={},u=[],s=[];return clearTimeout(V),r&&i?(t.forEach(t=>{const l=t["field"];l&&!(0,_util.isHiddenItem)(g,t)&&(0,_util.isActivetem)(g,t)&&s.push(R(e||"all",l).then(()=>{t.errRule=null}).catch(e=>{e=e[l];return o[l]||(o[l]=[]),o[l].push(e),u.push(l),t.errRule=e[0].rule,Promise.reject(e)}))}),Promise.all(s).then(()=>{l&&l()}).catch(()=>new Promise(e=>{V=window.setTimeout(()=>{t.forEach(e=>{e.errRule&&(e.showError=!0)})},20),!1!==a.autoPos&&(0,_vue.nextTick)(()=>{q(u)}),l?(l(o),e()):e(o)}))):(l&&l(),Promise.resolve())};const I=t=>{t.preventDefault(),n.preventSubmit||(T(),w(x()).then(e=>{e?l.dispatchEvent("submit-invalid",{data:n.data,errMap:e},t):l.dispatchEvent("submit",{data:n.data},t)}))},N=()=>{var e=o["tooltipStore"],t=v.value;return e.visible&&(Object.assign(e,{item:null,visible:!1}),t)&&t.close(),(0,_vue.nextTick)()};const O=(e,l,t)=>l?R(e?["blur"].includes(e.type)?"blur":"change":"all",l,t).then(()=>{T(l)}).catch(e=>{var e=e[l],t=E(l);e&&t&&(t.showError=!0,t.errRule=e[0].rule)}):(0,_vue.nextTick)();l={dispatchEvent(e,t,l){r(e,Object.assign({$form:g,$grid:i,$event:l},t))},reset:U,validate:e=>(T(),w(x(),"",e)),validateField:(e,t)=>{let l=[];return l=_xeUtils.default.isArray(e)?e:[e],w(l.map(e=>(0,_util.handleFieldOrItem)(g,e)),"",t)},clearValidate:T,updateStatus:(e,t)=>{e=e.field;return O(new Event("change"),e,t)},toggleCollapse:y,getItems:x,getItemByField:E,closeTooltip:N};t={callSlot:(e,t)=>e&&(_xeUtils.default.isString(e)&&(e=d[e]||null),_xeUtils.default.isFunction(e))?(0,_vn.getSlotVNs)(e(t)):[],triggerItemEvent:O,toggleCollapseEvent:e=>{y();var t=b();l.dispatchEvent("toggle-collapse",{status:t,collapse:t,data:n.data},e),l.dispatchEvent("collapse",{status:t,collapse:t,data:n.data},e)},triggerTitleTipEvent:(e,t)=>{var t=t["item"],l=o["tooltipStore"],r=v.value,e=e.currentTarget.children[0],i=(e.textContent||"").trim(),a=e.scrollWidth>e.clientWidth;clearTimeout(o.tooltipTimeout),l.item!==t&&N(),i&&a&&(Object.assign(l,{item:t,visible:!0}),r)&&r.open(e,i)},handleTitleTipLeaveEvent:()=>{var e=_.value;let t=v.value;t&&t.setActived(!1),e.enterable?o.tooltipTimeout=setTimeout(()=>{(t=v.value)&&!t.isActived()&&N()},e.leaveDelay):N()}};Object.assign(g,l,t);const C=(0,_vue.ref)(0),$=((0,_vue.watch)(()=>f.staticItems.length,()=>{C.value++}),(0,_vue.watch)(()=>f.staticItems,()=>{C.value++}),(0,_vue.watch)(C,()=>{f.formItems=f.staticItems}),(0,_vue.ref)(0));(0,_vue.watch)(()=>n.items?n.items.length:-1,()=>{$.value++}),(0,_vue.watch)(()=>n.items,()=>{$.value++}),(0,_vue.watch)($,()=>{h(n.items||[])}),(0,_vue.watch)(()=>n.collapseStatus,e=>{f.collapseAll=!!e});return g.renderVN=()=>{var{loading:e,className:t,data:l,customLayout:r}=n,i=f["formItems"],a=c.value,o=_.value,u=d.default;return(0,_vue.h)("form",{ref:m,class:["vxe-form",t?_xeUtils.default.isFunction(t)?t({items:i,data:l,$form:g}):t:"",{["size--"+a]:a,"is--loading":e}],onSubmit:I,onReset:S},[(0,_vue.h)("div",{class:"vxe-form--wrapper vxe-form--item-row"},r?u?u({}):[]:i.map((e,t)=>(0,_vue.h)(_formConfigItem.default,{key:t,itemConfig:e}))),(0,_vue.h)("div",{class:"vxe-form-slots",ref:"hideItem"},!r&&u?u({}):[]),(0,_vue.h)(_index.default,{class:"vxe-form--loading",modelValue:e}),s?(0,_vue.h)(_tooltip.default,Object.assign({ref:v},o)):(0,_vue.createCommentVNode)()])},n.items&&h(n.items),(0,_vue.provide)("$xeform",g),(0,_vue.provide)("$xeformgather",null),(0,_vue.provide)("$xeformitem",null),(0,_vue.provide)("$xeformiteminfo",null),g},render(){return this.renderVN()}});