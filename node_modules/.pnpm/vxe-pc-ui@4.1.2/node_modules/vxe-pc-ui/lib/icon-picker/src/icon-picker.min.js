"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_dom=require("../../ui/src/dom"),_utils=require("../../ui/src/utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default=exports.default=(0,_vue.defineComponent)({name:"VxeIconPicker",props:{modelValue:String,placeholder:String,clearable:Boolean,size:{type:String,default:()=>(0,_ui.getConfig)().iconPicker.size||(0,_ui.getConfig)().size},className:[String,Function],popupClassName:[String,Function],showIconTitle:{type:Boolean,default:()=>(0,_ui.getConfig)().iconPicker.showIconTitle},readonly:{type:Boolean,default:null},disabled:{type:Boolean,default:null},icons:Array,placement:String,transfer:{type:Boolean,default:null}},emits:["update:modelValue","change","clear","click"],setup(d,e){const t=e["emit"],l=(0,_vue.inject)("$xeModal",null),n=(0,_vue.inject)("$xeTable",null),a=(0,_vue.inject)("$xeForm",null),u=(0,_vue.inject)("xeFormItemInfo",null);var i=_xeUtils.default.uniqueId();const _=(0,_ui.useSize)(d)["computeSize"],p=(0,_vue.reactive)({initialized:!1,selectIcon:"",panelIndex:0,panelStyle:{},panelPlacement:null,visiblePanel:!1,isAniVisible:!1,isActivated:!1}),f=(0,_vue.ref)(),g=(0,_vue.ref)(),b=(0,_vue.ref)(),o={refElem:f},m={xID:i,props:d,context:e,reactData:p,getRefMaps:()=>o};let s={};const x=(0,_vue.computed)(()=>{var e=d["readonly"];return null===e?!!a&&a.props.readonly:e}),h=(0,_vue.computed)(()=>{var e=d["disabled"];return null===e?!!a&&a.props.disabled:e}),E=(0,_vue.computed)(()=>{var e=d["transfer"];if(null===e){var i=(0,_ui.getConfig)().iconPicker.transfer;if(_xeUtils.default.isBoolean(i))return i;if(n||l||a)return!0}return e}),k=(0,_vue.computed)(()=>{var e=d["placeholder"];return(e=e||(0,_ui.getConfig)().select.placeholder)?(0,_utils.getFuncText)(e):(0,_ui.getI18n)("vxe.base.pleaseSelect")}),c=(0,_vue.computed)(()=>{let e=d["icons"];return(e=e&&e.length?e:(0,_ui.getConfig)().iconPicker.icons||[]).map(e=>({title:e,icon:"vxe-icon-"+e}))}),P=(0,_vue.computed)(()=>{var e=c.value;return _xeUtils.default.chunk(e,4)}),v=()=>(0,_vue.nextTick)().then(()=>{var t=d["placement"],n=p["panelIndex"],a=f.value,u=b.value,e=E.value;if(u&&a){var o=a.offsetHeight,s=a.offsetWidth,c=u.offsetHeight,u=u.offsetWidth,n={zIndex:n},{boundingTop:a,boundingLeft:v,visibleHeight:r,visibleWidth:_}=(0,_dom.getAbsolutePos)(a);let l="bottom";if(e){let e=v,i=a+o;"top"===t?(l="top",i=a-c):t||(i+c+5>r&&(l="top",i=a-c),i<5&&(l="bottom",i=a+o)),e+u+5>_&&(e-=e+u+5-_),e<5&&(e=5),Object.assign(n,{left:e+"px",top:i+"px",minWidth:s+"px"})}else"top"===t?(l="top",n.bottom=o+"px"):t||r<a+o+c&&5<a-o-c&&(l="top",n.bottom=o+"px");return p.panelStyle=n,p.panelPlacement=l,(0,_vue.nextTick)()}});let r;const A=()=>{h.value||(clearTimeout(r),p.initialized||(p.initialized=!0),p.isActivated=!0,p.isAniVisible=!0,setTimeout(()=>{p.visiblePanel=!0},10),p.panelIndex<(0,_utils.getLastZIndex)()&&(p.panelIndex=(0,_utils.nextZIndex)()),v())},T=()=>{p.visiblePanel=!1,r=window.setTimeout(()=>{p.isAniVisible=!1},350)},I=(e,i)=>{(p.selectIcon=i)!==d.modelValue&&(t("update:modelValue",i),s.dispatchEvent("change",{value:i},e),a)&&u&&a.triggerItemEvent(e,u.itemConfig.field,i)},y=()=>{h.value||p.visiblePanel||A()},N=()=>{p.isActivated=!1},C=(e,i)=>{I(e,i),s.dispatchEvent("clear",{value:i},e)},S=(e,i)=>{C(i,null),T()},V=e=>{e.preventDefault(),(p.visiblePanel?T:A)()},L=e=>{V(e),s.dispatchEvent("click",{},e)},O=e=>{var i=p["visiblePanel"];h.value||i&&(i=b.value,((0,_dom.getEventTargetNode)(e,i).flag?v:T)())},w=e=>{var i,l,t=p["visiblePanel"];h.value||(i=f.value,l=b.value,p.isActivated=(0,_dom.getEventTargetNode)(e,i).flag||(0,_dom.getEventTargetNode)(e,l).flag,t&&!p.isActivated&&T())},B=e=>{var i,l,t,n,a,u,o,s=d["clearable"],c=p["visiblePanel"];h.value||(i=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.TAB),l=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ENTER),t=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ESCAPE),n=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ARROW_UP),a=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ARROW_DOWN),u=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.DELETE),o=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.SPACEBAR),i&&(p.isActivated=!1),c?t||i?T():l?(e.preventDefault(),e.stopPropagation()):(n||a||o)&&e.preventDefault():(n||a||l||o)&&p.isActivated&&(e.preventDefault(),A()),p.isActivated&&u&&s&&C(e,null))},K=()=>{T()},z=(s={dispatchEvent(e,i,l){t(e,(0,_ui.createEvent)(l,{$iconPicker:m},i))},isPanelVisible(){return p.visiblePanel},togglePanel(){return(p.visiblePanel?T:A)(),(0,_vue.nextTick)()},hidePanel(){return p.visiblePanel&&T(),(0,_vue.nextTick)()},showPanel(){return p.visiblePanel||A(),(0,_vue.nextTick)()},focus(){var e=g.value;return p.isActivated=!0,e.blur(),(0,_vue.nextTick)()},blur(){return g.value.blur(),(p.isActivated=!1,_vue.nextTick)()}},(e,i)=>{i=i.icon;I(e,i),T()});Object.assign(m,s);return m.renderVN=()=>{var{className:e,popupClassName:i,clearable:l}=d,{initialized:t,isActivated:n,visiblePanel:a,selectIcon:u}=p,o=_.value,s=h.value,c=E.value,v=x.value,r=k.value;return v?(0,_vue.h)("div",{ref:f,class:["vxe-ico-picker--readonly",e]},[(0,_vue.h)("i",{class:u})]):(0,_vue.h)("div",{ref:f,class:["vxe-ico-picker",e?_xeUtils.default.isFunction(e)?e({$iconPicker:m}):e:"",{["size--"+o]:o,"show--clear":l&&!s&&!!u,"is--visible":a,"is--disabled":s,"is--active":n}]},[(0,_vue.h)("div",{class:"vxe-ico-picker--inner",onClick:L},[(0,_vue.h)("input",{ref:g,class:"vxe-ico-picker--input",onFocus:y,onBlur:N}),u?(0,_vue.h)("div",{class:"vxe-ico-picker--icon"},[(0,_vue.h)("i",{class:u})]):(0,_vue.h)("div",{class:"vxe-ico-picker--placeholder"},r),(0,_vue.h)("div",{class:"vxe-ico-picker--suffix"},[(0,_vue.h)("div",{class:"vxe-ico-picker--clear-icon",onClick:S},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().INPUT_CLEAR})]),(0,_vue.h)("div",{class:"vxe-ico-picker--suffix-icon"},[(0,_vue.h)("i",{class:a?(0,_ui.getIcon)().ICON_PICKER_OPEN:(0,_ui.getIcon)().ICON_PICKER_CLOSE})])])]),(0,_vue.h)(_vue.Teleport,{to:"body",disabled:!c||!t},[(0,_vue.h)("div",{ref:b,class:["vxe-table--ignore-clear vxe-ico-picker--panel",i?_xeUtils.default.isFunction(i)?i({$iconPicker:m}):i:"",{["size--"+o]:o,"is--transfer":c,"ani--leave":p.isAniVisible,"ani--enter":a}],placement:p.panelPlacement,style:p.panelStyle},[t?(0,_vue.h)("div",{class:"vxe-ico-picker--panel-wrapper"},(()=>{const l=d["showIconTitle"];var e=P.value;const t=h.value;return(0,_vue.h)("div",{class:"vxe-ico-picker--list-wrapper"},e.map(e=>(0,_vue.h)("div",{class:"vxe-ico-picker--list"},e.map(i=>(0,_vue.h)("div",{class:"vxe-ico-picker--item",onClick(e){t||z(e,i)}},[(0,_vue.h)("div",{class:"vxe-ico-picker--item-icon"},[(0,_vue.h)("i",{class:i.icon||""})]),l?(0,_vue.h)("div",{class:"vxe-ico-picker--item-title"},""+(i.title||"")):(0,_vue.createCommentVNode)()])))))})()):(0,_vue.createCommentVNode)()])])])},(0,_vue.watch)(()=>d.modelValue,e=>{p.selectIcon=""+(e||"")}),(0,_vue.onMounted)(()=>{_ui.globalEvents.on(m,"mousewheel",O),_ui.globalEvents.on(m,"mousedown",w),_ui.globalEvents.on(m,"keydown",B),_ui.globalEvents.on(m,"blur",K)}),(0,_vue.onUnmounted)(()=>{_ui.globalEvents.off(m,"mousewheel"),_ui.globalEvents.off(m,"mousedown"),_ui.globalEvents.off(m,"keydown"),_ui.globalEvents.off(m,"blur")}),(0,_vue.provide)("$xeIconPicker",m),m},render(){return this.renderVN()}});