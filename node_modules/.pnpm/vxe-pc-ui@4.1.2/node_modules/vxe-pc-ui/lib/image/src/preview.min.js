"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_ui=require("../../ui"),_xeUtils=_interopRequireDefault(require("xe-utils")),_dom=require("../..//ui/src/dom");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default=exports.default=(0,_vue.defineComponent)({name:"VxeImagePreview",props:{modelValue:Number,urlList:Array,urlField:{type:String,default:()=>(0,_ui.getConfig)().imagePreview.urlField},maskClosable:{type:Boolean,default:()=>(0,_ui.getConfig)().imagePreview.maskClosable},marginSize:{type:String,default:()=>(0,_ui.getConfig)().imagePreview.marginSize},showPrintButton:{type:Boolean,default:()=>(0,_ui.getConfig)().imagePreview.showPrintButton},showDownloadButton:{type:Boolean,default:()=>(0,_ui.getConfig)().imagePreview.showDownloadButton}},emits:["update:modelValue","change","close"],setup(u,e){const o=e["emit"];var t=_xeUtils.default.uniqueId();const i=(0,_vue.ref)(),a={refElem:i},c=(0,_vue.reactive)({activeIndex:u.modelValue||0,offsetPct11:!1,offsetScale:0,offsetRotate:0,offsetLeft:0,offsetTop:0}),s=(0,_vue.computed)(()=>u.urlField||"url"),_=(0,_vue.computed)(()=>_xeUtils.default.toNumber(u.marginSize||0)||16),v=(0,_vue.computed)(()=>{var e=c["offsetRotate"];return e?e+"°":"0°"}),r=(0,_vue.computed)(()=>{var e=c["offsetScale"];return e?_xeUtils.default.ceil(100*(1+e))+"%":"100%"}),n=(0,_vue.computed)(()=>{var e=u["urlList"];const t=s.value;return e&&e.length?e.map(e=>_xeUtils.default.isString(e)?e:e[t]||""):[]}),l=(0,_vue.computed)(()=>{var{offsetScale:e,offsetRotate:a,offsetLeft:o,offsetTop:i}=c,s=[];let u=1;if(e&&(u=1+e,s.push(`scale(${u})`)),a&&s.push(`rotate(${a}deg)`),o||i){let e=o/=u,t=i/=u;if(a)switch(a%360){case 90:case-270:e=i,t=-o;break;case 180:case-180:e=-o,t=-i;break;case 270:case-90:e=-i,t=o}s.push(`translate(${e}px, ${t}px)`)}return s.length?s.join(" "):""}),f={computeImgList:n},m={xID:t,props:u,context:e,reactData:c,getRefMaps:()=>a,getComputeMaps:()=>f},p={dispatchEvent(e,t,a){o(e,(0,_ui.createEvent)(a,{$imagePreview:m},t))}},d=e=>{c.activeIndex=e,o("update:modelValue",e)},g=e=>{p.dispatchEvent("close",{},e)};const E=()=>{var e=i.value;(0,_dom.removeClass)(e,"is--move"),Object.assign(c,{offsetPct11:!1,offsetScale:0,offsetRotate:0,offsetLeft:0,offsetTop:0})},h=()=>{var e=c["offsetScale"];let t=.02;return t=-.6<=e&&(t=.04,-.4<=e)&&(t=.07,0<=e)&&(t=.1,3<=e)&&(t=.25,8<=e)&&(t=.4,16<=e)&&(t=.6,24<=e)&&(t=.9,32<=e)&&(t=1.3,39<=e)&&(t=1.9,45<=e)?2.5:t},x=e=>{var t=c["offsetScale"],a=h();c.offsetScale=e?Number(Math.min(49,t+a).toFixed(2)):Number(Math.max(-.9,t-a).toFixed(2))},I=e=>{let t=c.activeIndex||0;var a=n.value;e?t>=a.length-1?t=0:t++:t<=0?t=a.length-1:t--,E(),c.activeIndex=t,d(t)},w=e=>{let t=c.offsetRotate;e?t+=90:t-=90,c.offsetRotate=t},b=()=>{var e=c["activeIndex"],e=n.value[e||0];_ui.VxeUI.print&&_ui.VxeUI.print({align:"center",pageBreaks:[{bodyHtml:`<img src="${e}" style="max-width:100%;max-height:100%;">`}]})},R=e=>{var t=c["activeIndex"];if(n.value[t||0])switch(e){case"zoomOut":x(!1);break;case"zoomIn":x(!0);break;case"pctFull":E();break;case"pct11":E(),c.offsetPct11=!0;break;case"rotateLeft":w(!1);break;case"rotateRight":w(!0);break;case"print":b();break;case"download":{var a=c["activeIndex"];const o=n.value[a||0];_ui.VxeUI.saveFile&&fetch(o).then(e=>{e.blob().then(e=>{_ui.VxeUI.saveFile({filename:o,content:e})})})}}},P=e=>{e=e.deltaY;0<e?x(!1):e<0&&x(!0)},V=e=>{const{offsetTop:s,offsetLeft:u}=c,v=i.value,t=(e.preventDefault(),document.onmousemove),a=document.onmouseup,r=e.pageX,n=e.pageY,l=_.value;document.onmousemove=e=>{var{pageX:t,pageY:a}=e,{visibleHeight:o,visibleWidth:i}=(0,_dom.getDomNode)();e.preventDefault(),(0,_dom.addClass)(v,"is--move"),t>l&&a>l&&t<i-l&&a<o-l&&(c.offsetLeft=u+t-r,c.offsetTop=s+a-n)},document.onmouseup=()=>{document.onmousemove=t,document.onmouseup=a,(0,_dom.removeClass)(v,"is--move")}},L=e=>{var t=e.ctrlKey,a=e.shiftKey,o=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ARROW_UP),i=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ARROW_DOWN),s=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ARROW_LEFT),u=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ARROW_RIGHT),v=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.R),r=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.P);o?(e.preventDefault(),a?--c.offsetTop:x(!0)):i?(e.preventDefault(),a?c.offsetTop+=1:x(!1)):s?(e.preventDefault(),a?--c.offsetLeft:I(!1)):u?(e.preventDefault(),a?c.offsetLeft+=1:I(!0)):v&&t?(e.preventDefault(),a?w(!1):w(!0)):r&&t&&(e.preventDefault(),b())},O=e=>{u.maskClosable&&e.target===e.currentTarget&&p.dispatchEvent("close",{},e)},T=(Object.assign(m,p,{}),(e,t)=>(0,_vue.h)("div",{class:"vxe-image-preview--operation-btn",title:(0,_ui.getI18n)("vxe.imagePreview.operBtn."+e),onClick(){R(e)}},[(0,_vue.h)("i",{class:(0,_ui.getIcon)()[t]})]));t=()=>{var e=c["offsetPct11"];return(0,_vue.h)("div",{ref:i,class:["vxe-image-preview",{"is--pct11":e}],onWheel:P},[(()=>{const a=c["activeIndex"];var e=n.value;const o=l.value;return(0,_vue.h)("div",{class:"vxe-image-preview--img-list",onClick:O},e.map((e,t)=>{t=a===t;return(0,_vue.h)("img",{class:["vxe-image-preview--img-item",{"is--active":t}],src:e,style:t?{transform:o}:null,onMousedown(e){V(e)}})}))})(),(()=>{var{showPrintButton:e,showDownloadButton:t}=u,a=c["activeIndex"],o=n.value,i=v.value,s=r.value;return(0,_vue.h)("div",{class:"vxe-image-preview--btn-wrapper"},[(0,_vue.h)("div",{class:"vxe-image-preview--close-wrapper"},[(0,_vue.h)("div",{class:"vxe-image-preview--close-btn",onClick:g},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().IMAGE_PREVIEW_CLOSE})]),(0,_vue.h)("div",{class:"vxe-image-preview--close-bg"})]),1<o.length?(0,_vue.h)("div",{class:"vxe-image-preview--previous-btn",onClick(){I(!1)}},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().IMAGE_PREVIEW_PREVIOUS})]):(0,_vue.createCommentVNode)(),1<o.length?(0,_vue.h)("div",{class:"vxe-image-preview--next-btn",onClick(){I(!0)}},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().IMAGE_PREVIEW_NEXT})]):(0,_vue.createCommentVNode)(),(0,_vue.h)("div",{class:"vxe-image-preview--operation-info"},[(0,_vue.h)("div",{class:"vxe-image-preview--operation-deg"},i),(0,_vue.h)("div",{class:"vxe-image-preview--operation-pct"},s)]),(0,_vue.h)("div",{class:"vxe-image-preview--operation-wrapper"},[(0,_vue.h)("div",{class:"vxe-image-preview--operation-active-count"},[(0,_vue.h)("span",{class:"vxe-image-preview--operation-active-current"},""+((a||0)+1)),(0,_vue.h)("span",{class:"vxe-image-preview--operation-active-total"},"/"+o.length)]),T("zoomOut","IMAGE_PREVIEW_ZOOM_OUT"),T("zoomIn","IMAGE_PREVIEW_ZOOM_IN"),T("pctFull","IMAGE_PREVIEW_PCT_FULL"),T("pct11","IMAGE_PREVIEW_PCT_1_1"),T("rotateLeft","IMAGE_PREVIEW_ROTATE_LEFT"),T("rotateRight","IMAGE_PREVIEW_ROTATE_RIGHT"),e?T("print","IMAGE_PREVIEW_PRINT"):(0,_vue.createCommentVNode)(),t?T("download","IMAGE_PREVIEW_DOWNLOAD"):(0,_vue.createCommentVNode)()])])})()])};return m.renderVN=t,(0,_vue.watch)(()=>u.modelValue,e=>{c.activeIndex=e,E()}),(0,_vue.onMounted)(()=>{_ui.globalEvents.on(m,"keydown",L)}),(0,_vue.onBeforeUnmount)(()=>{var e=i.value;(0,_dom.removeClass)(e,"is--move")}),(0,_vue.onUnmounted)(()=>{_ui.globalEvents.off(m,"keydown")}),(0,_vue.provide)("$xeImagePreview",m),t}});