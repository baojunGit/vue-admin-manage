"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_dom=require("../../ui/src/dom"),_utils=require("../../ui/src/utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default=exports.default=(0,_vue.defineComponent)({name:"VxePulldown",props:{modelValue:Boolean,disabled:Boolean,placement:String,trigger:{type:String,default:(0,_ui.getConfig)().pulldown.trigger},size:{type:String,default:()=>(0,_ui.getConfig)().size},options:Array,className:{type:[String,Function],default:(0,_ui.getConfig)().pulldown.className},popupClassName:[String,Function],showPopupShadow:Boolean,destroyOnClose:{type:Boolean,default:(0,_ui.getConfig)().pulldown.destroyOnClose},transfer:{type:Boolean,default:null}},emits:["update:modelValue","click","option-click","hide-panel"],setup(g,e){const{slots:x,emit:i}=e,t=(0,_vue.inject)("$xeModal",null),n=(0,_vue.inject)("$xeTable",null),a=(0,_vue.inject)("$xeForm",null);var l=_xeUtils.default.uniqueId();const w=(0,_ui.useSize)(g)["computeSize"],h=(0,_vue.reactive)({initialized:!1,panelIndex:0,panelStyle:null,panelPlacement:null,visiblePanel:!1,animatVisible:!1,isActivated:!1}),P=(0,_vue.ref)(),y=(0,_vue.ref)(),T=(0,_vue.ref)(),V=(0,_vue.computed)(()=>{var e=g["transfer"];if(null===e){var l=(0,_ui.getConfig)().pulldown.transfer;if(_xeUtils.default.isBoolean(l))return l;if(n||t||a)return!0}return e}),o={refElem:P},C={xID:l,props:g,context:e,reactData:h,getRefMaps:()=>o};const u=()=>{h.panelIndex<(0,_utils.getLastZIndex)()&&(h.panelIndex=(0,_utils.nextZIndex)())};const s=()=>(0,_vue.nextTick)().then(()=>{var i=g["placement"],{panelIndex:n,visiblePanel:a}=h,e=V.value;if(a){var a=y.value,o=T.value;if(o&&a){var u=a.offsetHeight,s=a.offsetWidth,d=o.offsetHeight,o=o.offsetWidth,n={zIndex:n},{boundingTop:a,boundingLeft:r,visibleHeight:v,visibleWidth:p}=(0,_dom.getAbsolutePos)(a);let t="bottom";if(e){let e=r,l=a+u;"top"===i?(t="top",l=a-d):i||(l+d+5>v&&(t="top",l=a-d),l<5&&(t="bottom",l=a+u)),e+o+5>p&&(e-=e+o+5-p),e<5&&(e=5),Object.assign(n,{left:e+"px",top:l+"px",minWidth:s+"px"})}else"top"===i?(t="top",n.bottom=u+"px"):i||v<a+u+d&&5<a-u-d&&(t="top",n.bottom=u+"px");h.panelStyle=n,h.panelPlacement=t}}return(0,_vue.nextTick)()});let d;const r=()=>(h.initialized||(h.initialized=!0),new Promise(e=>{g.disabled?(0,_vue.nextTick)(()=>{e()}):(clearTimeout(d),h.isActivated=!0,h.animatVisible=!0,setTimeout(()=>{h.visiblePanel=!0,i("update:modelValue",!0),s(),setTimeout(()=>{e(s())},40)},10),u())})),v=()=>(h.visiblePanel=!1,i("update:modelValue",!1),new Promise(e=>{h.animatVisible?d=window.setTimeout(()=>{(h.animatVisible=!1,_vue.nextTick)(()=>{e()})},350):(0,_vue.nextTick)(()=>{e()})}));const k=(e,l)=>{l.disabled||(v(),f("option-click",{option:l},e))},E=e=>{var l=g["trigger"];"click"===l&&(h.visiblePanel?v:r)(),f("click",{$pulldown:C},e)},p=e=>{var l=g["disabled"],t=h["visiblePanel"],i=T.value;l||t&&((0,_dom.getEventTargetNode)(e,i).flag?s():(v(),f("hide-panel",{},e)))},c=e=>{var l=g["disabled"],t=h["visiblePanel"],i=P.value,n=T.value;l||(h.isActivated=(0,_dom.getEventTargetNode)(e,i).flag||(0,_dom.getEventTargetNode)(e,n).flag,t&&!h.isActivated&&(v(),f("hide-panel",{},e)))},_=e=>{h.visiblePanel&&(h.isActivated=!1,v(),f("hide-panel",{},e))},f=(e,l,t)=>{i(e,(0,_ui.createEvent)(t,{$pulldown:C},l))};l={dispatchEvent:f,isPanelVisible:()=>h.visiblePanel,togglePanel:()=>(h.visiblePanel?v:r)(),showPanel:r,hidePanel:v},Object.assign(C,l),(0,_vue.watch)(()=>g.modelValue,e=>{(e?r:v)()}),(0,_vue.nextTick)(()=>{_ui.globalEvents.on(C,"mousewheel",p),_ui.globalEvents.on(C,"mousedown",c),_ui.globalEvents.on(C,"blur",_)}),(0,_vue.onUnmounted)(()=>{_ui.globalEvents.off(C,"mousewheel"),_ui.globalEvents.off(C,"mousedown"),_ui.globalEvents.off(C,"blur")});return C.renderVN=()=>{var{className:e,options:l,popupClassName:t,showPopupShadow:i,destroyOnClose:n,disabled:a}=g,{initialized:o,isActivated:u,animatVisible:s,visiblePanel:d,panelStyle:r,panelPlacement:v}=h,p=V.value,c=w.value,_=x.default,f=x.header,m=x.footer,b=x.dropdown;return(0,_vue.h)("div",{ref:P,class:["vxe-pulldown",e?_xeUtils.default.isFunction(e)?e({$pulldown:C}):e:"",{["size--"+c]:c,"is--visible":d,"is--disabled":a,"is--active":u}]},[(0,_vue.h)("div",{ref:y,class:"vxe-pulldown--content",onClick:E},_?_({$pulldown:C}):[]),(0,_vue.h)(_vue.Teleport,{to:"body",disabled:!p||!o},[(0,_vue.h)("div",{ref:T,class:["vxe-table--ignore-clear vxe-pulldown--panel",t?_xeUtils.default.isFunction(t)?t({$pulldown:C}):t:"",{["size--"+c]:c,"is--shadow":i,"is--transfer":p,"animat--leave":s,"animat--enter":d}],placement:v,style:r},[(0,_vue.h)("div",{class:"vxe-pulldown--panel-wrapper"},!o||n&&!d&&!s?[]:[f?(0,_vue.h)("div",{class:"vxe-pulldown--panel-header"},f({$pulldown:C})):(0,_vue.createCommentVNode)(),(0,_vue.h)("div",{class:"vxe-pulldown--panel-body"},b?b({$pulldown:C}):[(e=>{const t=x.option;return(0,_vue.h)("div",{class:"vxe-pulldown--panel-list"},e?e.map(l=>(0,_vue.h)("div",{class:"vxe-pulldown--panel-item",onClick(e){k(e,l)}},t?t({$pulldown:C,option:l}):""+(l.label||""))):[])})(l)]),m?(0,_vue.h)("div",{class:"vxe-pulldown--panel-footer"},m({$pulldown:C})):(0,_vue.createCommentVNode)()])])])])},C},render(){return this.renderVN()}});