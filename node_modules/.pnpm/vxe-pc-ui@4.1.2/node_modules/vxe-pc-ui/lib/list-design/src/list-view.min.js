"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_ui=require("../../ui"),_log=require("../../ui/src/log"),_dom=require("../../ui/src/dom"),_vn=require("../../ui/src/vn"),_util=require("../render/util"),_loading=_interopRequireDefault(require("../../loading/src/loading")),_xeUtils=_interopRequireDefault(require("xe-utils"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default=exports.default=(0,_vue.defineComponent)({name:"VxeListView",props:{config:Object,height:{type:[String,Number],default:()=>(0,_ui.getConfig)().listView.height},loading:Boolean,formData:Object,actionButtons:Array,gridOptions:Object,gridEvents:Object,viewRender:Object},emits:["cell-action","update:formData","update:actionButtons"],setup(r,e){const s=_ui.VxeUI.getComponent("VxeGrid"),{emit:l,slots:a}=e;var t=_xeUtils.default.uniqueId();const u=(0,_vue.ref)(),c=(0,_vue.ref)(),d=(0,_vue.reactive)({searchFormData:{},searchFormItems:[],listTableColumns:[],tableColumns:[]}),m=(0,_vue.computed)(()=>{var e=r["gridOptions"],{tableColumns:t,searchFormData:i,searchFormItems:o}=d,e=e||{},n=Object.assign({minWidth:120},e.columnConfig);let s;return e.proxyConfig&&(s=Object.assign({autoLoad:!1},e.proxyConfig)),Object.assign({},e,{columns:t,columnConfig:n,formConfig:{data:i,items:o},proxyConfig:s})}),f=(0,_vue.computed)(()=>{var e=r["gridEvents"];const i={};return _xeUtils.default.each(e,(e,t)=>{i[_xeUtils.default.camelCase("on-"+t)]=e}),i}),i={refElem:u,refGrid:c},o={},v={xID:t,props:r,context:e,reactData:d,getRefMaps:()=>i,getComputeMaps:()=>o},g=[],n=[],p=(_ui.renderer.forEach((e,t)=>{var i,e=e["createListDesignSettingActionButtonConfig"];e&&(i={name:t},("custom"===(t=Object.assign((0,_util.createListDesignActionButton)({code:t}),e(i))).type?n:g).push(t))}),e=>{if(e&&e.length){const i={};var t=e.map(e=>(i[e.field]=null,{field:e.field,title:e.title,folding:e.folding,itemRender:e.itemRender}));return t.push({field:"active",title:"",folding:!1,collapseNode:e.some(e=>e.folding),itemRender:{name:"VxeButtonGroup",options:[{content:"查询",icon:"vxe-icon-search",status:"primary",type:"submit"},{content:"重置",icon:"vxe-icon-repeat",type:"reset"}]}}),{items:t,data:i}}return{items:[],data:{}}}),_=e=>e?e.map(e=>({field:e.field,title:e.title,visible:!!e.visible,width:e.width,cellRender:_xeUtils.default.clone(e.cellRender)})):[];const h=e=>{if(e){var{formConfig:e,searchItems:t,listColumns:i}=e;{t=t||[];const{data:o,items:n}=p(t);d.searchFormData=o,d.searchFormItems=n,l("update:formData",o),(0,_vue.nextTick)()}{t=i||[];i=e||{};const s=t||[],{columns:r,actionButtons:a}=x(s,i);d.listTableColumns=s,d.tableColumns=r,l("update:actionButtons",a),(0,_vue.nextTick)(()=>{const e=m.value;if(e.proxyConfig)b("reload")})}}return(0,_vue.nextTick)()},x=(e,t)=>{var{showSeq:t,actionButtonList:i}=Object.assign({},t);const o=[],n=a.cellAction;if(t&&o.push({type:"seq",field:"_seq",width:70}),_(e||[]).forEach(e=>{o.push(e)}),i&&i.length){t={field:"_active",title:(0,_ui.getI18n)("vxe.table.actionTitle"),fixed:"right",width:"auto"};const l=[];i.forEach(t=>{if("custom"===t.type)return{content:t.name,name:t.code,icon:t.icon};var e,i=g.find(e=>e.code===t.code);let o=t.name,n=t.icon,s=t.status,r=t.permissionCode,a=t.classify;i&&(e=i.name,n=i.icon||"",s=i.status||"",r=i.permissionCode||"",a=i.classify||"",o=_xeUtils.default.toValueString(_xeUtils.default.isFunction(e)?e({name:i.code||""}):e)),a&&"cellButton"!==a||l.push({content:o,name:t.code,icon:n,status:s,permissionCode:r})}),n?t.slots={default(e){return n(Object.assign(Object.assign({},e),{buttons:l}))}}:t.cellRender={name:"VxeButtonGroup",props:{mode:"text"},options:l,events:{click(e,t){var i=t["option"];C("cell-action",Object.assign(Object.assign({},e),{button:i}),t.$event)}}},o.push(t)}return{columns:o,actionButtons:i}};const b=(e,...t)=>{var i=c.value;return i?i.commitProxy(e,...t):Promise.resolve()},C=(e,t,i)=>{l(e,(0,_ui.createEvent)(i,{$listView:v},t))};t={dispatchEvent:C,clearConfig:()=>(l("update:formData",{}),d.searchFormData={},d.searchFormItems=[],d.listTableColumns=[],d.tableColumns=[],(0,_vue.nextTick)()),loadConfig:h,parseConfig:e=>{var{formConfig:e,searchItems:t,listColumns:i}=e||{},{columns:i,actionButtons:e}=x(i||[],e),{data:t,items:o}=(t=t||[],p(t||[]));return{formData:t,formItems:o,tableColumns:i,actionButtons:e}},getQueryFilter:()=>{const{searchFormData:o,searchFormItems:e}=d,n=[];var t={items:n,type:"and"};return c.value&&e.forEach(e=>{var t,e=e["field"],i=o[e];i&&((t=[]).push({field:e,value:i,match:"",type:_xeUtils.default.isArray(i)?"array":""}),n.push({condition:t,type:"and"}))}),t},commitProxy:b};Object.assign(v,t,{});return v.renderVN=()=>{var{height:e,loading:t}=r,i=a.grid,o=m.value,n=f.value;return(0,_vue.h)("div",{ref:u,class:["vxe-list-view",{"is--loading":t}],style:e?{height:(0,_dom.toCssUnit)(e)}:null},[(0,_vue.h)("div",{class:"vxe-list-view--body"},[i?(0,_vue.h)("div",{class:"vxe-list-view--grid-wrapper"},(0,_vn.getSlotVNs)(i({$listView:v}))):s?(0,_vue.h)(s,Object.assign({},o,n,{ref:c}),Object.assign({},a,{default:void 0})):(0,_vue.createCommentVNode)()]),(0,_vue.h)(_loading.default,{class:"vxe-list-view--loading",modelValue:t})])},(0,_vue.watch)(()=>r.config,e=>{h(e||{})}),r.config&&h(r.config),(0,_vue.provide)("$xeListView",v),"development"===process.env.NODE_ENV&&(0,_vue.nextTick)(()=>{s||(0,_log.errLog)("vxe.error.reqComp",["vxe-grid"])}),v},render(){return this.renderVN()}});