"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_vn=require("../../ui/src/vn"),_defaultSettingData=require("./default-setting-data"),_form=_interopRequireDefault(require("../../form/src/form")),_formGather=_interopRequireDefault(require("../../form/src/form-gather")),_formItem=_interopRequireDefault(require("../../form/src/form-item")),_widgetInfo=require("./widget-info"),_log=require("../../ui/src/log");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default=exports.default=(0,_vue.defineComponent)({name:"VxeFormView",props:{modelValue:Object,config:Object,readonly:Boolean,disabled:Boolean,viewRender:Object,createFormConfig:Function},emits:["update:modelValue","submit","reset"],setup(s,e){const{emit:i,slots:l}=e;var t=_xeUtils.default.uniqueId();const m=(0,_vue.ref)(),v=(0,_vue.ref)(),g=(0,_vue.inject)("$xeFormDesignLayoutStyle",null),c=(0,_vue.reactive)({formConfig:{},formRules:{},widgetObjList:[]}),r={refElem:m},a={},_={xID:t,props:s,context:e,reactData:c,getRefMaps:()=>r,getComputeMaps:()=>a};const o=e=>{var t;return e&&({formConfig:e,widgetData:t}=e,n(e||{}),p(t||[])),(0,_vue.nextTick)()};const u=e=>{var{viewRender:t,createFormConfig:r}=s,e={viewRender:t,formConfig:e};return r?r(e):(r=(t||{})["name"],r=(t=_ui.renderer.get(r)||{})?t.createFormViewFormConfig:null,Object.assign({},(r||_defaultSettingData.createDefaultFormViewPCFormConfig)(e)))},n=e=>(c.formConfig=u(e),(0,_vue.nextTick)()),d=e=>{const o={},u={};return _xeUtils.default.eachTree(e,e=>{var{name:t,field:r,required:i}=e,t=_ui.renderer.get(t)||{},a=t.createFormDesignWidgetFieldValue,t=t.createFormDesignWidgetFieldRules;o[r]=a?a({widget:e,$formView:_}):V(e),t?(a=t({widget:e,$formView:_}))&&a.length&&(u[r]=a):i&&(u[r]=w())},{children:"children"}),{formData:o,formRules:u}},f=e=>(e||[]).map(e=>(0,_widgetInfo.configToWidget)(e)),p=e=>{var e=f(e),{formData:e,formRules:t}=(c.widgetObjList=e,d(e));return c.formRules=t,i("update:modelValue",Object.assign(e,s.modelValue)),(0,_vue.nextTick)()},V=e=>"subtable"===e.name?[]:null,w=()=>[{required:!0,content:"该填写该字段！"}],b=(e,t)=>{var e=e["field"],r=v.value;return r&&r.updateStatus({field:e},t),(0,_vue.nextTick)()};const x=(e,t,r)=>{i(e,(0,_ui.createEvent)(r,{$formView:_},t))},C=e=>e?_xeUtils.default.isArray(e)?e.map(e=>e.name):[e.name]:null;t={dispatchEvent:x,clearConfig:()=>o({formConfig:{},widgetData:[]}),loadConfig:o,parseConfig:e=>{var{formConfig:e,widgetData:t}=e||{},t=f(t||[]);return Object.assign(Object.assign({},d(t)),{formConfig:u(e||{}),widgetData:t})},loadFormConfig:n,loadWidgetData:p,updateWidgetStatus:b,setItemValue:(e,t)=>{var r=s["modelValue"],e=e["field"],i=v.value;return r&&(r[e]=t),i&&i.updateStatus({field:e},t),(0,_vue.nextTick)()},getItemValue:e=>{var t=s["modelValue"];return t?t[e.field]:null},validate(){var e=v.value;return e?e.validate():(0,_vue.nextTick)()},validateWidget(e){var t=v.value;return t?t.validateField(C(e)):(0,_vue.nextTick)()},clearValidate(e){var t=v.value;return t?t.clearValidate(C(e)):(0,_vue.nextTick)()},reset(){var e=v.value;return e?e.reset():(0,_vue.nextTick)()},updateItemStatus(e,t){return(0,_log.warnLog)("vxe.error.delFunc",["updateItemStatus","updateWidgetStatus"]),b(e,t)}};const D=e=>{x("submit",e,e.$event)},h=e=>{x("reset",e,e.$event)};Object.assign(_,t,{});return _.renderVN=()=>{var{readonly:e,disabled:t,modelValue:r}=s;const{formConfig:i,formRules:a,widgetObjList:o}=c;var u=l.top,n=l.bottom;const d=l.header,f=l.footer;return(0,_vue.h)("div",{ref:m,class:"vxe-form-view"},[u?(0,_vue.h)("div",{class:"vxe-form-view--top"},(0,_vn.getSlotVNs)(u({$formView:_}))):(0,_vue.createCommentVNode)(),(0,_vue.h)(_form.default,{ref:v,data:r,customLayout:!0,readonly:e,disabled:t,span:24,vertical:i.vertical,titleBold:i.titleBold,titleColon:i.titleColon,titleAlign:i.titleAlign,titleWidth:i.titleWidth,rules:a,onSubmit:D,onReset:h},{default(){const{readonly:n,disabled:l}=s;return[d?(0,_vue.h)(_formItem.default,{},{default(){return d({})}}):(0,_vue.createCommentVNode)(),...o.map(e=>{var t=e["name"],t=_ui.renderer.get(t)||{};const r=t.renderFormDesignWidgetView,i=t.renderFormDesignWidgetPreview,a=t.renderFormDesignWidgetMobilePreview;t=!!g;const o=e,u={widget:e,readonly:!!n,disabled:!!l,isEditMode:t,isViewMode:!t,$formDesign:null,$formView:_};return(0,_vue.h)(_formGather.default,{key:e.id},{default(){if(g)if(2===g.reactData.activeTab){if(a)return(0,_vn.getSlotVNs)(a(o,u))}else if(i)return(0,_vn.getSlotVNs)(i(o,u));return r?(0,_vn.getSlotVNs)(r(o,u)):[]}})}),f?(0,_vue.h)(_formGather.default,{span:24},{default(){return f({})}}):(0,_vue.createCommentVNode)()]}}),n?(0,_vue.h)("div",{class:"vxe-form-view--bottom"},(0,_vn.getSlotVNs)(n({$formView:_}))):(0,_vue.createCommentVNode)()])},(0,_vue.watch)(()=>s.config,e=>{o(e||{})}),s.config&&o(s.config),(0,_vue.provide)("$xeFormView",_),_},render(){return this.renderVN()}});