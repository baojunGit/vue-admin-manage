"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_ui=require("../../ui"),_dom=require("../../ui/src/dom"),_widgetInfo=require("./widget-info"),_xeUtils=_interopRequireDefault(require("xe-utils")),_button=_interopRequireDefault(require("../../button/src/button")),_layoutWidget=_interopRequireDefault(require("./layout-widget")),_layoutPreview=_interopRequireDefault(require("./layout-preview")),_layoutSetting=_interopRequireDefault(require("./layout-setting")),_layoutStyle=_interopRequireDefault(require("./layout-style")),_defaultSettingData=require("./default-setting-data");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default=exports.default=(0,_vue.defineComponent)({name:"VxeFormDesign",props:{size:{type:String,default:()=>(0,_ui.getConfig)().formDesign.size},config:Object,height:{type:[String,Number],default:()=>(0,_ui.getConfig)().formDesign.height},widgets:{type:Array,default:()=>_xeUtils.default.clone((0,_ui.getConfig)().formDesign.widgets)||[]},showHeader:{type:Boolean,default:()=>(0,_ui.getConfig)().formDesign.showHeader},showPc:{type:Boolean,default:()=>(0,_ui.getConfig)().formDesign.showPc},showMobile:{type:Boolean,default:()=>(0,_ui.getConfig)().formDesign.showMobile},formRender:Object},emits:["click-widget","add-widget","copy-widget","remove-widget","drag-widget"],setup(u,e){const{emit:r,slots:n}=e;var t=_xeUtils.default.uniqueId();const o=(0,_vue.ref)(),d=(0,_vue.ref)(),g=(0,_vue.reactive)({formData:{},widgetConfigs:[],widgetObjList:[],dragWidget:null,sortWidget:null,activeWidget:null,sortSubWidget:null});var i=(0,_vue.reactive)({});const a={refElem:o},l={},s={xID:t,props:u,context:e,reactData:g,internalData:i,getRefMaps:()=>a,getComputeMaps:()=>l},f=e=>new _widgetInfo.FormDesignWidgetInfo(s,e,g.widgetObjList),c=()=>new _widgetInfo.FormDesignWidgetInfo(s,"",g.widgetObjList),v=e=>{var t;return e&&({formConfig:e,widgetData:t}=e,e&&h(e),t)&&p(t),(0,_vue.nextTick)()};const _=()=>_xeUtils.default.clone(g.formData,!0),h=e=>(g.formData=Object.assign({},C(),e),(0,_vue.nextTick)()),m=()=>{var e=_xeUtils.default.clone(g.widgetObjList,!0);return _xeUtils.default.eachTree(e,e=>{e.model.value=null},{children:"children"}),e},p=e=>(g.widgetObjList=(e||[]).map(e=>(0,_widgetInfo.configToWidget)(e)),(0,_vue.nextTick)()),w=()=>{var e=d.value;return e&&e.openStylePreview(),(0,_vue.nextTick)()},x=()=>(g.widgetObjList=[],W(),(0,_vue.nextTick)()),D={dispatchEvent(e,t,i){r(e,(0,_ui.createEvent)(i,{$xeFormDesign:s},t))},createWidget:f,createEmptyWidget:c,getConfig(){return{formConfig:_(),widgetData:m()}},clearConfig:x,loadConfig:v,reloadConfig:e=>(x(),v(e)),getFormConfig:_,loadFormConfig:h,getFormData(){var e=g["widgetObjList"];const t={};return _xeUtils.default.eachTree(e,e=>{t[e.field]=null},{children:"children"}),t},getWidgetData:m,loadWidgetData:p,refreshPreviewView(){var e=d.value;return e&&e.updatePreviewView(),(0,_vue.nextTick)()},openStyleSetting:w},y=()=>{var e=u["widgets"],t=[];const n=[],o=[],d=[],a=[];_ui.renderer.forEach((e,t)=>{e=e.createFormDesignWidgetConfig;if(e){var i=f(t),e=(0,_widgetInfo.getWidgetConfigGroup)(t);const r=(0,_widgetInfo.getWidgetConfigCustomGroup)(t,s);if(r){t=a.find(e=>e.title===r);t?t.children.push(i):a.push({title:r,children:[i]})}else switch(e){case"layout":o.push(i);break;case"advanced":d.push(i);break;default:["title"].includes(i.name)||n.push(i)}}}),n.length&&t.push({group:"base",children:n}),o.length&&t.push({group:"layout",children:o}),d.length&&t.push({group:"advanced",children:d}),a.length&&t.push(...a),e&&e.length?g.widgetConfigs=u.widgets.map(e=>({title:e.customGroup,group:e.group,children:e.children?e.children.map(e=>{return f(e)}):[]})):g.widgetConfigs=t},b=t=>{var e=g["widgetObjList"];if((0,_widgetInfo.getWidgetConfigUnique)(t)){const i=[];_xeUtils.default.eachTree(e,e=>{e.name===t&&i.push(e)},{children:"children"});e=i.length<1;return e||_ui.VxeUI.modal&&_ui.VxeUI.modal.message({content:(0,_ui.getI18n)("vxe.formDesign.error.wdFormUni"),status:"error",id:"wdFormUni"}),e}return!0};t={validWidgetUnique:b,handleClickWidget(e,t){t&&t.name&&(e.stopPropagation(),g.activeWidget=t,D.dispatchEvent("click-widget",{widget:t},e))},handleCopyWidget(e,t){var i,r=g["widgetObjList"],n=_xeUtils.default.findTree(r,e=>e.id===t.id,{children:"children"});n&&(e.stopPropagation(),b(t.name))&&(n=n["path"],n=Number(n[0]),(i=f(t.name)).title&&(i.title=(0,_ui.getI18n)("vxe.formDesign.widget.copyTitle",[(""+t.title).replace((0,_ui.getI18n)("vxe.formDesign.widget.copyTitle",[""]),"")])),n>=r.length-1?r.push(i):r.splice(n+1,0,i),g.activeWidget=i,g.widgetObjList=[...r],D.dispatchEvent("copy-widget",{widget:t,newWidget:i},e))},handleRemoveWidget(e,t){var i,r,n=g["widgetObjList"],o=_xeUtils.default.findTree(n,e=>e.id===t.id,{children:"children"});o&&({index:o,parent:i,items:r}=o,e.stopPropagation(),o>=r.length-1?g.activeWidget=r[o-1]:g.activeWidget=r[o+1]||null,i&&"row"===i.name?r[o]=c():r.splice(o,1),g.widgetObjList=[...n],D.dispatchEvent("remove-widget",{widget:t},e))}};const C=()=>{var{formRender:e,showPc:t,showMobile:i}=u;let r=(0,_defaultSettingData.getDefaultSettingFormData)({pcVisible:t,mobileVisible:i});return e&&(i=(t=_ui.renderer.get(e.name))?t.createFormDesignSettingFormConfig:null,r=(i?i({}):{})||{}),r},W=()=>{g.formData=C()},q=()=>{w()};Object.assign(s,D,t);return s.renderVN=()=>{var{height:e,showHeader:t}=u,i=n.header,r=n.footer;return(0,_vue.h)("div",{ref:o,class:"vxe-form-design",style:e?{height:(0,_dom.toCssUnit)(e)}:null},[t||i?(0,_vue.h)("div",{class:"vxe-form-design--header"},i?i({}):(0,_vue.h)("div",{class:"vxe-form-design--header-wrapper"},[(0,_vue.h)("div",{class:"vxe-form-design--header-left"}),(0,_vue.h)("div",{class:"vxe-form-design--header-middle"}),(0,_vue.h)("div",{class:"vxe-form-design--header-right"},[(0,_vue.h)(_button.default,{mode:"text",status:"primary",icon:(0,_ui.getIcon)().FORM_DESIGN_STYLE_SETTING,content:(0,_ui.getI18n)("vxe.formDesign.styleSetting.btn"),onClick:q})])])):(0,_vue.createCommentVNode)(),(0,_vue.h)("div",{class:"vxe-form-design--body"},[(0,_vue.h)(_layoutWidget.default),(0,_vue.h)(_layoutPreview.default),(0,_vue.h)(_layoutSetting.default),(0,_vue.h)(_layoutStyle.default,{ref:d})]),r?(0,_vue.h)("div",{class:"vxe-form-design--footer"},r?r({}):[]):(0,_vue.createCommentVNode)()])},(0,_vue.watch)(()=>u.widgets,()=>{y()}),(0,_vue.watch)(()=>u.widgets,()=>{y()}),(0,_vue.watch)(()=>u.config,e=>{v(e||{})}),W(),y(),u.config&&v(u.config),(0,_vue.provide)("$xeFormDesign",s),s},render(){return this.renderVN()}});