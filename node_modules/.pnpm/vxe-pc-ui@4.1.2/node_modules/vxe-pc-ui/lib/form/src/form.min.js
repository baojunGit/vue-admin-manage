"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_utils=require("../../ui/src/utils"),_dom=require("../../ui/src/dom"),_util=require("./util"),_tooltip=_interopRequireDefault(require("../../tooltip/src/tooltip")),_formConfigItem=_interopRequireDefault(require("./form-config-item")),_loading=_interopRequireDefault(require("../../loading/src/loading")),_vn=require("../../ui/src/vn"),_log=require("../../ui/src/log");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}class Rule{constructor(e){Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.min,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}get content(){return(0,_utils.getFuncText)(this.$options.content||this.$options.message)}get message(){return this.content}}const validErrorRuleValue=(e,t)=>{var{type:e,min:l,max:i,pattern:r}=e,e="number"===e,a=e?_xeUtils.default.toNumber(t):_xeUtils.default.getSize(t);return!(!e||!isNaN(t))||!_xeUtils.default.eqNull(l)&&a<_xeUtils.default.toNumber(l)||!_xeUtils.default.eqNull(i)&&a>_xeUtils.default.toNumber(i)||!(!r||(_xeUtils.default.isRegExp(r)?r:new RegExp(r)).test(t))};function getResetValue(e,t){return t=_xeUtils.default.isArray(e)?[]:t}var _default=exports.default=(0,_vue.defineComponent)({name:"VxeForm",props:{collapseStatus:{type:Boolean,default:!0},loading:Boolean,data:Object,size:{type:String,default:()=>(0,_ui.getConfig)().form.size||(0,_ui.getConfig)().size},span:{type:[String,Number],default:()=>(0,_ui.getConfig)().form.span},align:{type:String,default:()=>(0,_ui.getConfig)().form.align},titleBold:{type:Boolean,default:()=>(0,_ui.getConfig)().form.titleBold},titleAlign:{type:String,default:()=>(0,_ui.getConfig)().form.titleAlign},titleWidth:{type:[String,Number],default:()=>(0,_ui.getConfig)().form.titleWidth},titleColon:{type:Boolean,default:()=>(0,_ui.getConfig)().form.titleColon},titleAsterisk:{type:Boolean,default:()=>(0,_ui.getConfig)().form.titleAsterisk},titleOverflow:{type:[Boolean,String],default:()=>(0,_ui.getConfig)().form.titleOverflow},vertical:{type:Boolean,default:()=>(0,_ui.getConfig)().form.vertical},padding:{type:Boolean,default:()=>(0,_ui.getConfig)().form.padding},className:[String,Function],readonly:Boolean,disabled:Boolean,items:Array,rules:Object,preventSubmit:{type:Boolean,default:()=>(0,_ui.getConfig)().form.preventSubmit},validConfig:Object,tooltipConfig:Object,customLayout:{type:Boolean,default:()=>(0,_ui.getConfig)().form.customLayout}},emits:["update:collapseStatus","collapse","toggle-collapse","submit","submit-invalid","reset"],setup(n,e){const{slots:s,emit:i}=e;var t=_xeUtils.default.uniqueId();const d=(0,_ui.useSize)(n)["computeSize"],c=(0,_vue.reactive)({collapseAll:n.collapseStatus,staticItems:[],formItems:[]}),o=(0,_vue.reactive)({tooltipTimeout:null,tooltipStore:{item:null,visible:!1}}),u=((0,_vue.provide)("xeFormItemInfo",null),(0,_vue.inject)("$xeGrid",null)),m=(0,_vue.ref)(),f=(0,_vue.ref)();let l={};const v=(0,_vue.computed)(()=>Object.assign({},(0,_ui.getConfig)().form.validConfig,n.validConfig)),p=(0,_vue.computed)(()=>Object.assign({},(0,_ui.getConfig)().tooltip,(0,_ui.getConfig)().form.tooltipConfig,n.tooltipConfig)),r={refElem:m},a={computeSize:d,computeValidOpts:v,computeTooltipOpts:p},g={xID:t,props:n,context:e,reactData:c,xegrid:u,getRefMaps:()=>r,getComputeMaps:()=>a};const _=e=>(e.length&&"development"===process.env.NODE_ENV&&e.forEach(e=>{e.slots&&_xeUtils.default.each(e.slots,e=>{_xeUtils.default.isFunction(e)||s[e]||(0,_log.errLog)("vxe.error.notSlot",[e])})}),c.staticItems=_xeUtils.default.mapTree(e,e=>(0,_util.createItem)(g,e),{children:"children"}),(0,_vue.nextTick)()),h=()=>{const t=[];return _xeUtils.default.eachTree(c.formItems,e=>{t.push(e)},{children:"children"}),t},x=t=>{var e=_xeUtils.default.findTree(c.formItems,e=>e.field===t,{children:"children"});return e?e.item:null},y=()=>c.collapseAll,E=()=>{var e=!y();return c.collapseAll=e,i("update:collapseStatus",e),(0,_vue.nextTick)()};const b=t=>{if(t){let e=t;(e=_xeUtils.default.isArray(t)?e:[t]).forEach(e=>{e&&(e=(0,_util.handleFieldOrItem)(g,e))&&(e.showError=!1)})}else h().forEach(e=>{e.showError=!1});return(0,_vue.nextTick)()},C=()=>{const a=n["data"];var e=h();return a&&e.forEach(e=>{var t,{field:l,resetValue:i,itemRender:r}=e;(0,_utils.isEnableConf)(r)&&(t=(r=_ui.renderer.get(r.name))?r.formItemResetMethod||r.itemResetMethod:null,r&&t?t({data:a,field:l,property:l,item:e,$form:g,$grid:g.xegrid}):l&&_xeUtils.default.set(a,l,null===i?getResetValue(_xeUtils.default.get(a,l),void 0):_xeUtils.default.clone(i,!0)))}),b()},U=e=>{e.preventDefault(),C(),l.dispatchEvent("reset",{data:n.data},e)},S=e=>{var l=m.value;if(l)for(let t=0;t<e.length;t++){var i=e[t],r=x(i);if(r&&(0,_utils.isEnableConf)(r.itemRender)){var a=r["itemRender"],o=_ui.renderer.get(a.name);t||(0,_dom.scrollToView)(l.querySelector("."+r.id));let e=null;a=a.autoFocus||a.autofocus||(o?o.formItemAutoFocus:null);if(_xeUtils.default.isFunction(a)?e=a({$form:g,$grid:u,item:r,data:n.data,field:i}):a&&(e=l.querySelector(`.${r.id} `+a)),e){e.focus();break}}}},w=(e,t,l)=>{const{data:f,rules:i}=n,r={};return _xeUtils.default.isArray(t)||(t=[t]),Promise.all(t.map(s=>{const n=[],d=[];if(s&&i){const c=_xeUtils.default.get(i,s);if(c){const m=_xeUtils.default.isUndefined(l)?_xeUtils.default.get(f,s):l;c.forEach(t=>{const{type:l,trigger:i,required:r,validator:a}=t;if("all"===e||!i||e===i)if(a){var o={itemValue:m,rule:t,rules:c,data:f,field:s,property:s,$form:g};let e;_xeUtils.default.isString(a)?(u=_ui.validators.get(a))?(u=u.formItemValidatorMethod||u.itemValidatorMethod)?e=u(o):"development"===process.env.NODE_ENV&&(0,_log.warnLog)("vxe.error.notValidators",[a]):"development"===process.env.NODE_ENV&&(0,_log.errLog)("vxe.error.notValidators",[a]):e=a(o),e&&(_xeUtils.default.isError(e)?n.push(new Rule({type:"custom",trigger:i,content:e.message,rule:new Rule(t)})):e.catch&&d.push(e.catch(e=>{n.push(new Rule({type:"custom",trigger:i,content:e?e.message:t.content||t.message,rule:new Rule(t)}))})))}else{var u="array"===l,o=_xeUtils.default.isArray(m);let e=!0;e=u||o?!o||!m.length:_xeUtils.default.isString(m)?(0,_utils.eqEmptyValue)(m.trim()):(0,_utils.eqEmptyValue)(m),(r?e||validErrorRuleValue(t,m):!e&&validErrorRuleValue(t,m))&&n.push(new Rule(t))}})}}return Promise.all(d).then(()=>{n.length&&(r[s]=n.map(e=>({$form:g,rule:e,data:f,field:s,property:s})))})})).then(()=>{if(!_xeUtils.default.isEmpty(r))return Promise.reject(r)})};let I;const R=(t,e,l)=>{var{data:i,rules:r}=n;const a=v.value,o={},u=[],s=[];return clearTimeout(I),i&&r?(t.forEach(t=>{const l=t["field"];l&&!(0,_util.isHiddenItem)(g,t)&&(0,_util.isActiveItem)(g,t)&&s.push(w(e||"all",l).then(()=>{t.errRule=null}).catch(e=>{e=e[l];return o[l]||(o[l]=[]),o[l].push(e),u.push(l),t.errRule=e[0].rule,Promise.reject(e)}))}),Promise.all(s).then(()=>{l&&l()}).catch(()=>new Promise(e=>{I=window.setTimeout(()=>{t.forEach(e=>{e.errRule&&(e.showError=!0)})},20),!1!==a.autoPos&&(0,_vue.nextTick)(()=>{S(u)}),l?(l(o),e()):e(o)}))):(l&&l(),Promise.resolve())};const T=t=>{var e=n["readonly"];t.preventDefault(),n.preventSubmit||(b(),e?l.dispatchEvent("submit",{data:n.data},t):R(h()).then(e=>{e?l.dispatchEvent("submit-invalid",{data:n.data,errMap:e},t):l.dispatchEvent("submit",{data:n.data},t)}))},q=()=>{var e=o["tooltipStore"],t=f.value;return e.visible&&(Object.assign(e,{item:null,visible:!1}),t)&&t.close(),(0,_vue.nextTick)()};const V=(e,l,t)=>l?w(e?["blur"].includes(e.type)?"blur":"change":"all",l,t).then(()=>{b(l)}).catch(e=>{var e=e[l],t=x(l);e&&t&&(t.showError=!0,t.errRule=e[0].rule)}):(0,_vue.nextTick)();l={dispatchEvent(e,t,l){i(e,(0,_ui.createEvent)(l,{$form:g,$grid:u},t))},reset:C,validate:e=>{var t=n["readonly"];return b(),t?(0,_vue.nextTick)():R(h(),"",e)},validateField:(e,t)=>{var l=n["readonly"];if(l)return(0,_vue.nextTick)();let i=[];return e&&(i=_xeUtils.default.isArray(e)?e:[e]),R(i.map(e=>(0,_util.handleFieldOrItem)(g,e)),"",t)},clearValidate:b,updateStatus:(e,t)=>{e=e.field;return V(new Event("change"),e,t)},toggleCollapse:E,getItems:h,getItemByField:x,closeTooltip:q};t={callSlot:(e,t)=>e&&(_xeUtils.default.isString(e)&&(e=s[e]||null),_xeUtils.default.isFunction(e))?(0,_vn.getSlotVNs)(e(t)):[],triggerItemEvent:V,toggleCollapseEvent:e=>{E();var t=y();l.dispatchEvent("toggle-collapse",{status:t,collapse:t,data:n.data},e),l.dispatchEvent("collapse",{status:t,collapse:t,data:n.data},e)},triggerTitleTipEvent:(e,t)=>{var t=t["item"],l=o["tooltipStore"],i=f.value,e=e.currentTarget.children[0],r=(e.textContent||"").trim(),a=e.scrollWidth>e.clientWidth;clearTimeout(o.tooltipTimeout),l.item!==t&&q(),r&&a&&(Object.assign(l,{item:t,visible:!0}),i)&&i.open(e,r)},handleTitleTipLeaveEvent:()=>{var e=p.value;let t=f.value;t&&t.setActived(!1),e.enterable?o.tooltipTimeout=setTimeout(()=>{(t=f.value)&&!t.isActived()&&q()},e.leaveDelay):q()}};Object.assign(g,l,t);g.renderVN=()=>{var{loading:e,className:t,data:l,customLayout:i}=n,r=c["formItems"],a=d.value,o=p.value,u=s.default;return(0,_vue.h)("form",{ref:m,class:["vxe-form",t?_xeUtils.default.isFunction(t)?t({items:r,data:l,$form:g}):t:"",{["size--"+a]:a,"is--loading":e}],spellcheck:!1,onSubmit:T,onReset:U},[(0,_vue.h)("div",{class:"vxe-form--wrapper vxe-form--item-row"},i?u?u({}):[]:r.map((e,t)=>(0,_vue.h)(_formConfigItem.default,{key:t,itemConfig:e}))),(0,_vue.h)("div",{class:"vxe-form-slots",ref:"hideItem"},!i&&u?u({}):[]),(0,_vue.h)(_loading.default,{class:"vxe-form--loading",modelValue:e}),(0,_vue.h)(_tooltip.default,Object.assign({ref:f},o))])};const N=(0,_vue.ref)(0),O=((0,_vue.watch)(()=>c.staticItems.length,()=>{N.value++}),(0,_vue.watch)(()=>c.staticItems,()=>{N.value++}),(0,_vue.watch)(N,()=>{c.formItems=c.staticItems}),(0,_vue.ref)(0));return(0,_vue.watch)(()=>n.items?n.items.length:-1,()=>{O.value++}),(0,_vue.watch)(()=>n.items,()=>{O.value++}),(0,_vue.watch)(O,()=>{_(n.items||[])}),(0,_vue.watch)(()=>n.collapseStatus,e=>{c.collapseAll=!!e}),(0,_vue.watch)(()=>n.readonly,()=>{b()}),(0,_vue.watch)(()=>n.disabled,()=>{b()}),(0,_vue.onMounted)(()=>{(0,_vue.nextTick)(()=>{"development"===process.env.NODE_ENV&&n.customLayout&&n.items&&(0,_log.errLog)("vxe.error.errConflicts",["custom-layout","items"])})}),n.items&&_(n.items),(0,_vue.provide)("$xeForm",g),(0,_vue.provide)("$xeFormGather",null),(0,_vue.provide)("$xeFormItem",null),g},render(){return this.renderVN()}});