"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.formItemProps = exports.default = void 0;
var _vue = require("vue");
var _xeUtils = _interopRequireDefault(require("xe-utils"));
var _ui = require("../../ui");
var _utils = require("../../ui/src/utils");
var _vn = require("../../ui/src/vn");
var _util = require("./util");
var _render = require("./render");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
const formItemProps = exports.formItemProps = {
  title: String,
  field: String,
  span: [String, Number],
  align: String,
  titleBold: {
    type: Boolean,
    default: null
  },
  titleAlign: {
    type: String,
    default: null
  },
  titleWidth: {
    type: [String, Number],
    default: null
  },
  titleColon: {
    type: Boolean,
    default: null
  },
  titleAsterisk: {
    type: Boolean,
    default: null
  },
  showTitle: {
    type: Boolean,
    default: true
  },
  vertical: {
    type: Boolean,
    default: null
  },
  padding: {
    type: Boolean,
    default: null
  },
  className: [String, Function],
  contentClassName: [String, Function],
  contentStyle: [Object, Function],
  titleClassName: [String, Function],
  titleStyle: [Object, Function],
  titleOverflow: {
    type: [Boolean, String],
    default: null
  },
  titlePrefix: Object,
  titleSuffix: Object,
  resetValue: {
    default: null
  },
  visibleMethod: Function,
  visible: {
    type: Boolean,
    default: null
  },
  folding: Boolean,
  collapseNode: Boolean,
  itemRender: Object,
  rules: Array
};
var _default = exports.default = (0, _vue.defineComponent)({
  name: 'VxeFormItem',
  props: formItemProps,
  setup(props, {
    slots
  }) {
    const refElem = (0, _vue.ref)();
    const $xeForm = (0, _vue.inject)('$xeForm', {});
    const formGather = (0, _vue.inject)('$xeFormGather', null);
    const formItem = (0, _vue.reactive)((0, _util.createItem)($xeForm, props));
    formItem.slots = slots;
    const formItemInfo = {
      itemConfig: formItem
    };
    (0, _vue.provide)('xeFormItemInfo', formItemInfo);
    (0, _util.watchItem)(props, formItem);
    (0, _vue.onMounted)(() => {
      (0, _util.assembleItem)($xeForm, refElem.value, formItem, formGather);
    });
    (0, _vue.onUnmounted)(() => {
      (0, _util.destroyItem)($xeForm, formItem);
    });
    const renderItem = ($xeForm, item) => {
      const {
        props,
        reactData
      } = $xeForm;
      const {
        data,
        rules,
        readonly,
        disabled,
        titleBold: allTitleBold,
        titleAlign: allTitleAlign,
        titleWidth: allTitleWidth,
        titleColon: allTitleColon,
        titleAsterisk: allTitleAsterisk,
        titleOverflow: allTitleOverflow,
        vertical: allVertical,
        padding: allPadding
      } = props;
      const {
        collapseAll
      } = reactData;
      const {
        computeValidOpts
      } = $xeForm.getComputeMaps();
      const validOpts = computeValidOpts.value;
      const {
        slots,
        title,
        visible,
        folding,
        field,
        collapseNode,
        itemRender,
        showError,
        errRule,
        className,
        titleOverflow,
        vertical,
        padding,
        showTitle,
        contentClassName,
        contentStyle,
        titleClassName,
        titleStyle
      } = item;
      const compConf = (0, _utils.isEnableConf)(itemRender) ? _ui.renderer.get(itemRender.name) : null;
      const itemClassName = compConf ? compConf.formItemClassName || compConf.itemClassName : '';
      const itemStyle = compConf ? compConf.formItemStyle || compConf.itemStyle : null;
      const itemContentClassName = compConf ? compConf.formItemContentClassName || compConf.itemContentClassName : '';
      const itemContentStyle = compConf ? compConf.formItemContentStyle || compConf.itemContentStyle : null;
      const itemTitleClassName = compConf ? compConf.formItemTitleClassName || compConf.itemTitleClassName : '';
      const itemTitleStyle = compConf ? compConf.formItemTitleStyle || compConf.itemTitleStyle : null;
      const defaultSlot = slots ? slots.default : null;
      const titleSlot = slots ? slots.title : null;
      const span = item.span || props.span;
      const align = item.align || props.align;
      const itemPadding = _xeUtils.default.eqNull(padding) ? allPadding : padding;
      const itemVertical = _xeUtils.default.eqNull(vertical) ? allVertical : vertical;
      const titleBold = _xeUtils.default.eqNull(item.titleBold) ? allTitleBold : item.titleBold;
      const titleAlign = _xeUtils.default.eqNull(item.titleAlign) ? allTitleAlign : item.titleAlign;
      const titleWidth = itemVertical ? null : _xeUtils.default.eqNull(item.titleWidth) ? allTitleWidth : item.titleWidth;
      const titleColon = _xeUtils.default.eqNull(item.titleColon) ? allTitleColon : item.titleColon;
      const titleAsterisk = _xeUtils.default.eqNull(item.titleAsterisk) ? allTitleAsterisk : item.titleAsterisk;
      const itemOverflow = _xeUtils.default.eqNull(titleOverflow) ? allTitleOverflow : titleOverflow;
      const ovEllipsis = itemOverflow === 'ellipsis';
      const ovTitle = itemOverflow === 'title';
      const ovTooltip = itemOverflow === true || itemOverflow === 'tooltip';
      const hasEllipsis = ovTitle || ovTooltip || ovEllipsis;
      const params = {
        data,
        disabled,
        readonly,
        field,
        property: field,
        item,
        $form: $xeForm,
        $grid: $xeForm.xegrid
      };
      let isRequired = false;
      let isValid = false;
      if (visible === false) {
        return (0, _vue.createCommentVNode)();
      }
      if (!readonly && rules) {
        const itemRules = rules[field];
        if (itemRules && itemRules.length) {
          isValid = true;
          isRequired = itemRules.some(rule => rule.required);
        }
      }
      let contentVNs = [];
      const rftContent = compConf ? compConf.renderFormItemContent || compConf.renderItemContent : null;
      if (defaultSlot) {
        contentVNs = $xeForm.callSlot(defaultSlot, params);
      } else if (rftContent) {
        contentVNs = (0, _vn.getSlotVNs)(rftContent(itemRender, params));
      } else if (field) {
        contentVNs = [`${_xeUtils.default.get(data, field)}`];
      }
      if (collapseNode) {
        contentVNs.push((0, _vue.h)('div', {
          class: 'vxe-form--item-trigger-node',
          onClick: $xeForm.toggleCollapseEvent
        }, [(0, _vue.h)('span', {
          class: 'vxe-form--item-trigger-text'
        }, collapseAll ? (0, _ui.getI18n)('vxe.form.unfolding') : (0, _ui.getI18n)('vxe.form.folding')), (0, _vue.h)('i', {
          class: ['vxe-form--item-trigger-icon', collapseAll ? (0, _ui.getIcon)().FORM_FOLDING : (0, _ui.getIcon)().FORM_UNFOLDING]
        })]));
      }
      if (errRule && validOpts.showMessage) {
        contentVNs.push((0, _vue.h)('div', {
          class: 'vxe-form--item-valid',
          style: errRule.maxWidth ? {
            width: `${errRule.maxWidth}px`
          } : null
        }, errRule.message));
      }
      const ons = ovTooltip ? {
        onMouseenter(evnt) {
          $xeForm.triggerTitleTipEvent(evnt, params);
        },
        onMouseleave: $xeForm.handleTitleTipLeaveEvent
      } : {};
      return (0, _vue.h)('div', {
        ref: refElem,
        class: ['vxe-form--item', item.id, span ? `vxe-form--item-col_${span} is--span` : '', className ? _xeUtils.default.isFunction(className) ? className(params) : className : '', itemClassName ? _xeUtils.default.isFunction(itemClassName) ? itemClassName(params) : itemClassName : '', {
          'is--title': title,
          'is--colon': titleColon,
          'is--bold': titleBold,
          'is--padding': itemPadding,
          'is--vertical': itemVertical,
          'is--asterisk': titleAsterisk,
          'is--valid': isValid,
          'is--required': isRequired,
          'is--hidden': folding && collapseAll,
          'is--active': (0, _util.isActiveItem)($xeForm, item),
          'is--error': showError
        }],
        style: _xeUtils.default.isFunction(itemStyle) ? itemStyle(params) : itemStyle
      }, [(0, _vue.h)('div', {
        class: 'vxe-form--item-inner'
      }, [showTitle !== false && (title || titleSlot) ? (0, _vue.h)('div', Object.assign({
        class: ['vxe-form--item-title', titleAlign ? `align--${titleAlign}` : '', hasEllipsis ? 'is--ellipsis' : '', itemTitleClassName ? _xeUtils.default.isFunction(itemTitleClassName) ? itemTitleClassName(params) : itemTitleClassName : '', titleClassName ? _xeUtils.default.isFunction(titleClassName) ? titleClassName(params) : titleClassName : ''],
        style: Object.assign({}, _xeUtils.default.isFunction(itemTitleStyle) ? itemTitleStyle(params) : itemTitleStyle, _xeUtils.default.isFunction(titleStyle) ? titleStyle(params) : titleStyle, titleWidth ? {
          width: isNaN(titleWidth) ? titleWidth : `${titleWidth}px`
        } : null),
        title: ovTitle ? (0, _utils.getFuncText)(title) : null
      }, ons), (0, _render.renderTitle)($xeForm, item)) : null, (0, _vue.h)('div', {
        class: ['vxe-form--item-content', align ? `align--${align}` : '', itemContentClassName ? _xeUtils.default.isFunction(itemContentClassName) ? itemContentClassName(params) : itemContentClassName : '', contentClassName ? _xeUtils.default.isFunction(contentClassName) ? contentClassName(params) : contentClassName : ''],
        style: Object.assign({}, _xeUtils.default.isFunction(itemContentStyle) ? itemContentStyle(params) : itemContentStyle, _xeUtils.default.isFunction(contentStyle) ? contentStyle(params) : contentStyle)
      }, contentVNs)])]);
    };
    const renderVN = () => {
      const formProps = $xeForm ? $xeForm.props : null;
      return formProps && formProps.customLayout ? renderItem($xeForm, formItem) : (0, _vue.h)('div', {
        ref: refElem
      });
    };
    const $xeFormitem = {
      formItem,
      renderVN
    };
    (0, _vue.provide)('$xeFormItem', $xeFormitem);
    (0, _vue.provide)('$xeFormGather', null);
    return $xeFormitem;
  },
  render() {
    return this.renderVN();
  }
});