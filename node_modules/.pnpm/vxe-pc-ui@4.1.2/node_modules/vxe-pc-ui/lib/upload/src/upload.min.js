"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_vn=require("../..//ui/src/vn"),_log=require("../../ui/src/log"),_dom=require("../../ui/src/dom"),_util=require("./util"),_button=_interopRequireDefault(require("../../button/src/button"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default=exports.default=(0,_vue.defineComponent)({name:"VxeUpload",props:{modelValue:[Array,String,Object],showList:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showList},moreConfig:Object,readonly:{type:Boolean,default:null},disabled:{type:Boolean,default:null},mode:{type:String,default:()=>(0,_ui.getConfig)().upload.mode},imageTypes:{type:Array,default:()=>_xeUtils.default.clone((0,_ui.getConfig)().upload.imageTypes,!0)},imageStyle:{type:Object,default:()=>_xeUtils.default.clone((0,_ui.getConfig)().upload.imageStyle,!0)},fileTypes:{type:Array,default:()=>_xeUtils.default.clone((0,_ui.getConfig)().upload.fileTypes,!0)},singleMode:Boolean,urlMode:Boolean,multiple:Boolean,limitSize:{type:[String,Number],default:()=>(0,_ui.getConfig)().upload.limitSize},limitCount:{type:[String,Number],default:()=>(0,_ui.getConfig)().upload.limitCount},nameField:{type:String,default:()=>(0,_ui.getConfig)().upload.nameField},typeField:{type:String,default:()=>(0,_ui.getConfig)().upload.typeField},urlField:{type:String,default:()=>(0,_ui.getConfig)().upload.urlField},sizeField:{type:String,default:()=>(0,_ui.getConfig)().upload.sizeField},showErrorStatus:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showErrorStatus},showProgress:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showProgress},autoHiddenButton:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.autoHiddenButton},buttonText:{type:String,default:()=>(0,_ui.getConfig)().upload.buttonText},buttonIcon:{type:String,default:()=>(0,_ui.getConfig)().upload.buttonIcon},showButtonText:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showButtonText},showButtonIcon:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showButtonIcon},showRemoveButton:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showRemoveButton},showDownloadButton:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showDownloadButton},showPreview:{type:Boolean,default:()=>(0,_ui.getConfig)().upload.showPreview},tipText:String,hintText:String,previewMethod:Function,uploadMethod:Function,removeMethod:Function,downloadMethod:Function,getUrlMethod:Function,getThumbnailUrlMethod:Function,size:{type:String,default:()=>(0,_ui.getConfig)().upload.size||(0,_ui.getConfig)().size}},emits:["update:modelValue","add","remove","download","upload-success","upload-error"],setup(f,e){const{emit:l,slots:h}=e,x=(0,_vue.inject)("$xeForm",null),C=(0,_vue.inject)("xeFormItemInfo",null);var s=_xeUtils.default.uniqueId();const v=(0,_ui.useSize)(f)["computeSize"],a=(0,_vue.ref)(),w=(0,_vue.reactive)({isDrag:!1,fileList:[]}),_={refElem:a},I=(0,_vue.computed)(()=>{var e=f["readonly"];return null===e?!!x&&x.props.readonly:e}),A=(0,_vue.computed)(()=>{var e=f["disabled"];return null===e?!!x&&x.props.disabled:e}),n=(0,_vue.computed)(()=>"image"===f.mode),D=(0,_vue.computed)(()=>f.nameField||"name"),y=(0,_vue.computed)(()=>f.typeField||"type"),T=(0,_vue.computed)(()=>f.urlField||"url"),U=(0,_vue.computed)(()=>f.sizeField||"size"),X=(0,_vue.computed)(()=>1024*_xeUtils.default.toNumber(f.limitSize)*1024),b=(0,_vue.computed)(()=>f.multiple?_xeUtils.default.toNumber(f.limitCount):1),M=(0,_vue.computed)(()=>{var e=f["multiple"],t=w["fileList"],o=b.value;return e?!o||t.length>=o:1<=t.length}),V=(0,_vue.computed)(()=>{var e=_xeUtils.default.toNumber(f.limitSize);return e?1048576<e?e/1048576+"T":1024<e?e/1024+"G":e+"M":""}),B=(0,_vue.computed)(()=>{var{limitSize:e,fileTypes:t,multiple:o,limitCount:i}=f,u=f.tipText||f.hintText,l=n.value,a=V.value;return _xeUtils.default.isString(u)?u:(u=[],l?(o&&i&&u.push((0,_ui.getI18n)("vxe.upload.imgCountHint",[i])),e&&a&&u.push((0,_ui.getI18n)("vxe.upload.imgSizeHint",[a]))):(t&&t.length&&u.push((0,_ui.getI18n)("vxe.upload.fileTypeHint",[t.join("/")])),e&&a&&u.push((0,_ui.getI18n)("vxe.upload.fileSizeHint",[a])),o&&i&&u.push((0,_ui.getI18n)("vxe.upload.fileCountHint",[i]))),u.join((0,_ui.getI18n)("vxe.base.comma")))}),p=(0,_vue.computed)(()=>Object.assign({},f.imageStyle)),m=(0,_vue.computed)(()=>{var{width:e,height:t}=p.value,o={};return e&&(o.width=(0,_dom.toCssUnit)(e)),t&&(o.height=(0,_dom.toCssUnit)(t)),o}),L=(0,_vue.computed)(()=>Object.assign({showMoreButton:!0},f.moreConfig)),j={},E={xID:s,props:f,context:e,reactData:w,getRefMaps:()=>_,getComputeMaps:()=>j},t=()=>{var{modelValue:e,multiple:t}=f,o=I.value;const i=D.value,u=y.value,l=T.value,a=U.value;e=e?(e?_xeUtils.default.isArray(e)?e:[e]:[]).map(e=>{if(!e||_xeUtils.default.isString(e)){var t=""+(e||"");const o=decodeURIComponent(""+(t||"")).split("/").pop()||"";return{[i]:o,[u]:S(o),[l]:t,[a]:0}}const o=e[i]||"";return e[i]=o,e[u]=e[u]||S(o),e[l]=e[l]||"",e[a]=e[a]||0,e}):[];w.fileList=o||t?e:e.slice(0,1)},S=e=>{var t=e?e.indexOf("."):-1;return-1<t?e.substring(t+1,e.length).toLowerCase():""},N={dispatchEvent(e,t,o){l(e,(0,_ui.createEvent)(o,{$upload:E},t))}},P=e=>{var{singleMode:t,urlMode:o}=f;const i=T.value;let u=e?e.slice(0):[];o&&(u=u.map(e=>e[i])),l("update:modelValue",t?u[0]||null:u)},k=e=>{var t=f.getThumbnailUrlMethod||(0,_ui.getConfig)().upload.getThumbnailUrlMethod;return t?t({$upload:E,option:e}):r(e)},r=e=>{var t=f.getUrlMethod||(0,_ui.getConfig)().upload.getUrlMethod,o=T.value;return t?t({$upload:E,option:e}):e[o]},R=["jpg","jpeg","png","gif"],q=(e,t)=>{var o=f.previewMethod||(0,_ui.getConfig)().upload.previewMethod;if(f.showPreview)if(o)o({$upload:E,option:t});else{var i=t;var{imageTypes:o,showDownloadButton:t}=f;const u=y.value;R.concat(o||[]).some(e=>(""+e).toLowerCase()===(""+i[u]).toLowerCase())&&_ui.VxeUI.previewImage&&_ui.VxeUI.previewImage({urlList:[r(i)],showDownloadButton:t})}},$=(e,t,o)=>{var i=f["showDownloadButton"],u=w["fileList"];f.showPreview&&_ui.VxeUI.previewImage&&_ui.VxeUI.previewImage({urlList:u.map(e=>r(e)),activeIndex:o,showDownloadButton:i})},O=(t,e)=>{const o=f["showErrorStatus"];var i=f.uploadMethod||(0,_ui.getConfig)().upload.uploadMethod;return i&&t._X_DATA?Promise.resolve(i({$upload:E,file:e,option:t,updateProgress(e){Object.assign(t._X_DATA||{},{p:Math.max(0,Math.min(99,_xeUtils.default.toNumber(e)))})}})).then(e=>{Object.assign(t._X_DATA||{},{l:!1,p:100}),Object.assign(t,e),N.dispatchEvent("upload-success",{option:t,data:e},null)}).catch(e=>{Object.assign(t._X_DATA||{},{l:!1,s:"error"}),o?Object.assign(t,e):w.fileList=w.fileList.filter(e=>e._X_DATA!==t._X_DATA),N.dispatchEvent("upload-error",{option:t,data:e},null)}):Promise.resolve()},c=e=>{const{uploadMethod:t,urlMode:o}=f;var i;(t||(0,_ui.getConfig)().upload.uploadMethod)&&e._X_DATA&&(i=e._X_DATA.f,Object.assign(e._X_DATA,{l:!0,s:"",p:0}),O(e,i).then(()=>{o&&P(w.fileList)}))},d=(t,o)=>{var{multiple:e,urlMode:i}=f,u=w["fileList"];const l=f.uploadMethod||(0,_ui.getConfig)().upload.uploadMethod,a=D.value,n=y.value,r=T.value,d=U.value;var s=X.value;const v=b.value;var _=V.value;let p=t;if(e&&v){if(u.length>=v)return void(_ui.VxeUI.modal&&_ui.VxeUI.modal.notification({title:(0,_ui.getI18n)("vxe.modal.errTitle"),status:"error",content:(0,_ui.getI18n)("vxe.upload.overCountErr",[v])}));const m=p.length-(v-u.length);if(0<m){const h=p.slice(v-u.length);_ui.VxeUI.modal&&_ui.VxeUI.modal.notification({title:(0,_ui.getI18n)("vxe.modal.errTitle"),status:"error",slots:{default(){return(0,_vue.h)("div",{class:"vxe-upload--file-message-over-error"},[(0,_vue.h)("div",{},(0,_ui.getI18n)("vxe.upload.overCountExtraErr",[v,m])),(0,_vue.h)("div",{class:"vxe-upload--file-message-over-extra"},h.map((e,t)=>(0,_vue.h)("div",{key:t,class:"vxe-upload--file-message-over-extra-item"},e.name)))])}}})}p=p.slice(0,v-u.length)}if(s)for(let e=0;e<t.length;e++)if(t[0].size>s)return void(_ui.VxeUI.modal&&_ui.VxeUI.modal.notification({title:(0,_ui.getI18n)("vxe.modal.errTitle"),status:"error",content:(0,_ui.getI18n)("vxe.upload.overSizeErr",[_])}));const c=e?u:[],g=[];p.forEach(e=>{var t=e["name"],t={[a]:t,[n]:S(t),[d]:e.size,[r]:""},t=(l&&(t._X_DATA={k:_xeUtils.default.uniqueId(),f:e,l:!0,s:"",p:0}),(0,_vue.reactive)(t));l&&g.push(O(t,e)),c.push(t),N.dispatchEvent("add",{option:t},o)}),w.fileList=c,Promise.all(i?g:[]).then(()=>{P(c),x&&C&&x.triggerItemEvent(o,C.itemConfig.field,c)})},F=t=>{var{multiple:e,imageTypes:o,fileTypes:i}=f,u=A.value,l=n.value;u||(0,_util.readLocalFile)({multiple:e,types:l?o:i}).then(({files:e})=>{d(e,t)}).catch(()=>{})},u=(e,t,o)=>{var i=w["fileList"];i.splice(o,1),P(i),x&&C&&x.triggerItemEvent(e,C.itemConfig.field,i),N.dispatchEvent("remove",{option:t},e)},g=(e,t,o)=>{var i=f.removeMethod||(0,_ui.getConfig)().upload.removeMethod;i?Promise.resolve(i({$upload:E,option:t})).then(()=>{u(e,t,o)}).catch(e=>e):u(e,t,o)},i=(e,t)=>{N.dispatchEvent("download",{option:t},e)},H=(e,t)=>{var o=f.downloadMethod||(0,_ui.getConfig)().upload.downloadMethod;o?Promise.resolve(o({$upload:E,option:t})).then(()=>{i(e,t)}).catch(e=>e):i(e,t)},G=e=>{var t,o,i,u=a.value,{clientX:e,clientY:l}=e;u&&({x:u,y:t,height:o,width:i}=u.getBoundingClientRect(),e<u||u+i<e||l<t||t+o<l)&&(w.isDrag=!1)},Y=e=>{var t=e.dataTransfer;t&&(t=t["items"],t)&&t.length&&(e.preventDefault(),w.isDrag=!0)},W=e=>{var t=e.dataTransfer;if(t){t=t["items"];if(t&&t.length){const o=[];Array.from(t).forEach(e=>{e=e.getAsFile();e&&o.push(e)}),d(o,e),e.preventDefault()}}w.isDrag=!1},z=()=>{const t=n.value;_ui.VxeUI.modal.open({title:"查看列表",width:660,height:500,escClosable:!0,showMaximize:!0,resize:!0,maskClosable:!0,slots:{default(){var e=w["fileList"];return t?(0,_vue.h)("div",{class:"vxe-upload--image-more-list"},K(e,!0)):(0,_vue.h)("div",{class:"vxe-upload--file-more-list"},J(e))}}})};Object.assign(E,N,{});const J=e=>{const{showRemoveButton:l,showDownloadButton:a,showProgress:n,showPreview:r,showErrorStatus:d}=f,s=A.value,v=I.value,_=D.value,p=y.value;return e.map((t,o)=>{const i=t._X_DATA&&t._X_DATA.l,u=t._X_DATA&&"error"===t._X_DATA.s;return(0,_vue.h)("div",{key:o,class:["vxe-upload--file-item",{"is--preview":r,"is--loading":i,"is--error":u}]},[(0,_vue.h)("div",{class:"vxe-upload--file-item-icon"},[(0,_vue.h)("i",{class:(0,_ui.getIcon)()["UPLOAD_FILE_TYPE_"+(""+t[p]).toLocaleUpperCase()]||(0,_ui.getIcon)().UPLOAD_FILE_TYPE_DEFAULT})]),(0,_vue.h)("div",{class:"vxe-upload--file-item-name",onClick(e){i||u||q(e,t)}},""+(t[_]||"")),i?(0,_vue.h)("div",{class:"vxe-upload--file-item-loading-icon"},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().UPLOAD_LOADING})]):(0,_vue.createCommentVNode)(),n&&i&&t._X_DATA?(0,_vue.h)("div",{class:"vxe-upload--file-item-loading-text"},(0,_ui.getI18n)("vxe.upload.uploadProgress",[t._X_DATA.p])):(0,_vue.createCommentVNode)(),d&&u?(0,_vue.h)("div",{class:"vxe-upload--image-item-error"},[(0,_vue.h)(_button.default,{icon:(0,_ui.getIcon)().UPLOAD_IMAGE_RE_UPLOAD,mode:"text",status:"primary",content:(0,_ui.getI18n)("vxe.upload.reUpload"),onClick(){c(t)}})]):(0,_vue.createCommentVNode)(),a&&!i?(0,_vue.h)("div",{class:"vxe-upload--file-item-download-icon",onClick(e){H(e,t)}},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().UPLOAD_FILE_DOWNLOAD})]):(0,_vue.createCommentVNode)(),!l||v||s||i?(0,_vue.createCommentVNode)():(0,_vue.h)("div",{class:"vxe-upload--file-item-remove-icon",onClick(e){g(e,t,o)}},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().UPLOAD_FILE_REMOVE})])])})},K=(e,l)=>{const{showRemoveButton:a,showProgress:n,showPreview:r,showErrorStatus:d}=f,s=A.value,v=I.value,_=m.value;return e.map((t,o)=>{const i=t._X_DATA&&t._X_DATA.l,u=t._X_DATA&&"error"===t._X_DATA.s;return(0,_vue.h)("div",{key:o,class:["vxe-upload--image-item",{"is--preview":r,"is--loading":i,"is--error":u}]},[(0,_vue.h)("div",{class:"vxe-upload--image-item-box",style:l?null:_,title:(0,_ui.getI18n)("vxe.upload.viewItemTitle"),onClick(e){i||u||$(e,t,o)}},[i&&t._X_DATA?(0,_vue.h)("div",{class:"vxe-upload--image-item-loading"},[(0,_vue.h)("div",{class:"vxe-upload--image-item-loading-icon"},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().UPLOAD_LOADING})]),n?(0,_vue.h)("div",{class:"vxe-upload--image-item-loading-text"},(0,_ui.getI18n)("vxe.upload.uploadProgress",[t._X_DATA.p])):(0,_vue.createCommentVNode)()]):(0,_vue.createCommentVNode)(),i?(0,_vue.createCommentVNode)():u&&d?(0,_vue.h)("div",{class:"vxe-upload--image-item-error"},[(0,_vue.h)(_button.default,{icon:(0,_ui.getIcon)().UPLOAD_IMAGE_RE_UPLOAD,mode:"text",status:"primary",content:(0,_ui.getI18n)("vxe.upload.reUpload"),onClick(){c(t)}})]):(0,_vue.h)("img",{class:"vxe-upload--image-item-img",src:k(t)}),!a||v||s||i?(0,_vue.createCommentVNode)():(0,_vue.h)("div",{class:"vxe-upload--image-item-remove-icon",onClick(e){e.stopPropagation(),g(e,t,o)}},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().UPLOAD_IMAGE_REMOVE})])])])})};E.renderVN=()=>{var e=f["showErrorStatus"],t=w["isDrag"],o=v.value,i=A.value,u=I.value,l=n.value;return(0,_vue.h)("div",{ref:a,class:["vxe-upload",{["size--"+o]:o,"is--readonly":u,"is--disabled":i,"show--error":e,"is--drag":t}],onDragover:Y,onDragleave:G,onDrop:W},[(l?()=>{var{buttonText:e,buttonIcon:t,showButtonText:o,showButtonIcon:i,autoHiddenButton:u}=f,l=w["fileList"],a=I.value,n=B.value,r=M.value,d=m.value,s=L.value,v=h.default,_=h.hint,{maxCount:s,showMoreButton:p}=s;let c=l,g=0;return a&&s&&l.length>s&&(g=l.length-s,c=l.slice(0,s)),(0,_vue.h)("div",{key:"image",class:"vxe-upload--image-wrapper"},[(0,_vue.h)("div",{class:"vxe-upload--image-list"},K(c,!1).concat([a&&p&&g?(0,_vue.h)("div",{class:"vxe-upload--image-over-more"},[(0,_vue.h)(_button.default,{mode:"text",content:(0,_ui.getI18n)("vxe.upload.moreBtnText",[l.length]),status:"primary",onClick:z})]):(0,_vue.createCommentVNode)(),a||u&&r?(0,_vue.createCommentVNode)():(0,_vue.h)("div",{class:"vxe-upload--image-action"},[(0,_vue.h)("div",{class:"vxe-upload--image-action-btn",onClick:F},v?v({$upload:E}):[(0,_vue.h)("div",{class:"vxe-upload--image-action-box",style:d},[i?(0,_vue.h)("div",{class:"vxe-upload--image-action-icon"},[(0,_vue.h)("i",{class:t||(0,_ui.getIcon)().UPLOAD_IMAGE_ADD})]):(0,_vue.createCommentVNode)(),o?(0,_vue.h)("div",{class:"vxe-upload--image-action-content"},e?""+e:(0,_ui.getI18n)("vxe.upload.imgBtnText")):(0,_vue.createCommentVNode)(),n||_?(0,_vue.h)("div",{class:"vxe-upload--image-action-hint"},_?(0,_vn.getSlotVNs)(_({$upload:E})):n):(0,_vue.createCommentVNode)()])])])]))])}:()=>{var{buttonText:e,buttonIcon:t,showButtonText:o,showButtonIcon:i,autoHiddenButton:u}=f,l=w["fileList"],a=A.value,n=I.value,r=B.value,d=M.value,s=L.value,v=h.default,_=h.tip||h.hint,{maxCount:s,showMoreButton:p,layout:c}=s;let g=l,m=0;return n&&s&&l.length>s&&(m=l.length-s,g=l.slice(0,s)),(0,_vue.h)("div",{key:"all",class:"vxe-upload--file-wrapper"},[n?(0,_vue.createCommentVNode)():(0,_vue.h)("div",{class:"vxe-upload--file-action"},[u&&d?(0,_vue.createCommentVNode)():(0,_vue.h)("div",{class:"vxe-upload--file-action-btn",onClick:F},v?(0,_vn.getSlotVNs)(v({$upload:E})):[(0,_vue.h)(_button.default,{content:o?e?""+e:(0,_ui.getI18n)("vxe.upload.fileBtnText"):"",icon:i?t||(0,_ui.getIcon)().UPLOAD_FILE_ADD:"",disabled:a})]),r||_?(0,_vue.h)("div",{class:"vxe-upload--file-action-tip"},_?(0,_vn.getSlotVNs)(_({$upload:E})):r):(0,_vue.createCommentVNode)()]),g.length?(0,_vue.h)("div",{class:["vxe-upload--file-list-wrapper",{"is--horizontal":"horizontal"===c}]},[(0,_vue.h)("div",{class:"vxe-upload--file-list"},J(g)),n&&p&&m?(0,_vue.h)("div",{class:"vxe-upload--file-over-more"},[(0,_vue.h)(_button.default,{mode:"text",content:(0,_ui.getI18n)("vxe.upload.moreBtnText",[l.length]),status:"primary",onClick:z})]):(0,_vue.createCommentVNode)()]):(0,_vue.createCommentVNode)()])})(),t?(0,_vue.h)("div",{class:"vxe-upload--drag-placeholder"},(0,_ui.getI18n)("vxe.upload.dragPlaceholder")):(0,_vue.createCommentVNode)()])};const o=(0,_vue.ref)(0);return(0,_vue.watch)(()=>f.modelValue?f.modelValue.length:0,()=>{o.value++}),(0,_vue.watch)(()=>f.modelValue,()=>{o.value++}),(0,_vue.watch)(o,()=>{t()}),(0,_vue.onMounted)(()=>{"development"===process.env.NODE_ENV&&f.multiple&&f.singleMode&&(0,_log.errLog)("vxe.error.errConflicts",["multiple","single-mode"])}),(0,_vue.onUnmounted)(()=>{w.isDrag=!1}),t(),E},render(){return this.renderVN()}});