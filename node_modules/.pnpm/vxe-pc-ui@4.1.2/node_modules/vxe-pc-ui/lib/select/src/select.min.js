"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_dom=require("../../ui/src/dom"),_utils=require("../../ui/src/utils"),_input=_interopRequireDefault(require("../../input/src/input")),_vn=require("../../ui/src/vn");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function isOptionVisible(e){return!1!==e.visible}function getOptUniqueId(){return _xeUtils.default.uniqueId("opt_")}var _default=exports.default=(0,_vue.defineComponent)({name:"VxeSelect",props:{modelValue:[String,Number,Boolean,Array],clearable:Boolean,placeholder:String,readonly:{type:Boolean,default:null},loading:Boolean,disabled:{type:Boolean,default:null},multiple:Boolean,multiCharOverflow:{type:[Number,String],default:()=>(0,_ui.getConfig)().select.multiCharOverflow},prefixIcon:String,placement:String,options:Array,optionProps:Object,optionGroups:Array,optionGroupProps:Object,optionConfig:Object,className:[String,Function],popupClassName:[String,Function],max:{type:[String,Number],default:null},size:{type:String,default:()=>(0,_ui.getConfig)().select.size||(0,_ui.getConfig)().size},filterable:Boolean,filterMethod:Function,remote:Boolean,remoteMethod:Function,emptyText:String,optionId:{type:String,default:()=>(0,_ui.getConfig)().select.optionId},optionKey:Boolean,transfer:{type:Boolean,default:null}},emits:["update:modelValue","change","clear","blur","focus","click"],setup(m,e){const{slots:x,emit:i}=e,F=(0,_vue.inject)("$xeModal",null),B=(0,_vue.inject)("$xeTable",null),l=(0,_vue.inject)("$xeForm",null),u=(0,_vue.inject)("xeFormItemInfo",null);var K=_xeUtils.default.uniqueId();const w=(0,_ui.useSize)(m)["computeSize"],E=(0,_vue.reactive)({initialized:!1,staticOptions:[],fullGroupList:[],fullOptionList:[],visibleGroupList:[],visibleOptionList:[],remoteValueList:[],panelIndex:0,panelStyle:{},panelPlacement:null,currentOption:null,currentValue:null,triggerFocusPanel:!1,visiblePanel:!1,isAniVisible:!1,isActivated:!1,searchValue:"",searchLoading:!1}),b=(0,_vue.ref)(),h=(0,_vue.ref)(),O=(0,_vue.ref)(),L=(0,_vue.ref)(),V=(0,_vue.ref)(),q={refElem:b},T={xID:K,props:m,context:e,reactData:E,getRefMaps:()=>q};let o={};const D=(0,_vue.computed)(()=>{var e=m["readonly"];return null===e?!!l&&l.props.readonly:e}),y=(0,_vue.computed)(()=>{var e=m["disabled"];return null===e?!!l&&l.props.disabled:e}),A=(0,_vue.computed)(()=>{var e=m["transfer"];if(null===e){var t=(0,_ui.getConfig)().select.transfer;if(_xeUtils.default.isBoolean(t))return t;if(B||F||l)return!0}return e}),j=(0,_vue.computed)(()=>{var e=m["placeholder"];return(e=e||(0,_ui.getConfig)().select.placeholder)?(0,_utils.getFuncText)(e):(0,_ui.getI18n)("vxe.base.pleaseSelect")}),t=(0,_vue.computed)(()=>m.optionProps||{}),n=(0,_vue.computed)(()=>m.optionGroupProps||{}),a=(0,_vue.computed)(()=>{return t.value.label||"label"}),S=(0,_vue.computed)(()=>{return t.value.value||"value"}),c=(0,_vue.computed)(()=>{return n.value.label||"label"}),P=(0,_vue.computed)(()=>{return n.value.options||"options"}),z=(0,_vue.computed)(()=>{var{modelValue:e,multiple:t,max:l}=m;return!(!t||!l)&&(_xeUtils.default.isArray(e)?e.length:_xeUtils.default.eqNull(e)?0:1)>=_xeUtils.default.toNumber(l)}),I=(0,_vue.computed)(()=>Object.assign({},(0,_ui.getConfig)().select.optionConfig,m.optionConfig)),C=(0,_vue.computed)(()=>E.fullGroupList.some(e=>e.options&&e.options.length)),R=(0,_vue.computed)(()=>_xeUtils.default.toNumber(m.multiCharOverflow)),N=(e,t)=>e&&(_xeUtils.default.isString(e)&&(e=x[e]||null),_xeUtils.default.isFunction(e))?(0,_vn.getSlotVNs)(e(t)):[],s=t=>{var{fullOptionList:e,fullGroupList:l}=E,i=C.value;const u=S.value;if(i)for(let e=0;e<l.length;e++){var o=l[e];if(o.options)for(let e=0;e<o.options.length;e++){var n=o.options[e];if(t===n[u])return n}}return e.find(e=>t===e[u])},r=t=>{var e=E["remoteValueList"],l=a.value,e=e.find(e=>t===e.key),e=e?e.result:null;return _xeUtils.default.toValueString(e?e[l]:t)},v=e=>{var t=a.value,l=s(e);return _xeUtils.default.toValueString(l?l[t]:e)},M=(0,_vue.computed)(()=>{var{modelValue:e,multiple:t,remote:l}=m;const i=R.value;return e&&t?(t=_xeUtils.default.isArray(e)?e:[e],(l?t.map(e=>r(e)):t.map(e=>{e=v(e);return 0<i&&e.length>i?e.substring(0,i)+"...":e})).join(", ")):(l?r:v)(e)}),p=()=>{return I.value.keyField||m.optionId||"_X_OPTION_KEY"},U=e=>{e=e[p()];return e?encodeURIComponent(e):""},d=()=>{const{filterable:e,filterMethod:t}=m,{fullOptionList:l,fullGroupList:i,searchValue:u}=E;var o=C.value;const n=c.value,s=a.value;return o?e&&t?E.visibleGroupList=i.filter(e=>isOptionVisible(e)&&t({group:e,option:null,searchValue:u})):E.visibleGroupList=e?i.filter(e=>isOptionVisible(e)&&(!u||-1<(""+e[n]).indexOf(u))):i.filter(isOptionVisible):e&&t?E.visibleOptionList=l.filter(e=>isOptionVisible(e)&&t({group:null,option:e,searchValue:u})):E.visibleOptionList=e?l.filter(e=>isOptionVisible(e)&&(!u||-1<(""+e[s]).indexOf(u))):l.filter(isOptionVisible),(0,_vue.nextTick)()},f=()=>{var{fullOptionList:e,fullGroupList:t}=E;const l=P.value,i=p(),u=e=>{U(e)||(e[i]=getOptUniqueId())};t.length?t.forEach(e=>{u(e),e[l]&&e[l].forEach(u)}):e.length&&e.forEach(u),d()},G=e=>{var t=S.value;e&&(E.currentOption=e,E.currentValue=e[t])},$=(i,u)=>(0,_vue.nextTick)().then(()=>{var e,t,l;i&&(e=L.value,t=V.value.querySelector(`[optid='${U(i)}']`),e)&&t&&(l=e.offsetHeight,u?t.offsetTop+t.offsetHeight-e.scrollTop>l&&(e.scrollTop=t.offsetTop+t.offsetHeight-l):(t.offsetTop+5<e.scrollTop||t.offsetTop+5>e.scrollTop+e.clientHeight)&&(e.scrollTop=t.offsetTop-5))}),H=()=>(0,_vue.nextTick)().then(()=>{var i=m["placement"],u=E["panelIndex"],o=b.value,n=V.value,e=A.value;if(n&&o){var s=o.offsetHeight,a=o.offsetWidth,r=n.offsetHeight,n=n.offsetWidth,u={zIndex:u},{boundingTop:o,boundingLeft:v,visibleHeight:p,visibleWidth:c}=(0,_dom.getAbsolutePos)(o);let l="bottom";if(e){let e=v,t=o+s;"top"===i?(l="top",t=o-r):i||(t+r+5>p&&(l="top",t=o-r),t<5&&(l="bottom",t=o+s)),e+n+5>c&&(e-=e+n+5-c),e<5&&(e=5),Object.assign(u,{left:e+"px",top:t+"px",minWidth:a+"px"})}else"top"===i?(l="top",u.bottom=s+"px"):i||p<o+s+r&&5<o-s-r&&(l="top",u.bottom=s+"px");return E.panelStyle=u,E.panelPlacement=l,(0,_vue.nextTick)()}});let Y;const _=()=>{var{loading:e,filterable:t}=m,l=y.value;e||l||(clearTimeout(Y),E.initialized||(E.initialized=!0),E.isActivated=!0,E.isAniVisible=!0,t&&d(),setTimeout(()=>{var e=m["modelValue"],e=s(_xeUtils.default.isArray(e)?e[0]:e);E.visiblePanel=!0,e&&(G(e),$(e)),m.filterable&&(0,_vue.nextTick)(()=>{var e=O.value;e&&e.focus()})},10),E.panelIndex<(0,_utils.getLastZIndex)()&&(E.panelIndex=(0,_utils.nextZIndex)()),H())},g=()=>{E.searchValue="",E.searchLoading=!1,E.visiblePanel=!1,Y=window.setTimeout(()=>{E.isAniVisible=!1},350)},k=(e,t)=>{t!==m.modelValue&&(i("update:modelValue",t),o.dispatchEvent("change",{value:t},e),l)&&u&&l.triggerItemEvent(e,u.itemConfig.field,t)},W=(e,t)=>{E.remoteValueList=[],k(e,t),o.dispatchEvent("clear",{value:t},e)},Z=(e,t)=>{W(t,null),g()},X=(t,l,i)=>{var{modelValue:u,multiple:o}=m,n=E["remoteValueList"];if(o){let e=[];o=_xeUtils.default.eqNull(u)?[]:_xeUtils.default.isArray(u)?u:[u],u=_xeUtils.default.findIndexOf(o,e=>e===l),u=(e=-1===u?o.concat([l]):o.filter(e=>e!==l),n.find(e=>e.key===l));u?u.result=i:n.push({key:l,result:i}),k(t,e)}else E.remoteValueList=[{key:l,result:i}],k(t,l),g()},J=e=>{var t=E["visiblePanel"];y.value||t&&(t=V.value,((0,_dom.getEventTargetNode)(e,t).flag?H:g)())},Q=e=>{var t,l,i=E["visiblePanel"];y.value||(t=b.value,l=V.value,E.isActivated=(0,_dom.getEventTargetNode)(e,t).flag||(0,_dom.getEventTargetNode)(e,l).flag,i&&!E.isActivated&&g())},ee=l=>{var e=m["clearable"],{visiblePanel:t,currentValue:i,currentOption:u}=E;if(!y.value){var o=_ui.globalEvents.hasKey(l,_ui.GLOBAL_EVENT_KEYS.TAB),n=_ui.globalEvents.hasKey(l,_ui.GLOBAL_EVENT_KEYS.ENTER),s=_ui.globalEvents.hasKey(l,_ui.GLOBAL_EVENT_KEYS.ESCAPE),a=_ui.globalEvents.hasKey(l,_ui.GLOBAL_EVENT_KEYS.ARROW_UP),r=_ui.globalEvents.hasKey(l,_ui.GLOBAL_EVENT_KEYS.ARROW_DOWN),v=_ui.globalEvents.hasKey(l,_ui.GLOBAL_EVENT_KEYS.DELETE),p=_ui.globalEvents.hasKey(l,_ui.GLOBAL_EVENT_KEYS.SPACEBAR);if(o&&(E.isActivated=!1),t)if(s||o)g();else if(n)l.preventDefault(),l.stopPropagation(),X(l,i,u);else if(a||r){l.preventDefault();let{firstOption:e,offsetOption:t}=((t,l)=>{var{visibleOptionList:i,visibleGroupList:u}=E,e=C.value,o=S.value,n=P.value;let s,a,r,v;if(e)for(let e=0;e<u.length;e++){var p=u[e],c=p[n],d=p.disabled;if(c)for(let e=0;e<c.length;e++){var f=c[e],_=isOptionVisible(f),g=d||f.disabled;if(s||g||(s=f),v&&_&&!g&&(r=f,!l))return{offsetOption:r};if(t===f[o]){if(v=f,l)return{offsetOption:a}}else _&&!g&&(a=f)}}else for(let e=0;e<i.length;e++){var b=i[e],h=b.disabled;if(s||h||(s=b),v&&!h&&(r=b,!l))return{offsetOption:r};if(t===b[o]){if(v=b,l)return{offsetOption:a}}else h||(a=b)}return{firstOption:s}})(i,a);t||(t=>{var{visibleOptionList:e,visibleGroupList:l}=E,i=C.value;const u=S.value;if(i)for(let e=0;e<l.length;e++){var o=l[e];if(o.options)for(let e=0;e<o.options.length;e++){var n=o.options[e];if(t===n[u])return n}}return e.find(e=>t===e[u])})(i)||(t=e),G(t),$(t,r)}else p&&l.preventDefault();else(a||r||n||p)&&E.isActivated&&(l.preventDefault(),_());E.isActivated&&v&&e&&W(l,null)}},te=()=>{g()},le=e=>{y.value||E.visiblePanel||(E.triggerFocusPanel=!0,_(),setTimeout(()=>{E.triggerFocusPanel=!1},150)),o.dispatchEvent("focus",{},e)},ie=e=>{ae(e),o.dispatchEvent("click",{},e)},ue=e=>{E.isActivated=!1,o.dispatchEvent("blur",{},e)},oe=e=>{E.searchValue=e},ne=()=>{E.isActivated=!0},se=_xeUtils.default.debounce(function(){var{remote:e,remoteMethod:t}=m,l=E["searchValue"];e&&t?(E.searchLoading=!0,Promise.resolve(t({searchValue:l})).then(()=>(0,_vue.nextTick)()).catch(()=>(0,_vue.nextTick)()).finally(()=>{E.searchLoading=!1,d()})):d()},350,{trailing:!0}),ae=e=>{e=e.$event;e.preventDefault(),E.triggerFocusPanel?E.triggerFocusPanel=!1:(E.visiblePanel?g:_)()},re=(e,v)=>{const{optionKey:p,modelValue:c}=m,d=E["currentValue"];var t=I.value;const f=a.value,_=S.value,g=C.value,b=t["useKey"],h=x.option;return e.map((t,e)=>{var{slots:l,className:i}=t;const u=t[_];var o=_xeUtils.default.isArray(c)?-1<c.indexOf(u):c===u,n=!g||isOptionVisible(t);r=o,a=v;const s=!!t.disabled||!(!a||!a.disabled)||!(!z.value||r);var a=U(t),r=l?l.default:null,l={option:t,group:null,$select:T};return n?(0,_vue.h)("div",{key:b||p?a:e,class:["vxe-select-option",i?_xeUtils.default.isFunction(i)?i(l):i:"",{"is--disabled":s,"is--selected":o,"is--hover":d===u}],optid:a,onMousedown:e=>{0===e.button&&e.stopPropagation()},onClick:e=>{s||X(e,u,t)},onMouseenter:()=>{s||G(t)}},h?N(h,l):r?N(r,l):(0,_utils.getFuncText)(t[f])):(0,_vue.createCommentVNode)()})},ve=()=>{const s=m["optionKey"];var e=E["visibleGroupList"],t=I.value;const a=c.value,r=P.value,v=t["useKey"],p=x.option;return e.map((e,t)=>{var{slots:l,className:i}=e,u=U(e),o=e.disabled,l=l?l.default:null,n={option:e,group:e,$select:T};return(0,_vue.h)("div",{key:v||s?u:t,class:["vxe-optgroup",i?_xeUtils.default.isFunction(i)?i(n):i:"",{"is--disabled":o}],optid:u},[(0,_vue.h)("div",{class:"vxe-optgroup--title"},p?N(p,n):l?N(l,n):(0,_utils.getFuncText)(e[a])),(0,_vue.h)("div",{class:"vxe-optgroup--wrapper"},re(e[r]||[],e))])})};o={dispatchEvent(e,t,l){i(e,(0,_ui.createEvent)(l,{$select:T},t))},isPanelVisible(){return E.visiblePanel},togglePanel(){return(E.visiblePanel?g:_)(),(0,_vue.nextTick)()},hidePanel(){return E.visiblePanel&&g(),(0,_vue.nextTick)()},showPanel(){return E.visiblePanel||_(),(0,_vue.nextTick)()},refreshOption:d,focus(){var e=h.value;return E.isActivated=!0,e.blur(),(0,_vue.nextTick)()},blur(){return h.value.blur(),(E.isActivated=!1,_vue.nextTick)()}},Object.assign(T,o);return T.renderVN=()=>{var{className:e,popupClassName:t,loading:l,filterable:i}=m,{initialized:u,isActivated:o,visiblePanel:n}=E,s=w.value,a=y.value,r=M.value,v=A.value,p=D.value,c=j.value,d=x.default,f=x.header,_=x.footer;const g=x.prefix;return p?(0,_vue.h)("div",{ref:b,class:["vxe-select--readonly",e]},[(0,_vue.h)("div",{class:"vxe-select-slots",ref:"hideOption"},d?d({}):[]),(0,_vue.h)("span",{class:"vxe-select-label"},r)]):(0,_vue.h)("div",{ref:b,class:["vxe-select",e?_xeUtils.default.isFunction(e)?e({$select:T}):e:"",{["size--"+s]:s,"is--visible":n,"is--disabled":a,"is--filter":i,"is--loading":l,"is--active":o}]},[(0,_vue.h)("div",{class:"vxe-select-slots",ref:"hideOption"},d?d({}):[]),(0,_vue.h)(_input.default,{ref:h,clearable:m.clearable,placeholder:c,readonly:!0,disabled:a,type:"text",prefixIcon:m.prefixIcon,suffixIcon:l?(0,_ui.getIcon)().SELECT_LOADED:n?(0,_ui.getIcon)().SELECT_OPEN:(0,_ui.getIcon)().SELECT_CLOSE,modelValue:r,onClear:Z,onClick:ie,onFocus:le,onBlur:ue,onSuffixClick:ae},g?{prefix:()=>g({})}:{}),(0,_vue.h)(_vue.Teleport,{to:"body",disabled:!v||!u},[(0,_vue.h)("div",{ref:V,class:["vxe-table--ignore-clear vxe-select--panel",t?_xeUtils.default.isFunction(t)?t({$select:T}):t:"",{["size--"+s]:s,"is--transfer":v,"ani--leave":!l&&E.isAniVisible,"ani--enter":!l&&n}],placement:E.panelPlacement,style:E.panelStyle},u?[i?(0,_vue.h)("div",{class:"vxe-select--panel-search"},[(0,_vue.h)(_input.default,{ref:O,class:"vxe-select-search--input",modelValue:E.searchValue,clearable:!0,placeholder:(0,_ui.getI18n)("vxe.select.search"),prefixIcon:(0,_ui.getIcon)().INPUT_SEARCH,"onUpdate:modelValue":oe,onFocus:ne,onChange:se,onSearch:se})]):(0,_vue.createCommentVNode)(),(0,_vue.h)("div",{class:"vxe-select--panel-wrapper"},[f?(0,_vue.h)("div",{class:"vxe-select--panel-header"},f({})):(0,_vue.createCommentVNode)(),(0,_vue.h)("div",{class:"vxe-select--panel-body"},[(0,_vue.h)("div",{ref:L,class:"vxe-select-option--wrapper"},(()=>{var{visibleGroupList:e,visibleOptionList:t,searchLoading:l}=E,i=C.value;if(l)return[(0,_vue.h)("div",{class:"vxe-select--search-loading"},[(0,_vue.h)("i",{class:["vxe-select--search-icon",(0,_ui.getIcon)().SELECT_LOADED]}),(0,_vue.h)("span",{class:"vxe-select--search-text"},(0,_ui.getI18n)("vxe.select.loadingText"))])];if(i){if(e.length)return ve()}else if(t.length)return re(t);return[(0,_vue.h)("div",{class:"vxe-select--empty-placeholder"},m.emptyText||(0,_ui.getI18n)("vxe.select.emptyText"))]})())]),_?(0,_vue.h)("div",{class:"vxe-select--panel-footer"},_({})):(0,_vue.createCommentVNode)()])]:[])])])},(0,_vue.watch)(()=>E.staticOptions,e=>{e.some(e=>e.options&&e.options.length)?(E.fullOptionList=[],E.fullGroupList=e):(E.fullGroupList=[],E.fullOptionList=e||[]),f()}),(0,_vue.watch)(()=>m.options,e=>{E.fullGroupList=[],E.fullOptionList=e||[],f()}),(0,_vue.watch)(()=>m.optionGroups,e=>{E.fullOptionList=[],E.fullGroupList=e||[],f()}),(0,_vue.onMounted)(()=>{(0,_vue.nextTick)(()=>{var{options:e,optionGroups:t}=m;t?E.fullGroupList=t:e&&(E.fullOptionList=e),f()}),_ui.globalEvents.on(T,"mousewheel",J),_ui.globalEvents.on(T,"mousedown",Q),_ui.globalEvents.on(T,"keydown",ee),_ui.globalEvents.on(T,"blur",te)}),(0,_vue.onUnmounted)(()=>{_ui.globalEvents.off(T,"mousewheel"),_ui.globalEvents.off(T,"mousedown"),_ui.globalEvents.off(T,"keydown"),_ui.globalEvents.off(T,"blur")}),(0,_vue.provide)("$xeSelect",T),T},render(){return this.renderVN()}});