"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_ui=require("../../ui"),_dom=require("../../ui/src/dom"),_utils=require("../../ui/src/utils"),_xeUtils=_interopRequireDefault(require("xe-utils")),_input=_interopRequireDefault(require("../../input/src/input")),_tree=_interopRequireDefault(require("../../tree/src/tree"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function getOptUniqueId(){return _xeUtils.default.uniqueId("node_")}var _default=exports.default=(0,_vue.defineComponent)({name:"VxeTreeSelect",props:{modelValue:[String,Number,Array],clearable:Boolean,placeholder:{type:String,default:()=>_xeUtils.default.eqNull((0,_ui.getConfig)().select.placeholder)?(0,_ui.getI18n)("vxe.base.pleaseSelect"):(0,_ui.getConfig)().select.placeholder},readonly:{type:Boolean,default:null},loading:Boolean,disabled:{type:Boolean,default:null},multiple:Boolean,className:[String,Function],popupClassName:[String,Function],prefixIcon:String,placement:String,options:Array,optionProps:Object,size:{type:String,default:()=>(0,_ui.getConfig)().select.size||(0,_ui.getConfig)().size},remote:Boolean,remoteMethod:Function,treeConfig:Object,transfer:{type:Boolean,default:null}},emits:["update:modelValue","change","clear","blur","focus","click","node-click"],setup(N,e){const{emit:i,slots:P}=e,l=(0,_vue.inject)("$xeModal",null),a=(0,_vue.inject)("$xeTable",null),n=(0,_vue.inject)("$xeForm",null),o=(0,_vue.inject)("xeFormItemInfo",null);var t=_xeUtils.default.uniqueId();const T=(0,_ui.useSize)(N)["computeSize"],O=(0,_vue.ref)(),k=(0,_vue.ref)(),w=(0,_vue.ref)(),q=(0,_vue.ref)(),V=(0,_vue.reactive)({initialized:!1,fullOptionList:[],fullNodeMaps:{},visibleOptionList:[],panelIndex:0,panelStyle:{},panelPlacement:null,triggerFocusPanel:!1,visiblePanel:!1,animatVisible:!1,isActivated:!1}),u={refElem:O},M=(0,_vue.computed)(()=>{var e=N["readonly"];return null===e?!!n&&n.props.readonly:e}),j=(0,_vue.computed)(()=>{var e=N["disabled"];return null===e?!!n&&n.props.disabled:e}),z=(0,_vue.computed)(()=>{var e=N["transfer"];if(null===e){var t=(0,_ui.getConfig)().select.transfer;if(_xeUtils.default.isBoolean(t))return t;if(a||l||n)return!0}return e}),L=(0,_vue.computed)(()=>Object.assign({},(0,_ui.getConfig)().treeSelect.treeConfig,N.treeConfig)),U=(0,_vue.computed)(()=>{var e=L.value;return Object.assign({isHover:!0},e.nodeConfig)}),R=(0,_vue.computed)(()=>{var e=L.value;return Object.assign({showIcon:!!e.showCheckbox},e.checkboxConfig,{trigger:"node"})}),A=(0,_vue.computed)(()=>{var e=L.value;return Object.assign({showIcon:!!e.showRadio},e.radioConfig,{trigger:"node"})}),r=(0,_vue.computed)(()=>N.optionProps||{}),$=(0,_vue.computed)(()=>{return r.value.label||"label"}),B=(0,_vue.computed)(()=>{return r.value.value||"value"}),D=(0,_vue.computed)(()=>{return r.value.children||"children"}),K=(0,_vue.computed)(()=>{return r.value.parent||"parentField"}),Z=(0,_vue.computed)(()=>{return r.value.hasChild||"hasChild"}),G=(0,_vue.computed)(()=>{var e=N["modelValue"];const i=V["fullNodeMaps"];return(_xeUtils.default.isArray(e)?e:[e]).map(e=>{var t=i[e],l=$.value;return t?t.item[l]:e}).join(", ")}),g={},H={xID:t,props:N,context:e,reactData:V,getRefMaps:()=>u,getComputeMaps:()=>g},s={dispatchEvent(e,t,l){i(e,(0,_ui.createEvent)(l,{$treeSelect:H},t))}},d=()=>{var e=N["options"];const o=B.value;var t=D.value;const u={};_xeUtils.default.eachTree(e,(e,t,l,i,a)=>{let n=(e=>{e=e[B.value];return e?encodeURIComponent(e):""})(e);n||(n=getOptUniqueId(),e[o]=n),u[n]={item:e,index:t,items:l,parent:i,nodes:a}},{children:t}),V.fullOptionList=e||[],V.fullNodeMaps=u,(0,_vue.nextTick)()},v=()=>(0,_vue.nextTick)().then(()=>{var i=N["placement"],a=V["panelIndex"],n=O.value,o=q.value,e=z.value;if(o&&n){var u=n.offsetHeight,r=n.offsetWidth,s=o.offsetHeight,o=o.offsetWidth,a={zIndex:a},{boundingTop:n,boundingLeft:d,visibleHeight:v,visibleWidth:c}=(0,_dom.getAbsolutePos)(n);let l="bottom";if(e){let e=d,t=n+u;"top"===i?(l="top",t=n-s):i||(t+s+5>v&&(l="top",t=n-s),t<5&&(l="bottom",t=n+u)),e+o+5>c&&(e-=e+o+5-c),e<5&&(e=5),Object.assign(a,{left:e+"px",top:t+"px",minWidth:r+"px"})}else"top"===i?(l="top",a.bottom=u+"px"):i||v<n+u+s&&5<n-u-s&&(l="top",a.bottom=u+"px");return V.panelStyle=a,V.panelPlacement=l,(0,_vue.nextTick)()}});let c;const p=()=>{var e=N["loading"],t=j.value;e||t||(clearTimeout(c),V.initialized||(V.initialized=!0),V.isActivated=!0,V.animatVisible=!0,setTimeout(()=>{V.visiblePanel=!0},10),V.panelIndex<(0,_utils.getLastZIndex)()&&(V.panelIndex=(0,_utils.nextZIndex)()),v())},f=()=>{V.visiblePanel=!1,c=window.setTimeout(()=>{V.animatVisible=!1},350)},_=(e,t)=>{var l=V["fullNodeMaps"];t!==N.modelValue&&(l=l[t],i("update:modelValue",t),s.dispatchEvent("change",{value:t,option:l?l.item:null},e),n)&&o&&n.triggerItemEvent(e,o.itemConfig.field,t)},m=(e,t)=>{_(e,t),s.dispatchEvent("clear",{value:t},e)},J=(e,t)=>{m(t,null),f()},h=e=>{var t=V["visiblePanel"];j.value||t&&(t=q.value,((0,_dom.getEventTargetNode)(e,t).flag?v:f)())},b=e=>{var t,l,i=V["visiblePanel"];j.value||(t=O.value,l=q.value,V.isActivated=(0,_dom.getEventTargetNode)(e,t).flag||(0,_dom.getEventTargetNode)(e,l).flag,i&&!V.isActivated&&f())},x=()=>{f()},Q=e=>{j.value||V.visiblePanel||(V.triggerFocusPanel=!0,p(),setTimeout(()=>{V.triggerFocusPanel=!1},150)),s.dispatchEvent("focus",{},e)},X=e=>{W(e),s.dispatchEvent("click",{},e)},Y=e=>{V.isActivated=!1,s.dispatchEvent("blur",{},e)},W=e=>{e=e.$event;e.preventDefault(),V.triggerFocusPanel?V.triggerFocusPanel=!1:(V.visiblePanel?f:p)()},ee=e=>{var t=e["$event"];s.dispatchEvent("node-click",e,t)},te=e=>{var{value:e,$event:t}=e;_(t,e),f()},le=e=>{var{value:e,$event:t}=e;_(t,e)};Object.assign(H,s,{});return H.renderVN=()=>{var{className:e,modelValue:t,multiple:l,options:i,popupClassName:a,loading:n}=N,{initialized:o,isActivated:u,visiblePanel:r}=V,s=T.value,d=j.value,v=G.value,c=z.value,p=M.value,f=P.default,_=P.header,g=P.footer;const m=P.prefix;var h=L.value,b=U.value,x=R.value,C=A.value,E=$.value,I=B.value,y=D.value,F=K.value,S=Z.value;return p?(0,_vue.h)("div",{ref:O,class:["vxe-tree-select--readonly",e]},[(0,_vue.h)("div",{class:"vxe-tree-select-slots",ref:"hideOption"},f?f({}):[]),(0,_vue.h)("span",{class:"vxe-tree-select-label"},v)]):(0,_vue.h)("div",{ref:O,class:["vxe-tree-select",e?_xeUtils.default.isFunction(e)?e({$treeSelect:H}):e:"",{["size--"+s]:s,"is--visible":r,"is--disabled":d,"is--loading":n,"is--active":u}]},[(0,_vue.h)(_input.default,{ref:k,clearable:N.clearable,placeholder:N.placeholder,readonly:!0,disabled:d,type:"text",prefixIcon:N.prefixIcon,suffixIcon:n?(0,_ui.getIcon)().TREE_SELECT_LOADED:r?(0,_ui.getIcon)().TREE_SELECT_OPEN:(0,_ui.getIcon)().TREE_SELECT_CLOSE,modelValue:v,onClear:J,onClick:X,onFocus:Q,onBlur:Y,onSuffixClick:W},m?{prefix:()=>m({})}:{}),(0,_vue.h)(_vue.Teleport,{to:"body",disabled:!c||!o},[(0,_vue.h)("div",{ref:q,class:["vxe-table--ignore-clear vxe-tree-select--panel",a?_xeUtils.default.isFunction(a)?a({$treeSelect:H}):a:"",{["size--"+s]:s,"is--transfer":c,"animat--leave":!n&&V.animatVisible,"animat--enter":!n&&r}],placement:V.panelPlacement,style:V.panelStyle},o?[(0,_vue.h)("div",{class:"vxe-tree-select--panel-wrapper"},[_?(0,_vue.h)("div",{class:"vxe-tree-select--panel-header"},_({})):(0,_vue.createCommentVNode)(),(0,_vue.h)("div",{class:"vxe-tree-select--panel-body"},[(0,_vue.h)("div",{ref:w,class:"vxe-tree-select-option--wrapper"},[(0,_vue.h)(_tree.default,{class:"vxe-tree-select--tree",data:i,indent:h.indent,showRadio:!l,radioConfig:C,checkNodeKey:l?null:t,showCheckbox:!!l,checkNodeKeys:l?t:null,checkboxConfig:x,titleField:E,valueField:I,keyField:h.keyField,childrenField:h.childrenField||y,parentField:h.parentField||F,hasChildField:h.hasChildField||S,accordion:h.accordion,nodeConfig:b,lazy:h.lazy,loadMethod:h.loadMethod,toggleMethod:h.toggleMethod,transform:h.transform,trigger:h.trigger,showIcon:h.showIcon,showLine:h.showLine,iconOpen:h.iconOpen,iconLoaded:h.iconLoaded,iconClose:h.iconClose,onNodeClick:ee,onRadioChange:te,onCheckboxChange:le})])]),g?(0,_vue.h)("div",{class:"vxe-tree-select--panel-footer"},g({})):(0,_vue.createCommentVNode)()])]:[])])])},(0,_vue.watch)(()=>N.options,()=>{d()}),d(),(0,_vue.onMounted)(()=>{_ui.globalEvents.on(H,"mousewheel",h),_ui.globalEvents.on(H,"mousedown",b),_ui.globalEvents.on(H,"blur",x)}),(0,_vue.onUnmounted)(()=>{_ui.globalEvents.off(H,"mousewheel"),_ui.globalEvents.off(H,"mousedown"),_ui.globalEvents.off(H,"blur")}),H},render(){return this.renderVN()}});