"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0,exports.handleNumber=handleNumber,exports.toFloatValueFixed=toFloatValueFixed;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_utils=require("../../ui/src/utils"),_dom=require("../../ui/src/dom"),_vn=require("../..//ui/src/vn");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function handleNumber(e){return _xeUtils.default.isString(e)?e.replace(/,/g,""):e}function toFloatValueFixed(e,t){return/^-/.test(""+e)?_xeUtils.default.toFixed(_xeUtils.default.ceil(e,t),t):_xeUtils.default.toFixed(_xeUtils.default.floor(e,t),t)}var _default=exports.default=(0,_vue.defineComponent)({name:"VxeNumberInput",props:{modelValue:[String,Number],immediate:{type:Boolean,default:!0},name:String,type:{type:String,default:"number"},clearable:{type:Boolean,default:()=>(0,_ui.getConfig)().numberInput.clearable},readonly:{type:Boolean,default:null},disabled:{type:Boolean,default:null},placeholder:String,maxLength:[String,Number],autoComplete:{type:String,default:"off"},align:String,form:String,className:String,size:{type:String,default:()=>(0,_ui.getConfig)().numberInput.size||(0,_ui.getConfig)().size},multiple:Boolean,min:{type:[String,Number],default:null},max:{type:[String,Number],default:null},step:[String,Number],exponential:{type:Boolean,default:()=>(0,_ui.getConfig)().numberInput.exponential},controls:{type:Boolean,default:()=>(0,_ui.getConfig)().numberInput.controls},digits:{type:[String,Number],default:()=>(0,_ui.getConfig)().numberInput.digits},prefixIcon:String,suffixIcon:String,maxlength:[String,Number],autocomplete:String},emits:["update:modelValue","input","change","keydown","keyup","wheel","click","focus","blur","clear","prev-number","next-number","prefix-click","suffix-click"],setup(N,e){const{slots:E,emit:a}=e,i=(0,_vue.inject)("$xeForm",null),n=(0,_vue.inject)("xeFormItemInfo",null);var K=_xeUtils.default.uniqueId();const M=(0,_ui.useSize)(N)["computeSize"],y=(0,_vue.reactive)({isActivated:!1,inputValue:N.modelValue}),V=(0,_vue.ref)(),U=(0,_vue.ref)(),R=(0,_vue.ref)(),q={refElem:V,refInput:U},l={xID:K,props:N,context:e,reactData:y,getRefMaps:()=>q};let r={};const S=(0,_vue.computed)(()=>{var e=N["readonly"];return null===e?!!i&&i.props.readonly:e}),I=(0,_vue.computed)(()=>{var e=N["disabled"];return null===e?!!i&&i.props.disabled:e}),o=(0,_vue.computed)(()=>!0),s=(0,_vue.computed)(()=>_xeUtils.default.toInteger(N.digits)||1),O=(0,_vue.computed)(()=>{var e=N["type"],t=s.value,u=N.step;return"integer"===e?_xeUtils.default.toInteger(u)||1:"float"===e?_xeUtils.default.toNumber(u)||1/Math.pow(10,t):_xeUtils.default.toNumber(u)||1}),C=(0,_vue.computed)(()=>N.clearable),A=(0,_vue.computed)(()=>{var e=N["multiple"];return S.value||e}),D=(0,_vue.computed)(()=>{var e=N["placeholder"];return(e=e||(0,_ui.getConfig)().numberInput.placeholder)?(0,_utils.getFuncText)(e):(0,_ui.getI18n)("vxe.base.pleaseInput")}),T=(0,_vue.computed)(()=>{var{maxLength:e,maxlength:t}=N;return _xeUtils.default.toNumber(e||t)||16}),v=(0,_vue.computed)(()=>{var{type:e,immediate:t}=N;return t||!("number"===e||"integer"===e||"float"===e)}),d=(0,_vue.computed)(()=>{var e=N["type"],t=y["inputValue"];return o.value?"integer"===e?_xeUtils.default.toInteger(handleNumber(t)):_xeUtils.default.toNumber(handleNumber(t)):0}),P=(0,_vue.computed)(()=>{var e=y["inputValue"];return _xeUtils.default.toString(e)}),c=(0,_vue.computed)(()=>{var e=N["min"],t=y["inputValue"],u=o.value,l=d.value;return!(!t&&0!==t||!u||null===e)&&l<=_xeUtils.default.toNumber(e)}),p=(0,_vue.computed)(()=>{var e=N["max"],t=y["inputValue"],u=o.value,l=d.value;return!(!t&&0!==t||!u||null===e)&&l>=_xeUtils.default.toNumber(e)}),_=e=>{var{type:t,exponential:u}=N,l=T.value,a=s.value,t="float"===t?toFloatValueFixed(e,a):_xeUtils.default.toValueString(e);return!u||e!==t&&_xeUtils.default.toValueString(e).toLowerCase()!==_xeUtils.default.toNumber(t).toExponential()?t.slice(0,l):e},m=e=>{var t=y["inputValue"];r.dispatchEvent(e.type,{value:t},e)},f=(e,t,u)=>{var l=Number(e)!==N.modelValue;l&&(y.inputValue=t||"",a("update:modelValue",e?Number(e):null)),r.dispatchEvent("input",{value:e},u),l&&(r.dispatchEvent("change",{value:e},u),i)&&n&&i.triggerItemEvent(u,n.itemConfig.field,e)},x=(e,t)=>{var u=v.value,l=e?_xeUtils.default.toNumber(e):null;y.inputValue=e,u?f(l,e,t):r.dispatchEvent("input",{value:l},t)},z=e=>{var t=e.target.value;x(t,e)},Y=e=>{v.value||m(e)},j=e=>{y.isActivated=!0,m(e)},G=e=>{var t;I.value||(t=y["inputValue"],r.dispatchEvent("prefix-click",{value:t},e))},w=(e,t)=>{focus(),f(null,"",e),r.dispatchEvent("clear",{value:t},e)},W=e=>{var t;I.value||(t=y["inputValue"],r.dispatchEvent("suffix-click",{value:t},e))},t=()=>{var e=N["type"],u=y["inputValue"],l=s.value;if("float"===e&&u){let e="",t=null;u&&(e=toFloatValueFixed(u,l),t=Number(e)),u!==t&&f(t,e,{type:"init"})}},b=e=>null===N.max||_xeUtils.default.toNumber(e)<=_xeUtils.default.toNumber(N.max),g=e=>null===N.min||_xeUtils.default.toNumber(e)>=_xeUtils.default.toNumber(N.min),h=()=>{var{type:t,min:u,max:l,exponential:a}=N,i=y["inputValue"],n=A.value;if(!n&&i){let e="integer"===t?_xeUtils.default.toInteger(handleNumber(i)):_xeUtils.default.toNumber(handleNumber(i));g(e)?b(e)||(e=l):e=u,a&&(n=_xeUtils.default.toValueString(i).toLowerCase())===_xeUtils.default.toNumber(e).toExponential()&&(e=n);t=_(e);f(null===t?null:Number(t),t,{type:"check"})}},$=e=>{var t=y["inputValue"],u=v.value,l=t?Number(t):null;u||f(l,""+(t||""),e),h(),y.isActivated=!1,r.dispatchEvent("blur",{value:l},e)},k=(e,t)=>{var{min:u,max:l,type:a}=N,i=y["inputValue"],n=O.value,a="integer"===a?_xeUtils.default.toInteger(handleNumber(i)):_xeUtils.default.toNumber(handleNumber(i)),i=e?_xeUtils.default.add(a,n):_xeUtils.default.subtract(a,n);let r;r=g(i)?b(i)?i:l:u,x(_(r),t)};let B;const F=e=>{var t=I.value,u=S.value,l=c.value;clearTimeout(B),t||u||l||k(!1,e),r.dispatchEvent("next-number",{},e)},X=e=>{B=window.setTimeout(()=>{F(e),X(e)},60)},L=e=>{var t=I.value,u=S.value,l=p.value;clearTimeout(B),t||u||l||k(!0,e),r.dispatchEvent("prev-number",{},e)},H=e=>{var t=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ARROW_UP),u=_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.ARROW_DOWN);(t||u)&&(e.preventDefault(),(t?L:F)(e))},J=e=>{var t,u,l,a,{exponential:i,controls:n}=N;o.value&&(t=e.ctrlKey,u=e.shiftKey,l=e.altKey,a=e.keyCode,t||u||l||!(_ui.globalEvents.hasKey(e,_ui.GLOBAL_EVENT_KEYS.SPACEBAR)||(!i||69!==a)&&65<=a&&a<=90||186<=a&&a<=188||191<=a)||e.preventDefault(),n)&&H(e),m(e)},Q=e=>{m(e)},u=()=>{clearTimeout(B)},Z=e=>{B=window.setTimeout(()=>{L(e),Z(e)},60)},ee=e=>{if(u(),0===e.button){const t=(0,_dom.hasClass)(e.currentTarget,"is--prev");(t?L:F)(e),B=window.setTimeout(()=>{(t?Z:X)(e)},500)}},te=e=>{var t;o.value&&N.controls&&y.isActivated&&(0<(t=e.deltaY)?F(e):t<0&&L(e),e.preventDefault()),m(e)},ue=e=>{m(e)},le=e=>{var t=y["isActivated"],u=V.value,l=R.value;!I.value&&t&&(y.isActivated=(0,_dom.getEventTargetNode)(e,u).flag||(0,_dom.getEventTargetNode)(e,l).flag,y.isActivated||h())},ae=t=>{var u=N["clearable"];if(!I.value){var l=_ui.globalEvents.hasKey(t,_ui.GLOBAL_EVENT_KEYS.TAB),a=_ui.globalEvents.hasKey(t,_ui.GLOBAL_EVENT_KEYS.DELETE);let e=y.isActivated;l&&(e&&h(),e=!1,y.isActivated=e),a&&u&&e&&w(t,null)}},ie=()=>{var e=y["isActivated"];e&&h()},ne=()=>{var e,t=N["controls"];return t?(t=p.value,e=c.value,(0,_vue.h)("div",{class:"vxe-input--control-icon"},[(0,_vue.h)("div",{class:"vxe-input--number-icon"},[(0,_vue.h)("div",{class:["vxe-input--number-btn is--prev",{"is--disabled":t}],onMousedown:ee,onMouseup:u,onMouseleave:u},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().NUMBER_INPUT_PREV_NUM})]),(0,_vue.h)("div",{class:["vxe-input--number-btn is--next",{"is--disabled":e}],onMousedown:ee,onMouseup:u,onMouseleave:u},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().NUMBER_INPUT_NEXT_NUM})])])])):(0,_vue.createCommentVNode)()};r={dispatchEvent(e,t,u){a(e,(0,_ui.createEvent)(u,{$input:l},t))},focus(){var e=U.value;return y.isActivated=!0,e.focus(),(0,_vue.nextTick)()},blur(){return U.value.blur(),(y.isActivated=!1,_vue.nextTick)()},select(){return U.value.select(),(y.isActivated=!1,_vue.nextTick)()}},Object.assign(l,r),(0,_vue.watch)(()=>N.modelValue,e=>{y.inputValue=e}),(0,_vue.watch)(()=>N.type,()=>{Object.assign(y,{inputValue:N.modelValue}),t()}),(0,_vue.nextTick)(()=>{_ui.globalEvents.on(l,"mousedown",le),_ui.globalEvents.on(l,"keydown",ae),_ui.globalEvents.on(l,"blur",ie)}),(0,_vue.onUnmounted)(()=>{u(),_ui.globalEvents.off(l,"mousedown"),_ui.globalEvents.off(l,"keydown"),_ui.globalEvents.off(l,"blur")}),t();return l.renderVN=()=>{var e,t,u,l,a,i,n,r,{className:o,controls:s,type:v,align:d,name:c,autocomplete:p,autoComplete:_}=N,{inputValue:m,isActivated:f}=y,x=M.value,b=I.value,g=S.value,h=P.value;return g?(0,_vue.h)("div",{ref:V,class:["vxe-number-input--readonly","type--"+v,o]},h):(g=A.value,h=T.value,e=D.value,t=C.value,l=N.prefixIcon,u=(u=E.prefix)||l?(0,_vue.h)("div",{class:"vxe-number-input--prefix",onClick:G},[(0,_vue.h)("div",{class:"vxe-number-input--prefix-icon"},u?(0,_vn.getSlotVNs)(u({})):[(0,_vue.h)("i",{class:l})])]):null,l=N.suffixIcon,a=y.inputValue,i=E.suffix,n=I.value,r=C.value,n=(0,_vue.h)("div",{class:["vxe-number-input--suffix",{"is--clear":r&&!n&&!(""===a||_xeUtils.default.eqNull(a))}]},[r?(0,_vue.h)("div",{class:"vxe-number-input--clear-icon",onClick:w},[(0,_vue.h)("i",{class:(0,_ui.getIcon)().INPUT_CLEAR})]):(0,_vue.createCommentVNode)(),ne(),i||l?(0,_vue.h)("div",{class:"vxe-number-input--suffix-icon",onClick:W},i?(0,_vn.getSlotVNs)(i({})):[(0,_vue.h)("i",{class:l})]):(0,_vue.createCommentVNode)()]),(0,_vue.h)("div",{ref:V,class:["vxe-number-input","type--"+v,o,{["size--"+x]:x,["is--"+d]:d,"is--controls":s,"is--prefix":!!u,"is--suffix":!!n,"is--disabled":b,"is--active":f,"show--clear":t&&!b&&!(""===m||_xeUtils.default.eqNull(m))}],spellcheck:!1},[u||(0,_vue.createCommentVNode)(),(0,_vue.h)("div",{class:"vxe-number-input--wrapper"},[(0,_vue.h)("input",{ref:U,class:"vxe-number-input--inner",value:m,name:c,type:"text",placeholder:e,maxlength:h,readonly:g,disabled:b,autocomplete:_||p,onKeydown:J,onKeyup:Q,onWheel:te,onClick:ue,onInput:z,onChange:Y,onFocus:j,onBlur:$})]),n||(0,_vue.createCommentVNode)()]))},l},render(){return this.renderVN()}});