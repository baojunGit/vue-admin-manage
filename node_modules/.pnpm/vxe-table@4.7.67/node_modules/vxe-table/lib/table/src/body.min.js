"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_ui=require("../../ui"),_util=require("./util"),_dom=require("../../ui/src/dom"),_utils=require("../../ui/src/utils"),_vn=require("../../ui/src/vn");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const{getI18n,renderer}=_ui.VxeUI,renderType="body",lineOffsetSizes={mini:3,small:2,medium:1};var _default=exports.default=(0,_vue.defineComponent)({name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,fixedColumn:Array,fixedType:{type:String,default:null}},setup(f){const ae=(0,_vue.inject)("$xeTable",{}),l=(0,_vue.inject)("xesize",null),{xID:w,props:se,context:y,reactData:ie,internalData:ne}=ae,{refTableHeader:_,refTableBody:b,refTableFooter:q,refTableLeftBody:T,refTableRightBody:S,refValidTooltip:j}=ae.getRefMaps(),{computeEditOpts:ue,computeMouseOpts:B,computeSYOpts:ce,computeEmptyOpts:N,computeKeyboardOpts:Y,computeTooltipOpts:he,computeRadioOpts:e,computeExpandOpts:A,computeTreeOpts:d,computeCheckboxOpts:de,computeValidOpts:ge,computeRowOpts:pe,computeColumnOpts:xe}=ae.getComputeMaps(),C=(0,_vue.ref)(),O=(0,_vue.ref)(),L=(0,_vue.ref)(),R=(0,_vue.ref)(),H=(0,_vue.ref)(),$=(0,_vue.ref)(),E=(0,_vue.ref)(),p=()=>{if(l){var e=l.value;if(e)return lineOffsetSizes[e]||0}return 0},ve=()=>{var e=se["delayHover"],{lastScrollTime:l,_isResize:t}=ie;return!!(t||l&&Date.now()<l+e)},v=(e,l)=>{let t=1;if(e){var o=d.value,r=e[o.children||o.childrenField];if(r&&ae.isTreeExpandByRow(e))for(let e=0;e<r.length;e++)t+=v(r[e],l)}return t},me=e=>{var{row:l,column:t}=e,o=ne["afterFullData"],r=se["treeConfig"],a=d.value,{slots:t,treeNode:s}=t,i=ne["fullAllDataRowIdData"],i=i[(0,_util.getRowid)(ae,l)];let n=0,u=0,c=[];return i&&(n=i.level,u=i._index,c=i.items),t&&t.line?ae.callSlot(t.line,e):(i=ae.eqRow(o[0],l),r&&s&&(a.showLine||a.line)?[(0,_vue.h)("div",{class:"vxe-tree--line-wrapper"},[(0,_vue.h)("div",{class:"vxe-tree--line",style:{height:`${i?1:((e,l,t)=>{let o=1;return t&&(o=v(l[t-1],e)),ie.rowHeight*o-(t?1:12-p())})(e,c,u)}px`,left:n*a.indent+(n?2-p():0)+16+"px"}})])]:[])},P=(e,l,t,o,r,a,s,i,n,u,U,q)=>{var{columnKey:j,height:c,showOverflow:d,cellClassName:B,cellStyle:p,align:v,spanMethod:h,mouseConfig:N,editConfig:Y,editRules:g,tooltipConfig:W}=se,{tableData:F,overflowX:x,scrollYLoad:V,currentColumn:A,mergeList:m,editStore:f,isAllOverflow:P,validErrorMaps:w}=ie,X=ne["afterFullData"],y=ge.value,K=de.value,_=ue.value,b=he.value,T=pe.value,S=ce.value,z=xe.value,{type:G,cellRender:J,editRender:C,align:O,showOverflow:L,className:Q,treeNode:Z,slots:ee}=n,f=f["actived"],S=S["rHeight"],T=T["height"],R=C||J,R=R?renderer.get(R.name):null,le=R?R.tableCellClassName||R.cellClassName:null,R=R?R.tableCellStyle||R.cellStyle:"";const H=b.showAll;var b=ae.getColumnIndex(n),te=ae.getVTColumnIndex(n),oe=(0,_utils.isEnableConf)(C);let $=t?n.fixed!==t:n.fixed&&x;x=_xeUtils.default.isUndefined(L)||_xeUtils.default.isNull(L)?d:L;let E="ellipsis"===x;const M="title"===x,I=!0===x||"tooltip"===x;let D=M||I||E,re;L={},x=O||v,O=w[l+":"+n.id],v=g&&y.showMessage&&("default"===y.message?c||1<F.length:"inline"===y.message),w={colid:n.id};const k={$table:ae,$grid:ae.xegrid,seq:e,rowid:l,row:r,rowIndex:a,$rowIndex:s,_rowIndex:i,column:n,columnIndex:b,$columnIndex:u,_columnIndex:te,fixed:t,type:renderType,isHidden:$,level:o,visibleData:X,data:F,items:q};if(V&&!D&&(E=D=!0),(M||I||H||W)&&(L.onMouseenter=e=>{ve()||(M?(0,_dom.updateCellTitle)(e.currentTarget,n):(I||H)&&ae.triggerBodyTooltipEvent(e,k),ae.dispatchEvent("cell-mouseenter",Object.assign({cell:e.currentTarget},k),e))}),(I||H||W)&&(L.onMouseleave=e=>{ve()||((I||H)&&ae.handleTargetLeaveEvent(e),ae.dispatchEvent("cell-mouseleave",Object.assign({cell:e.currentTarget},k),e))}),(K.range||N)&&(L.onMousedown=e=>{ae.triggerCellMousedownEvent(e,k)}),L.onClick=e=>{ae.triggerCellClickEvent(e,k)},L.onDblclick=e=>{ae.triggerCellDblclickEvent(e,k)},m.length){g=(0,_util.mergeBodyMethod)(m,i,te);if(g){var{rowspan:c,colspan:e}=g;if(!c||!e)return null;1<c&&(w.rowspan=c),1<e&&(w.colspan=e)}}else if(h){var{rowspan:l=1,colspan:a=1}=h(k)||{};if(!l||!a)return null;1<l&&(w.rowspan=l),1<a&&(w.colspan=a)}!($=$&&m&&(1<w.colspan||1<w.rowspan)?!1:$)&&Y&&(C||J)&&(_.showStatus||_.showUpdateStatus)&&(re=ae.isUpdateByRow(r,n.field));s=[];return $&&d&&P?s.push((0,_vue.h)("div",{class:["vxe-cell",{"c--title":M,"c--tooltip":I,"c--ellipsis":E}],style:{maxHeight:D&&(S||T)?`${S||T}px`:""}})):(s.push(...me(k),(0,_vue.h)("div",{class:["vxe-cell",{"c--title":M,"c--tooltip":I,"c--ellipsis":E}],style:{maxHeight:D&&(S||T)?`${S||T}px`:""},title:M?ae.getCellLabel(r,n):null},n.renderCell(k))),v&&O&&(b=O.rule,t=ee?ee.valid:null,o=Object.assign(Object.assign({},k),O),s.push((0,_vue.h)("div",{class:["vxe-cell--valid-error-hint",(0,_dom.getPropClass)(y.className,o)],style:b&&b.maxWidth?{width:b.maxWidth+"px"}:null},t?ae.callSlot(t,o):[(0,_vue.h)("span",{class:"vxe-cell--valid-error-msg"},O.content)])))),(0,_vue.h)("td",Object.assign(Object.assign(Object.assign({class:["vxe-body--column",n.id,{["col--"+x]:x,["col--"+G]:G,"col--last":u===U.length-1,"col--tree-node":Z,"col--edit":oe,"col--ellipsis":D,"fixed--hidden":$,"col--dirty":re,"col--active":Y&&oe&&f.row===r&&(f.column===n||"row"===_.mode),"col--valid-error":!!O,"col--current":A===n},(0,_dom.getPropClass)(le,k),(0,_dom.getPropClass)(Q,k),(0,_dom.getPropClass)(B,k)],key:j||z.useKey?n.id:u},w),{style:Object.assign({height:D&&(S||T)?`${S||T}px`:""},_xeUtils.default.isFunction(R)?R(k):R,_xeUtils.default.isFunction(p)?p(k):p)}),L),s)},V=(x,m,f)=>{const{stripe:w,rowKey:y,highlightHoverRow:_,rowClassName:b,rowStyle:T,showOverflow:S,editConfig:C,treeConfig:O}=se,{hasFixedColumn:L,treeExpandedMaps:R,scrollYLoad:H,rowExpandedMaps:$,expandColumn:E,selectRadioRow:M,pendingRowMaps:I,pendingRowList:D}=ie,k=ne["fullAllDataRowIdData"],U=de.value,q=e.value,j=d.value,B=ue.value,N=pe.value,Y=j["transform"],W=j.children||j.childrenField,F=[];return m.forEach((t,o)=>{var e={};let r;r=ae.getRowIndex(t),(N.isHover||_)&&(e.onMouseenter=e=>{ve()||ae.triggerHoverEvent(e,{row:t,rowIndex:r})},e.onMouseleave=()=>{ve()||ae.clearHoverRow()});const a=(0,_util.getRowid)(ae,t);var l=k[a];let s=0,i=-1,n=0;l&&(s=l.level,i=l.seq,n=l._index);var u,c,d,l={$table:ae,seq:i,rowid:a,fixed:x,type:renderType,level:s,row:t,rowIndex:r,$rowIndex:o,_rowIndex:n},p=E&&!!$[a];let v=!1,h=[],g=!1;C&&(g=ae.isInsertByRow(t)),!O||H||Y||(h=t[W],v=h&&0<h.length&&!!R[a]),F.push((0,_vue.h)("tr",Object.assign({class:["vxe-body--row",O?"row--level-"+s:"",{"row--stripe":w&&(ae.getVTRowIndex(t)+1)%2==0,"is--new":g,"is--expand-row":p,"is--expand-tree":v,"row--new":g&&(B.showStatus||B.showInsertStatus),"row--radio":q.highlight&&ae.eqRow(M,t),"row--checked":U.highlight&&ae.isCheckedByCheckboxRow(t),"row--pending":D.length&&!!I[a]},(0,_dom.getPropClass)(b,l)],rowid:a,style:T?_xeUtils.default.isFunction(T)?T(l):T:null,key:y||N.useKey||O?a:o},e),f.map((e,l)=>P(i,a,x,s,t,r,o,n,e,l,f,m)))),p&&({height:l,padding:p}=A.value,u={},c=(l&&(u.height=l+"px"),O&&(u.paddingLeft=s*j.indent+30+"px"),E)["showOverflow"],c=_xeUtils.default.isUndefined(c)||_xeUtils.default.isNull(c)?S:c,d={$table:ae,seq:i,column:E,fixed:x,type:renderType,level:s,row:t,rowIndex:r,$rowIndex:o,_rowIndex:n},F.push((0,_vue.h)("tr",Object.assign({class:["vxe-body--expanded-row",{"is--padding":p}],key:"expand_"+a,style:T?_xeUtils.default.isFunction(T)?T(d):T:null},e),[(0,_vue.h)("td",{class:{"vxe-body--expanded-column":1,"fixed--hidden":x&&!L,"col--ellipsis":c},colspan:f.length},[(0,_vue.h)("div",{class:{"vxe-body--expanded-cell":1,"is--ellipsis":l},style:u},[E.renderData(d)])])]))),v&&F.push(...V(x,h,f))}),F};let r;const M=(e,l,t,o)=>{(t||o)&&(t&&((0,_util.removeScrollListener)(t),t.scrollTop=l),o&&((0,_util.removeScrollListener)(o),o.scrollTop=l),clearTimeout(r),r=setTimeout(()=>{(0,_util.restoreScrollListener)(t),(0,_util.restoreScrollListener)(o),ie.lastScrollTime=Date.now()},300))},o=e=>{var l=f["fixedType"],t=se["highlightHoverRow"],{scrollXLoad:o,scrollYLoad:r}=ie,{elemStore:a,lastScrollTop:s,lastScrollLeft:i}=ne,n=pe.value,u=_.value,c=b.value,d=q.value,p=T.value,v=S.value,h=j.value,g=C.value,u=u?u.$el:null,d=d?d.$el:null,c=c.$el,p=p?p.$el:null,v=v?v.$el:null,x=a["main-body-ySpace"],x=x?x.value:null,a=a["main-body-xSpace"],a=a?a.value:null,x=(r&&x?x:c).clientHeight,a=(o&&a?a:c).clientWidth;let m=g.scrollTop;g=c.scrollLeft,i=g!==i,s=m!==s;ne.lastScrollTop=m,ne.lastScrollLeft=g,ie.lastScrollTime=Date.now(),(n.isHover||t)&&ae.clearHoverRow(),p&&"left"===l?(m=p.scrollTop,M(0,m,c,v)):v&&"right"===l?(m=v.scrollTop,M(0,m,c,p)):(i&&(u&&(u.scrollLeft=c.scrollLeft),d)&&(d.scrollLeft=c.scrollLeft),(p||v)&&(ae.checkScrolling(),s)&&M(0,m,p,v)),o&&i&&ae.triggerScrollXEvent(e),r&&s&&ae.triggerScrollYEvent(e),i&&h&&h.reactData.visible&&h.updatePlacement(),ae.dispatchEvent("scroll",{type:renderType,fixed:l,scrollTop:m,scrollLeft:g,scrollHeight:c.scrollHeight,scrollWidth:c.scrollWidth,bodyHeight:x,bodyWidth:a,isX:i,isY:s},e)};let m,I=0,D=0,k=0,U=!1;const h=(r,a,e,s,i)=>{var l=ne["elemStore"],{scrollXLoad:t,scrollYLoad:o}=ie,n=b.value,u=T.value,c=S.value;const d=u?u.$el:null,p=c?c.$el:null,v=n.$el;u=l["main-body-ySpace"],c=u?u.value:null,n=l["main-body-xSpace"],u=n?n.value:null;const h=(o&&c?c:v).clientHeight,g=(t&&u?u:v).clientWidth;l=U===a?Math.max(0,I-k):0;U=a,I=Math.abs(a?e-l:e+l),D=0,k=0,clearTimeout(m);const x=()=>{var e,l,t,o;k<I&&(e=f["fixedType"],{scrollTop:o,clientHeight:l,scrollHeight:t}=(D=Math.max(5,Math.floor(1.5*D)),(k+=D)>I&&(D-=k-I),v),o=o+D*(a?-1:1),v.scrollTop=o,d&&(d.scrollTop=o),p&&(p.scrollTop=o),(a?o<t-l:0<=o)&&(m=setTimeout(x,10)),ae.dispatchEvent("scroll",{type:renderType,fixed:e,scrollTop:v.scrollTop,scrollLeft:v.scrollLeft,scrollHeight:v.scrollHeight,scrollWidth:v.scrollWidth,bodyHeight:h,bodyWidth:g,isX:s,isY:i},r))};x()},W=e=>{var{deltaY:l,deltaX:t}=e,o=se["highlightHoverRow"],r=ie["scrollYLoad"],{lastScrollTop:a,lastScrollLeft:s}=ne,i=pe.value,n=b.value,u=C.value,n=n.$el,c=l<0;(c?u.scrollTop<=0:u.scrollTop>=u.scrollHeight-u.clientHeight)||(u=u.scrollTop+l,t=(n=n.scrollLeft+t)!==s,(s=u!==a)&&(e.preventDefault(),ne.lastScrollTop=u,ne.lastScrollLeft=n,ie.lastScrollTime=Date.now(),(i.isHover||o)&&ae.clearHoverRow(),h(e,c,l,t,s),r)&&ae.triggerScrollYEvent(e))};(0,_vue.onMounted)(()=>{(0,_vue.nextTick)(()=>{var e=f["fixedType"],l=ne["elemStore"],e=`${e||"main"}-body-`,t=C.value;l[e+"wrapper"]=C,l[e+"table"]=O,l[e+"colgroup"]=L,l[e+"list"]=R,l[e+"xSpace"]=H,l[e+"ySpace"]=$,l[e+"emptyBlock"]=E,t&&(t.onscroll=o,t._onscroll=o)})}),(0,_vue.onBeforeUnmount)(()=>{var e=C.value;clearTimeout(m),e&&(e._onscroll=null,e.onscroll=null)}),(0,_vue.onUnmounted)(()=>{var e=f["fixedType"],l=ne["elemStore"],e=`${e||"main"}-body-`;l[e+"wrapper"]=null,l[e+"table"]=null,l[e+"colgroup"]=null,l[e+"list"]=null,l[e+"xSpace"]=null,l[e+"ySpace"]=null,l[e+"emptyBlock"]=null});return()=>{let{fixedColumn:e,fixedType:l,tableColumn:t}=f;var{keyboardConfig:o,showOverflow:r,spanMethod:a,mouseConfig:s}=se,{tableData:i,mergeList:n,scrollYLoad:u,isAllOverflow:c}=ie,d=ne["visibleColumn"],p=y["slots"],v=ce.value,h=N.value,g=Y.value,x=B.value;l&&(t=ie.expandColumn||!(u||r&&c)||n.length||a||o&&g.isMerge?d:e);let m;u=p?p.empty:null;return m=u?ae.callSlot(u,{$table:ae,$grid:ae.xegrid}):(c=(r=h.name?renderer.get(h.name):null)?r.renderTableEmpty||r.renderTableEmptyView||r.renderEmpty:null)?(0,_vn.getSlotVNs)(c(h,{$table:ae})):se.emptyText||getI18n("vxe.table.emptyText"),(0,_vue.h)("div",Object.assign({ref:C,class:["vxe-table--body-wrapper",l?`fixed-${l}--wrapper`:"body--wrapper"],xid:w},"wheel"===v.mode?{onWheel:W}:{}),[l?(0,_vue.createCommentVNode)():(0,_vue.h)("div",{ref:H,class:"vxe-body--x-space"}),(0,_vue.h)("div",{ref:$,class:"vxe-body--y-space"}),(0,_vue.h)("table",{ref:O,class:"vxe-table--body",xid:w,cellspacing:0,cellpadding:0,border:0},[(0,_vue.h)("colgroup",{ref:L},t.map((e,l)=>(0,_vue.h)("col",{name:e.id,key:l}))),(0,_vue.h)("tbody",{ref:R},V(l,i,t))]),(0,_vue.h)("div",{class:"vxe-table--checkbox-range"}),s&&x.area?(0,_vue.h)("div",{class:"vxe-table--cell-area"},[(0,_vue.h)("span",{class:"vxe-table--cell-main-area"},x.extension?[(0,_vue.h)("span",{class:"vxe-table--cell-main-area-btn",onMousedown(e){ae.triggerCellExtendMousedownEvent(e,{$table:ae,fixed:l,type:renderType})}})]:[]),(0,_vue.h)("span",{class:"vxe-table--cell-copy-area"}),(0,_vue.h)("span",{class:"vxe-table--cell-extend-area"}),(0,_vue.h)("span",{class:"vxe-table--cell-multi-area"}),(0,_vue.h)("span",{class:"vxe-table--cell-active-area"})]):null,l?null:(0,_vue.h)("div",{class:"vxe-table--empty-block",ref:E},[(0,_vue.h)("div",{class:"vxe-table--empty-content"},m)])])}}});