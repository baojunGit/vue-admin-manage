"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_ui=require("../../../ui"),_utils=require("../../../ui/src/utils"),_dom=require("../../../ui/src/dom"),_log=require("../../../ui/src/log"),_xeUtils=_interopRequireDefault(require("xe-utils"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const{getI18n,getIcon}=_ui.VxeUI;var _default=exports.default=(0,_vue.defineComponent)({name:"TableCustomPanel",props:{customStore:{type:Object,default:()=>({})}},setup(B){const L=_ui.VxeUI.getComponent("VxeModal"),y=_ui.VxeUI.getComponent("VxeDrawer"),A=_ui.VxeUI.getComponent("VxeButton"),F=_ui.VxeUI.getComponent("VxeInput"),M=_ui.VxeUI.getComponent("VxeTooltip"),H=_ui.VxeUI.getComponent("VxeRadioGroup"),d=(0,_vue.inject)("$xeTable",{}),R=d["reactData"],{computeCustomOpts:D,computeColumnOpts:U,computeIsMaxFixedColumn:S}=d.getComputeMaps(),K=(0,_vue.ref)(),z=(0,_vue.ref)(),W=(0,_vue.ref)(),X=(0,_vue.ref)();let r;const q=e=>{var t=B["customStore"];t.activeWrapper=!0,d.customOpenEvent(e)},j=e=>{const t=B["customStore"];t.activeWrapper=!1,setTimeout(()=>{t.activeBtn||t.activeWrapper||d.customCloseEvent(e)},300)},G=({$event:e})=>{var t=R["customColumnList"];const{allowVisible:s,allowSort:a,allowFixed:n,allowResizable:r}=D.value;_xeUtils.default.eachTree(t,(e,t,o,l,i)=>{i||(a&&(e.renderSortNumber=t+1),n&&(e.fixed=e.renderFixed)),r&&e.renderVisible&&(!e.children||e.children.length)&&e.renderResizeWidth!==e.renderWidth&&(e.resizeWidth=e.renderResizeWidth,e.renderWidth=e.renderResizeWidth),s&&(e.visible=e.renderVisible)}),d.closeCustom(),d.emitCustomEvent("confirm",e),d.saveCustomStore("confirm")},$=({$event:e})=>{var t=B["customStore"],o=R["customColumnList"];const{oldSortMaps:i,oldFixedMaps:s,oldVisibleMaps:a}=t,{allowVisible:n,allowSort:r,allowFixed:c,allowResizable:u}=D.value;_xeUtils.default.eachTree(o,e=>{var t=e.getKey(),o=!!a[t],l=s[t]||"";n&&(e.renderVisible=o,e.visible=o),c&&(e.renderFixed=l,e.fixed=l),r&&(e.renderSortNumber=i[t]||0),u&&(e.renderResizeWidth=e.renderWidth)},{children:"children"}),d.closeCustom(),d.emitCustomEvent("cancel",e)},o=e=>{d.resetColumn(!0),d.closeCustom(),d.emitCustomEvent("reset",e)},P=({$event:t})=>{_ui.VxeUI.modal?_ui.VxeUI.modal.confirm({content:getI18n("vxe.custom.cstmConfirmRestore"),className:"vxe-table--ignore-clear",escClosable:!0}).then(e=>{"confirm"===e&&o(t)}):o(t)},l=t=>{var e=R["customColumnList"],e=_xeUtils.default.findTree(e,e=>e===t);e&&e.parent&&(e=e["parent"],e.children)&&e.children.length&&(e.renderVisible=e.children.every(e=>e.renderVisible),e.halfVisible=!e.renderVisible&&e.children.some(e=>e.renderVisible||e.halfVisible),l(e))},Y=e=>{const t=!e.renderVisible;var o=D.value;_xeUtils.default.eachTree([e],e=>{e.renderVisible=t,e.halfVisible=!1}),l(e),o.immediate&&(d.handleCustom(),d.saveCustomStore("update:visible")),d.checkCustomStatus()},Z=(e,t)=>{var o=S.value;e.renderFixed===t?e.renderFixed="":o&&!e.renderFixed||(e.renderFixed=t)},J=()=>{var e=B["customStore"],t=R["customColumnList"];const o=D.value["checkMethod"],l=!e.isAll;_xeUtils.default.eachTree(t,e=>{o&&!o({column:e})||(e.renderVisible=l,e.halfVisible=!1)}),e.isAll=l,d.checkCustomStatus()},Q=e=>{var e=e.currentTarget.parentNode.parentNode,t=e.getAttribute("colid"),t=d.getColumnById(t);e.draggable=!0,X.value=t,(0,_dom.addClass)(e,"active--drag-origin")},ee=e=>{var e=e.currentTarget.parentNode.parentNode,t=W.value;e.draggable=!1,(X.value=null,_dom.removeClass)(e,"active--drag-origin"),t&&(t.style.display="")},te=e=>{var t=new Image;e.dataTransfer&&e.dataTransfer.setDragImage(t,0,0)},oe=e=>{var t=R["customColumnList"],e=e.currentTarget,o=W.value;if(r){if(r!==e){var l=r.getAttribute("drag-pos"),i=e.getAttribute("colid");const a=d.getColumnById(i);if(!a)return;var i=_xeUtils.default.findIndexOf(t,e=>e.id===a.id),s=r.getAttribute("colid");const n=d.getColumnById(s);if(!n)return;t.splice(i,1);s=_xeUtils.default.findIndexOf(t,e=>e.id===n.id);t.splice(s+("bottom"===l?1:0),0,a)}r.draggable=!1,r.removeAttribute("drag-pos"),(0,_dom.removeClass)(r,"active--drag-target")}X.value=null,e.draggable=!1,e.removeAttribute("drag-pos"),o&&(o.style.display=""),(0,_dom.removeClass)(e,"active--drag-target"),(0,_dom.removeClass)(e,"active--drag-origin")},le=e=>{var t=e.currentTarget,o=(r!==t&&(0,_dom.removeClass)(r,"active--drag-target"),t.getAttribute("colid")),o=d.getColumnById(o);o&&1===o.level&&(e.preventDefault(),o=e.clientY-t.getBoundingClientRect().y<t.clientHeight/2?"top":"bottom",(0,_dom.addClass)(t,"active--drag-target"),t.setAttribute("drag-pos",o),r=t);{o=e;var l=W.value,i=z.value;i&&l&&(e=(t=i.parentNode).getBoundingClientRect(),l.style.display="block",l.style.top=Math.min(t.clientHeight-t.scrollTop-l.clientHeight,o.clientY-e.y)+"px",l.style.left=Math.min(t.clientWidth-t.scrollLeft-l.clientWidth-16,o.clientX-e.x)+"px")}};return"development"===process.env.NODE_ENV&&(0,_vue.nextTick)(()=>{L||(0,_log.errLog)("vxe.error.reqComp",["vxe-modal"]),A||(0,_log.errLog)("vxe.error.reqComp",["vxe-button"]),F||(0,_log.errLog)("vxe.error.reqComp",["vxe-input"]),M||(0,_log.errLog)("vxe.error.reqComp",["vxe-tooltip"]),H||(0,_log.errLog)("vxe.error.reqComp",["vxe-radio-group"])}),()=>{var e=D.value;if(["modal","drawer","popup"].includes(""+e.mode)){const a=B["customStore"];e=R["customColumnList"];const n=D.value,{modalOptions:r,drawerOptions:c,allowVisible:u,allowSort:d,allowFixed:v,allowResizable:m,checkMethod:h,visibleMethod:x}=n,p=U.value["maxFixedSize"];var t=n["mode"],o=Object.assign({},r),l=Object.assign({},c);const _=S.value,g=[],b=(_xeUtils.default.eachTree(e,(t,e,o,l,i)=>{if(!x||x({column:t})){var s=t.renderVisible,a=t.halfVisible,n=(0,_utils.formatText)(t.getTitle(),1),r=t.children&&t.children.length;const c=!!h&&!h({column:t});g.push((0,_vue.h)("tr",{key:t.id,colid:t.id,class:["vxe-table-custom-popup--row level--"+t.level,{"is--group":r}],onDragstart:te,onDragend:oe,onDragover:le},[u?(0,_vue.h)("td",{class:"vxe-table-custom-popup--column-item col--visible"},[(0,_vue.h)("div",{class:["vxe-table-custom--checkbox-option",{"is--checked":s,"is--indeterminate":a,"is--disabled":c}],title:getI18n("vxe.custom.setting.colVisible"),onClick:()=>{c||Y(t)}},[(0,_vue.h)("span",{class:["vxe-checkbox--icon",a?getIcon().TABLE_CHECKBOX_INDETERMINATE:s?getIcon().TABLE_CHECKBOX_CHECKED:getIcon().TABLE_CHECKBOX_UNCHECKED]})])]):(0,_vue.createCommentVNode)(),d?(0,_vue.h)("td",{class:"vxe-table-custom-popup--column-item col--sort"},[1===t.level?(0,_vue.h)("span",{class:"vxe-table-custom-popup--column-sort-btn",title:getI18n("vxe.custom.setting.sortHelpTip"),onMousedown:Q,onMouseup:ee},[(0,_vue.h)("i",{class:getIcon().TABLE_CUSTOM_SORT})]):(0,_vue.h)("span","-")]):(0,_vue.createCommentVNode)(),(0,_vue.h)("td",{class:"vxe-table-custom-popup--column-item col--name"},[(0,_vue.h)("div",{class:"vxe-table-custom-popup--name",title:n},n)]),m?(0,_vue.h)("td",{class:"vxe-table-custom-popup--column-item col--resizable"},[!s||t.children&&t.children.length?(0,_vue.h)("span","-"):F?(0,_vue.h)(F,{type:"integer",modelValue:t.renderResizeWidth,"onUpdate:modelValue"(e){t.renderResizeWidth=Math.max(0,Number(e))}}):(0,_vue.createCommentVNode)()]):(0,_vue.createCommentVNode)(),v?(0,_vue.h)("td",{class:"vxe-table-custom-popup--column-item col--fixed"},[i?(0,_vue.h)("span","-"):H?(0,_vue.h)(H,{modelValue:t.renderFixed||"",type:"button",size:"mini",options:[{label:getI18n("vxe.custom.setting.fixedLeft"),value:"left",disabled:_},{label:getI18n("vxe.custom.setting.fixedUnset"),value:""},{label:getI18n("vxe.custom.setting.fixedRight"),value:"right",disabled:_}],"onUpdate:modelValue"(e){t.renderFixed=e}}):(0,_vue.createCommentVNode)()]):(0,_vue.createCommentVNode)()]))}}),a.isAll),C=a.isIndeterminate;e={default:()=>(0,_vue.h)("div",{ref:z,class:"vxe-table-custom-popup--body"},[(0,_vue.h)("div",{class:"vxe-table-custom-popup--table-wrapper"},[(0,_vue.h)("table",{},[(0,_vue.h)("colgroup",{},[u?(0,_vue.h)("col",{style:{width:"80px"}}):(0,_vue.createCommentVNode)(),d?(0,_vue.h)("col",{style:{width:"80px"}}):(0,_vue.createCommentVNode)(),(0,_vue.h)("col",{style:{minWidth:"120px"}}),m?(0,_vue.h)("col",{style:{width:"140px"}}):(0,_vue.createCommentVNode)(),v?(0,_vue.h)("col",{style:{width:"200px"}}):(0,_vue.createCommentVNode)()]),(0,_vue.h)("thead",{},[(0,_vue.h)("tr",{},[u?(0,_vue.h)("th",{},[(0,_vue.h)("div",{class:["vxe-table-custom--checkbox-option",{"is--checked":b,"is--indeterminate":C}],title:getI18n("vxe.table.allTitle"),onClick:J},[(0,_vue.h)("span",{class:["vxe-checkbox--icon",C?getIcon().TABLE_CHECKBOX_INDETERMINATE:b?getIcon().TABLE_CHECKBOX_CHECKED:getIcon().TABLE_CHECKBOX_UNCHECKED]}),(0,_vue.h)("span",{class:"vxe-checkbox--label"},getI18n("vxe.toolbar.customAll"))])]):(0,_vue.createCommentVNode)(),d?(0,_vue.h)("th",{},[(0,_vue.h)("span",{class:"vxe-table-custom-popup--table-sort-help-title"},getI18n("vxe.custom.setting.colSort")),M?(0,_vue.h)(M,{enterable:!0,content:getI18n("vxe.custom.setting.sortHelpTip"),popupClassName:"vxe-table--ignore-clear"},{default:()=>(0,_vue.h)("i",{class:"vxe-table-custom-popup--table-sort-help-icon vxe-icon-question-circle-fill"})}):(0,_vue.createCommentVNode)()]):(0,_vue.createCommentVNode)(),(0,_vue.h)("th",{},getI18n("vxe.custom.setting.colTitle")),m?(0,_vue.h)("th",{},getI18n("vxe.custom.setting.colResizable")):(0,_vue.createCommentVNode)(),v?(0,_vue.h)("th",{},getI18n("vxe.custom.setting."+(p?"colFixedMax":"colFixed"),[p])):(0,_vue.createCommentVNode)()])]),(0,_vue.h)(_vue.TransitionGroup,{class:"vxe-table-custom--body",tag:"tbody",name:"vxe-table-custom--list"},{default:()=>g})])]),(0,_vue.h)("div",{ref:W,class:"vxe-table-custom-popup--drag-hint"},getI18n("vxe.custom.cstmDragTarget",[X.value?X.value.getTitle():""]))]),footer:()=>(0,_vue.h)("div",{class:"vxe-table-custom-popup--footer"},[A?(0,_vue.h)(A,{content:n.resetButtonText||getI18n("vxe.custom.cstmRestore"),onClick:P}):(0,_vue.createCommentVNode)(),A?(0,_vue.h)(A,{content:n.resetButtonText||getI18n("vxe.custom.cstmCancel"),onClick:$}):(0,_vue.createCommentVNode)(),A?(0,_vue.h)(A,{status:"primary",content:n.confirmButtonText||getI18n("vxe.custom.cstmConfirm"),onClick:G}):(0,_vue.createCommentVNode)()])};return"drawer"===t?y?(0,_vue.h)(y,{key:"drawer",className:["vxe-table-custom-drawer-wrapper","vxe-table--ignore-clear",l.className||""].join(" "),modelValue:a.visible,title:l.title||getI18n("vxe.custom.cstmTitle"),width:l.width||Math.min(880,document.documentElement.clientWidth),position:l.position,escClosable:!!l.escClosable,destroyOnClose:!0,showFooter:!0,"onUpdate:modelValue"(e){a.visible=e}},e):(0,_vue.createCommentVNode)():L?(0,_vue.h)(L,{key:"modal",className:["vxe-table-custom-modal-wrapper","vxe-table--ignore-clear",o.className||""].join(" "),modelValue:a.visible,title:o.title||getI18n("vxe.custom.cstmTitle"),width:o.width||Math.min(880,document.documentElement.clientWidth),minWidth:o.minWidth||700,height:o.height||Math.min(680,document.documentElement.clientHeight),minHeight:o.minHeight||400,showZoom:o.showZoom,showMaximize:o.showMaximize,showMinimize:o.showMinimize,mask:o.mask,lockView:o.lockView,resize:o.resize,escClosable:!!o.escClosable,destroyOnClose:!0,showFooter:!0,"onUpdate:modelValue"(e){a.visible=e}},e):(0,_vue.createCommentVNode)()}{t=B["customStore"],l=R["customColumnList"],o=D.value,e=t["maxHeight"];const{checkMethod:f,visibleMethod:I,allowVisible:T,allowSort:V,allowFixed:E,trigger:N,placement:w}=o,O=S.value,k=[];var i={},l=("hover"===N&&(i.onMouseenter=q,i.onMouseleave=j),_xeUtils.default.eachTree(l,(e,t,o,l,i)=>{if(!I||I({column:e})){var s=e.renderVisible,a=e.halfVisible,n=e.children&&e.children.length,r=(0,_utils.formatText)(e.getTitle(),1);const c=!!f&&!f({column:e});k.push((0,_vue.h)("li",{key:e.id,colid:e.id,class:["vxe-table-custom--option","level--"+e.level,{"is--group":n}],onDragstart:te,onDragend:oe,onDragover:le},[T?(0,_vue.h)("div",{class:["vxe-table-custom--checkbox-option",{"is--checked":s,"is--indeterminate":a,"is--disabled":c}],title:getI18n("vxe.custom.setting.colVisible"),onClick:()=>{c||Y(e)}},[(0,_vue.h)("span",{class:["vxe-checkbox--icon",a?getIcon().TABLE_CHECKBOX_INDETERMINATE:s?getIcon().TABLE_CHECKBOX_CHECKED:getIcon().TABLE_CHECKBOX_UNCHECKED]})]):(0,_vue.createCommentVNode)(),V&&1===e.level?(0,_vue.h)("div",{class:"vxe-table-custom--sort-option"},[(0,_vue.h)("span",{class:"vxe-table-custom--sort-btn",title:getI18n("vxe.custom.setting.sortHelpTip"),onMousedown:Q,onMouseup:ee},[(0,_vue.h)("i",{class:getIcon().TABLE_CUSTOM_SORT})])]):(0,_vue.createCommentVNode)(),(0,_vue.h)("div",{class:"vxe-table-custom--checkbox-label",title:r},r),!i&&E?(0,_vue.h)("div",{class:"vxe-table-custom--fixed-option"},[(0,_vue.h)("span",{class:["vxe-table-custom--fixed-left-option","left"===e.renderFixed?getIcon().TOOLBAR_TOOLS_FIXED_LEFT_ACTIVE:getIcon().TOOLBAR_TOOLS_FIXED_LEFT,{"is--checked":"left"===e.renderFixed,"is--disabled":O&&!e.renderFixed}],title:getI18n("left"===e.renderFixed?"vxe.toolbar.cancelFixed":"vxe.toolbar.fixedLeft"),onClick:()=>{Z(e,"left")}}),(0,_vue.h)("span",{class:["vxe-table-custom--fixed-right-option","right"===e.renderFixed?getIcon().TOOLBAR_TOOLS_FIXED_RIGHT_ACTIVE:getIcon().TOOLBAR_TOOLS_FIXED_RIGHT,{"is--checked":"right"===e.renderFixed,"is--disabled":O&&!e.renderFixed}],title:getI18n("right"===e.renderFixed?"vxe.toolbar.cancelFixed":"vxe.toolbar.fixedRight"),onClick:()=>{Z(e,"right")}})]):(0,_vue.createCommentVNode)()]))}}),t.isAll),s=t.isIndeterminate;return(0,_vue.h)("div",{ref:K,key:"simple",class:["vxe-table-custom-wrapper","placement--"+w,{"is--active":t.visible}],style:e&&!["left","right"].includes(w)?{maxHeight:e+"px"}:{}},t.visible?[(0,_vue.h)("ul",{class:"vxe-table-custom--header"},[(0,_vue.h)("li",{class:"vxe-table-custom--option"},[T?(0,_vue.h)("div",{class:["vxe-table-custom--checkbox-option",{"is--checked":l,"is--indeterminate":s}],title:getI18n("vxe.table.allTitle"),onClick:J},[(0,_vue.h)("span",{class:["vxe-checkbox--icon",s?getIcon().TABLE_CHECKBOX_INDETERMINATE:l?getIcon().TABLE_CHECKBOX_CHECKED:getIcon().TABLE_CHECKBOX_UNCHECKED]}),(0,_vue.h)("span",{class:"vxe-checkbox--label"},getI18n("vxe.toolbar.customAll"))]):(0,_vue.h)("span",{class:"vxe-checkbox--label"},getI18n("vxe.table.customTitle"))])]),(0,_vue.h)("div",{ref:z,class:"vxe-table-custom--list-wrapper"},[(0,_vue.h)(_vue.TransitionGroup,Object.assign({class:"vxe-table-custom--body",name:"vxe-table-custom--list",tag:"ul"},i),{default:()=>k}),(0,_vue.h)("div",{ref:W,class:"vxe-table-custom-popup--drag-hint"},getI18n("vxe.custom.cstmDragTarget",[X.value?X.value.getTitle():""]))]),o.showFooter?(0,_vue.h)("div",{class:"vxe-table-custom--footer"},[(0,_vue.h)("button",{class:"btn--reset",onClick:P},o.resetButtonText||getI18n("vxe.table.customRestore")),o.immediate?(0,_vue.createCommentVNode)():(0,_vue.h)("button",{class:"btn--cancel",onClick:$},o.resetButtonText||getI18n("vxe.table.customCancel")),(0,_vue.h)("button",{class:"btn--confirm",onClick:G},o.confirmButtonText||getI18n("vxe.table.customConfirm"))]):null]:[]);return}}}});