{"version":3,"file":"anchor2.js","sources":["../../../../../../packages/components/anchor/src/anchor.vue"],"sourcesContent":["<template>\n  <div ref=\"anchorRef\" :class=\"cls\">\n    <div\n      v-if=\"marker\"\n      ref=\"markerRef\"\n      :class=\"ns.e('marker')\"\n      :style=\"markerStyle\"\n    />\n    <div :class=\"ns.e('list')\">\n      <slot />\n    </div>\n  </div>\n</template>\n\n<script lang=\"ts\" setup>\nimport { computed, onMounted, provide, ref, watch } from 'vue'\nimport { useEventListener } from '@vueuse/core'\nimport { useNamespace } from '@element-plus/hooks'\nimport {\n  animateScrollTo,\n  getElement,\n  getOffsetTopDistance,\n  getScrollElement,\n  getScrollTop,\n  isUndefined,\n  isWindow,\n  throttleByRaf,\n} from '@element-plus/utils'\nimport { anchorEmits, anchorProps } from './anchor'\nimport { anchorKey } from './constants'\n\nimport type { AnchorLinkState } from './constants'\n\ndefineOptions({\n  name: 'ElAnchor',\n})\n\nconst props = defineProps(anchorProps)\nconst emit = defineEmits(anchorEmits)\n\nconst currentAnchor = ref('')\nconst anchorRef = ref<HTMLElement | null>(null)\nconst markerRef = ref<HTMLElement | null>(null)\nconst containerEl = ref<HTMLElement | Window>()\n\nconst links: Record<string, HTMLElement> = {}\nlet isScrolling = false\nlet currentScrollTop = 0\n\nconst ns = useNamespace('anchor')\n\nconst cls = computed(() => [\n  ns.b(),\n  props.type === 'underline' ? ns.m('underline') : '',\n  ns.m(props.direction),\n])\n\nconst addLink = (state: AnchorLinkState) => {\n  links[state.href] = state.el\n}\n\nconst removeLink = (href: string) => {\n  delete links[href]\n}\n\nconst setCurrentAnchor = (href: string) => {\n  const activeHref = currentAnchor.value\n  if (activeHref !== href) {\n    currentAnchor.value = href\n    emit('change', href)\n  }\n}\n\nlet clearAnimate: (() => void) | null = null\n\nconst scrollToAnchor = (href: string) => {\n  if (!containerEl.value) return\n  const target = getElement(href)\n  if (!target) return\n  if (clearAnimate) clearAnimate()\n  isScrolling = true\n  const scrollEle = getScrollElement(target, containerEl.value)\n  const distance = getOffsetTopDistance(target, scrollEle)\n  const max = scrollEle.scrollHeight - scrollEle.clientHeight\n  const to = Math.min(distance - props.offset, max)\n  clearAnimate = animateScrollTo(\n    containerEl.value,\n    currentScrollTop,\n    to,\n    props.duration,\n    () => {\n      // make sure it is executed after throttleByRaf's handleScroll\n      setTimeout(() => {\n        isScrolling = false\n      }, 20)\n    }\n  )\n}\n\nconst scrollTo = (href?: string) => {\n  if (href) {\n    setCurrentAnchor(href)\n    scrollToAnchor(href)\n  }\n}\n\nconst handleClick = (e: MouseEvent, href?: string) => {\n  emit('click', e, href)\n  scrollTo(href)\n}\n\nconst handleScroll = throttleByRaf(() => {\n  if (containerEl.value) {\n    currentScrollTop = getScrollTop(containerEl.value)\n  }\n  const currentHref = getCurrentHref()\n  if (isScrolling || isUndefined(currentHref)) return\n  setCurrentAnchor(currentHref)\n})\n\nconst getCurrentHref = () => {\n  if (!containerEl.value) return\n  const scrollTop = getScrollTop(containerEl.value)\n  const anchorTopList: { top: number; href: string }[] = []\n\n  for (const href of Object.keys(links)) {\n    const target = getElement(href)\n    if (!target) continue\n    const scrollEle = getScrollElement(target, containerEl.value)\n    const distance = getOffsetTopDistance(target, scrollEle)\n    anchorTopList.push({\n      top: distance - props.offset - props.bound,\n      href,\n    })\n  }\n  anchorTopList.sort((prev, next) => prev.top - next.top)\n\n  for (let i = 0; i < anchorTopList.length; i++) {\n    const item = anchorTopList[i]\n    const next = anchorTopList[i + 1]\n\n    if (i === 0 && scrollTop === 0) {\n      return ''\n    }\n    if (item.top <= scrollTop && (!next || next.top > scrollTop)) {\n      return item.href\n    }\n  }\n}\n\nconst getContainer = () => {\n  const el = getElement(props.container)\n  if (!el || isWindow(el)) {\n    containerEl.value = window\n  } else {\n    containerEl.value = el\n  }\n}\n\nuseEventListener(containerEl, 'scroll', handleScroll)\n\nconst markerStyle = computed(() => {\n  if (!anchorRef.value || !markerRef.value || !currentAnchor.value) return {}\n  const currentLinkEl = links[currentAnchor.value]\n  if (!currentLinkEl) return {}\n  const anchorRect = anchorRef.value.getBoundingClientRect()\n  const markerRect = markerRef.value.getBoundingClientRect()\n  const linkRect = currentLinkEl.getBoundingClientRect()\n\n  if (props.direction === 'horizontal') {\n    const left = linkRect.left - anchorRect.left\n    return {\n      left: `${left}px`,\n      width: `${linkRect.width}px`,\n      opacity: 1,\n    }\n  } else {\n    const top =\n      linkRect.top - anchorRect.top + (linkRect.height - markerRect.height) / 2\n    return {\n      top: `${top}px`,\n      opacity: 1,\n    }\n  }\n})\n\nonMounted(() => {\n  getContainer()\n  const hash = decodeURIComponent(window.location.hash)\n  const target = getElement(hash)\n  if (target) {\n    scrollTo(hash)\n  } else {\n    handleScroll()\n  }\n})\n\nwatch(\n  () => props.container,\n  () => {\n    getContainer()\n  }\n)\n\nprovide(anchorKey, {\n  ns,\n  direction: props.direction,\n  currentAnchor,\n  addLink,\n  removeLink,\n  handleClick,\n})\n\ndefineExpose({\n  scrollTo,\n})\n</script>\n"],"names":["ref","useNamespace","computed","getElement","getScrollElement","getOffsetTopDistance","animateScrollTo","throttleByRaf","getScrollTop","isUndefined","isWindow","useEventListener","onMounted","watch","provide","anchorKey"],"mappings":"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"}